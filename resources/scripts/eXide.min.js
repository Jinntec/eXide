define("eXide/mode/xquery_highlight_rules",function(b,c){var a=b("ace/lib/oop"),d=b("ace/lib/lang"),f=b("ace/mode/text_highlight_rules").TextHighlightRules,e=function(){var a=d.arrayToMap("return for let where order by declare function variable xquery version option namespace import module switch default map if then else as and or typeswitch case ascending descending empty in".split(" "));this.$rules={start:[{token:"text",regex:"<\\!\\[CDATA\\[",next:"cdata"},{token:"xml_pe",regex:"<\\?.*?\\?>"},
{token:"comment",regex:"<\\!--",next:"comment"},{token:"comment",regex:"\\(:",next:"comment"},{token:"text",regex:"<\\/?",next:"tag"},{token:"constant",regex:"[+-]?\\d+(?:(?:\\.\\d*)?(?:[eE][+-]?\\d+)?)?\\b"},{token:"variable",regex:"\\$[a-zA-Z_][a-zA-Z0-9_\\-:]*\\b"},{token:"string",regex:'".*?"'},{token:"string",regex:"'.*?'"},{token:"text",regex:"\\s+"},{token:"comment",regex:"\\%\\w[\\w+_\\-:]+\\b"},{token:"support.function",regex:"\\w[\\w+_\\-:]+(?=\\()"},{token:"keyword.operator",regex:"\\*|=|<|>|\\-|\\+|and|or|eq|ne|lt|gt"},
{token:"lparen",regex:"[[({]"},{token:"rparen",regex:"[\\])}]"},{token:function(c){return a[c]?"keyword":"identifier"},regex:"[a-zA-Z_$][a-zA-Z0-9_$]*\\b"}],tag:[{token:"text",regex:">",next:"start"},{token:"keyword",regex:"[-_a-zA-Z0-9:]+"},{token:"text",regex:"\\s+"},{token:"string",regex:'".*?"'},{token:"string",regex:"'.*?'"}],cdata:[{token:"text",regex:"\\]\\]>",next:"start"},{token:"text",regex:"\\s+"},{token:"text",regex:"(?:[^\\]]|\\](?!\\]>))+"}],comment:[{token:"comment",regex:".*?--\>",
next:"start"},{token:"comment",regex:".*:\\)",next:"start"},{token:"comment",regex:".+"}]}};a.inherits(e,f);c.XQueryHighlightRules=e});
define("eXide/mode/behaviour/xquery",function(b,c){var a=b("ace/lib/oop"),d=b("ace/mode/behaviour").Behaviour,f=b("ace/mode/behaviour/cstyle").CstyleBehaviour,e=function(a){this.inherit(f,["braces","parens","string_dquotes"]);this.parent=a;this.add("brackets","insertion",function(a,c,b,e,d){return"\n"==d&&(c=b.getCursorPosition(),"</"==e.doc.getLine(c.row).substring(c.column,c.column+2))?(a=this.$getIndent(e.doc.getLine(c.row))+e.getTabString(),e=this.$getIndent(e.doc.getLine(c.row)),{text:"\n"+a+
"\n"+e,selection:[1,a.length,1,a.length]}):!1});this.add("comments","insertion",function(a,c,b,e,d){a=b.getCursorPosition();e=e.doc.getLine(a.row);if("\n"==d&&e.match(/^[\(\s]:/))return{text:"\n : ",selection:[1,3,1,3]};if(":"==d&&"("==e.substring(a.column-1,1))return{text:":  :",selection:[2,2]}});this.add("slash","insertion",function(c,b,e,d,f){"/"==f&&(c=e.getCursorPosition(),b=d.doc.getLine(c.row),0<c.column&&"<"==b.charAt(c.column-1)&&(b=b.substring(0,c.column)+"/"+b.substring(c.column+1,b.length),
e=d.doc.getAllLines(),e[c.row]=b,a.exec("closeTag",e.join(d.doc.getNewLineCharacter()),c.row)));return!1})};a.inherits(e,d);c.XQueryBehaviour=e});
define("eXide/mode/xquery",function(b,c){var a=b("ace/lib/oop"),d=b("ace/mode/text").Mode,f=b("lib/XQueryLexer").XQueryLexer;b("ace/tokenizer");var e=b("eXide/mode/behaviour/xquery").XQueryBehaviour,g=b("ace/mode/folding/cstyle").FoldMode,h=b("ace/range").Range,i=function(a){this.$tokenizer=new f;this.$behaviour=new e(a);this.foldingRules=new g};a.inherits(i,d);(function(){this.getNextLineIndent=function(a,c,b){a=this.$getIndent(c);c.match(/\s*(?:then|else|return|[{\(]|<\w+>)\s*$/)&&(a+=b);return a};
this.checkOutdent=function(a,c,b){return!/^\s+$/.test(c)?!1:/^\s*[\}\)]/.test(b)};this.autoOutdent=function(a,c,b){a=c.getLine(b).match(/^(\s*[\}\)])/);if(!a)return 0;var a=a[1].length,e=c.findMatchingBracket({row:b,column:a});if(!e||e.row==b)return 0;e=this.$getIndent(c.getLine(e.row));c.replace(new h(b,0,b,a-1),e)};this.$getIndent=function(a){return(a=a.match(/^(\s+)/))?a[1]:""};this.toggleCommentLines=function(a,c,b,e){for(var d=!0,f=/^\s*\(:(.*):\)/,a=b;a<=e;a++)if(!f.test(c.getLine(a))){d=!1;
break}for(var g=new h(0,0,0,0),a=b;a<=e;a++)b=c.getLine(a),g.start.row=a,g.end.row=a,g.end.column=b.length,c.replace(g,d?b.match(f)[1]:"(:"+b+":)")}}).call(i.prototype);c.Mode=i});
define("eXide/mode/behaviour/xml",function(b,c){function a(a,c){var b=!0,e=a.type.split(".");c.split(".").forEach(function(a){if(-1==e.indexOf(a))return b=!1});return b}var d=b("ace/lib/oop"),f=b("ace/mode/behaviour").Behaviour,e=b("ace/mode/behaviour/cstyle").CstyleBehaviour,g=b("ace/token_iterator").TokenIterator,h=function(c){this.inherit(e,["braces","parens","string_dquotes"]);this.parent=c;this.add("brackets","insertion",function(a,c,b,e,d){return"\n"==d&&(c=b.getCursorPosition(),"</"==e.doc.getLine(c.row).substring(c.column,
c.column+2))?(a=this.$getIndent(e.doc.getLine(c.row))+e.getTabString(),e=this.$getIndent(e.doc.getLine(c.row)),{text:"\n"+a+"\n"+e,selection:[1,a.length,1,a.length]}):!1});this.add("slash","insertion",function(a,b,e,d,f){"/"==f&&(a=e.getCursorPosition(),b=d.doc.getLine(a.row),0<a.column&&"<"==b.charAt(a.column-1)&&(b=b.substring(0,a.column)+"/"+b.substring(a.column),e=d.doc.getAllLines(),e[a.row]=b,c.exec("closeTag",e.join(d.doc.getNewLineCharacter()),a.row)));return!1});this.add("autoclosing","insertion",
function(c,b,e,d,f){if(">"==f){c=e.getCursorPosition();e=new g(d,c.row,c.column);d=e.getCurrentToken();b=!1;if(!d||!a(d,"meta.tag")&&(!a(d,"text")||!d.value.match("/"))){do d=e.stepBackward();while(d&&(a(d,"string")||a(d,"keyword.operator")||a(d,"entity.attribute-name")||a(d,"text")))}else b=!0;if(d&&a(d,"meta.tag-name")&&!e.stepBackward().value.match("/"))return e=d.value,b&&(e=e.substring(0,c.column-d.start)),{text:"></"+e+">",selection:[1,1]}}})};d.inherits(h,f);c.XMLBehaviour=h});
define("eXide/mode/xml",function(b,c){var a=b("ace/lib/oop"),d=b("ace/mode/xml").Mode,f=b("ace/tokenizer").Tokenizer,e=b("ace/mode/xml_highlight_rules").XmlHighlightRules,g=b("ace/mode/folding/xml").FoldMode,h=b("eXide/mode/behaviour/xml").XMLBehaviour,i=b("ace/range").Range,j=function(a){this.$tokenizer=new f((new e).getRules());this.$behaviour=new h(a);this.foldingRules=new g};a.inherits(j,d);(function(){this.toggleCommentLines=function(a,c,b,e){for(var d=!0,f=/^\s*<\!--(.*)--\>/,a=b;a<=e;a++)if(!f.test(c.getLine(a))){d=
!1;break}for(var g=new i(0,0,0,0),a=b;a<=e;a++)b=c.getLine(a),g.start.row=a,g.end.row=a,g.end.column=b.length,c.replace(g,d?b.match(f)[1]:"<\!--"+b+"--\>")}}).call(j.prototype);c.Mode=j});
define("eXide/mode/html",function(b,c){var a=b("ace/lib/oop"),d=b("ace/mode/html").Mode,f=b("ace/tokenizer").Tokenizer,e=b("ace/mode/html_highlight_rules").HtmlHighlightRules,g=b("ace/mode/folding/html").FoldMode,h=b("eXide/mode/behaviour/xml").XMLBehaviour,i=b("ace/range").Range,j=b("ace/mode/javascript").Mode,l=b("ace/mode/css").Mode,n=function(a){var c=new e;this.$tokenizer=new f(c.getRules());this.$behaviour=new h(a);this.foldingRules=new g;this.$embeds=c.getEmbeds();this.createModeDelegates({"js-":j,
"css-":l})};a.inherits(n,d);(function(){this.toggleCommentLines=function(a,c,b,e){for(var d=!0,f=/^\s*<\!--(.*)--\>/,a=b;a<=e;a++)if(!f.test(c.getLine(a))){d=!1;break}for(var g=new i(0,0,0,0),a=b;a<=e;a++)b=c.getLine(a),g.start.row=a,g.end.row=a,g.end.column=b.length,c.replace(g,d?b.match(f)[1]:"<\!--"+b+"--\>")}}).call(n.prototype);c.Mode=n});var eXide=eXide||{};eXide.namespace=function(b){var b=b.split("."),c=eXide,a;"eXide"==b[0]&&(b=b.slice(1));for(a=0;a<b.length;a++)"undefined"==typeof c[b[a]]&&(c[b[a]]={}),c=c[b[a]];return c};eXide.namespace("eXide.util");
eXide.util=function(){var b={dir1:"up",dir2:"left",firstpos1:15,firstpos2:15};$(document).ready(function(){$.pnotify.defaults.history=!1;$.pnotify.defaults.styling="jqueryui"});return{supportsHtml5Storage:function(){try{return"localStorage"in window&&null!==window.localStorage}catch(c){return!1}},supportsFullScreen:function(){return document.cancelFullScreen||document.webkitCancelFullScreen||document.mozCancelFullScreen?!0:!1},requestFullScreen:function(c){if(document.fullScreen||document.webkitIsFullScreen||
document.mozFullScreen){var a=document.cancelFullScreen||document.webkitCancelFullScreen||document.mozCancelFullScreen;a.call(document)}else(a=c.requestFullScreen||c.webkitRequestFullScreen||c.mozRequestFullScreen)&&a.call(c,!0)},normalizePath:function(c){if(!c)return c;for(var c=c.replace(/^xmldb:exist:\/\//,""),a=[],c=c.split("/"),b=c.length,f=0;f<b;f++)".."==c[f]?a.pop():a.push(c[f]);return a.join("/")},parseSignature:function(c){var a=c.indexOf("(");if(-1<a){var b=c.substring(0,a+1),c=c.substring(a);
if(c=c.match(/\$[^\s,\)]+/g))for(a=0;a<c.length;a++)0<a&&(b+=", "),b+="${"+(a+1)+":\\$"+c[a].substring(1)+"}";return b+")"}return c},message:function(c){$.pnotify({text:c,shadow:!0,hide:!0,closer:!0,opacity:0.65,addclass:"stack-bottomright custom",stack:b})},success:function(c){$.pnotify({text:c,shadow:!0,type:"success",hide:!0,closer:!0,opacity:0.65,addclass:"stack-bottomright custom",stack:b})},error:function(c,a){var d={text:c,type:"error",shadow:!0,hide:!0,addclass:"stack-bottomright custom",
stack:b};a&&(d.title=a);$.pnotify(d)}}}();eXide.namespace("eXide.util.Dialog");
eXide.util.Dialog=function(){var b,c=null;$(document).ready(function(){$(document.body).append('<div id="eXide-dialog-message">\t<img id="eXide-dialog-message-icon" src="resources/images/error.png"/>\t<div id="eXide-dialog-message-body"></div></div>');b=$("#eXide-dialog-message");b.dialog({appendTo:"#layout-container",modal:!0,autoOpen:!1,buttons:{OK:function(){$(this).dialog("close")}}});$(document.body).append('<div id="eXide-dialog-input">\t<img id="eXide-dialog-input-icon" src="resources/images/information.png"/>\t<div id="eXide-dialog-input-body"></div></div>');inputDialog=
$("#eXide-dialog-input");inputDialog.dialog({modal:!0,autoOpen:!1,buttons:{OK:function(){$(this).dialog("close");null!=c&&c.apply($("eXide-dialog-input-body"),[])},Cancel:function(){$(this).dialog("close")}}})});return{message:function(a,c){null==c&&(c="");b.dialog("option","title",a);$("#eXide-dialog-message-body").html(c);$("#eXide-dialog-message-icon").attr("src","resources/images/information.png");b.dialog("open")},warning:function(a,c){null==c&&(c="");b.dialog("option","title",a);$("#eXide-dialog-message-body").html(c);
$("#eXide-dialog-message-icon").attr("src","resources/images/error.png");b.dialog("open")},input:function(a,b,f){c=f;inputDialog.dialog("option","title",a);$("#eXide-dialog-input-body").html(b);inputDialog.dialog("open")}}}();eXide.namespace("eXide.util.mimeTypes");
eXide.util.mimeTypes=function(){var b={xml:["text/xml","application/xml","application/xhtml+xml","application/atom+xml"],xquery:["application/xquery"],css:["text/css"],html:["text/html"],javascript:["application/x-javascript"],text:["text/text"],less:["application/less"],tmsnippet:["application/tmsnippet"],json:["application/json"],markdown:["text/x-markdown"]};return{getMime:function(c){var a=c.indexOf(";");-1<a&&(c=c.substring(0,a));return c},getLangFromMime:function(c){for(var a in b)for(var d=
b[a],f=0;f<d.length;f++)if(c==d[f])return a;return"xquery"},getMimeFromLang:function(c){return(c=b[c])?c[0]:"application/xquery"}}}();eXide.namespace("eXide.util.oop");eXide.util.oop.inherit=function(){var b=function(){};return function(c,a){b.prototype=a.prototype;c.prototype=new b;c.super_=a.prototype;c.prototype.constructor=c}}();eXide.util.oop.extend=function(){return function(b,c){for(var a in c)c.hasOwnProperty(a)&&(b[a]=c[a])}}();
(function(b){b.log=function(){window.console&&window.console.log&&Function.prototype.bind.call(console.log,console).apply(console,arguments)};b.fn.log=function(){b.log(this);return this}})(jQuery);eXide.namespace("eXide.util.Popup");
eXide.util.Popup=function(){function b(){$(g).find(".title span").text(p);if(0==p.length)i.find("tr").css("display","");else{i.find("tr").removeClass("selection").css("display","none");var a=RegExp(p,"i");i.find("tr").each(function(){var c=$(this).find("td:first .label").text();a.test(c)&&$(this).css("display","")})}c(i.find("tr:visible").first())}function c(a){if(0!=a.length){n.removeClass("selection");a.addClass("selection");n=a;var a=a[0],c=h[0];a.offsetTop<c.scrollTop?c.scrollTop=a.offsetTop-
3:a.offsetTop+a.offsetHeight>c.scrollTop+c.clientHeight&&(c.scrollTop=a.offsetTop+a.offsetHeight-c.clientHeight+3);var b=n.find(".tooltip");0<b.length?d(!0,function(){l.empty().html(b[0].innerHTML)}):d(!1)}}function a(a,c){return a.label==c.label?0:a.label>c.label?1:-1}function d(a,c){var b=0<l.width();l.empty();a?b?l.html(c):l.removeClass("hide").animate({width:320},300,function(){l.html(c)}):b&&l.animate({width:0},300,function(){l.addClass("hide")})}function f(){g.css("display","none");l.css("width",
"0").empty().addClass("hide");keydown=!1;p="";$(g).find(".title span").text(p);j.focus()}var e=[],g,h,i,j,l=null,n=null,o=function(){},p="";return{init:function(a,d){g=$(a);j=d;var u=$("<div class='title'><a href='#'>[X]</a><span>Type to filter</span></div>").appendTo(g);h=$("<div class='items'><table></table></div>").appendTo(g);i=h.find("table");l=$("<div class='tooltips hide'></div>").appendTo(g);u.find("a").click(function(a){a.preventDefault();f()});$(g).on("keydown",function(a){keydown=!0;40==
a.which?(a.preventDefault(),a=i.find("tr").index(n),a=n.nextAll(":visible").first(),0<a.length&&c(a)):38==a.which?(a.preventDefault(),a=n.prevAll(":visible").first(),0<a.length&&c(a)):13==a.which?(a.preventDefault(),a=i.find("tr").index(n),f(),o.call(null,e[a])):27==a.which?(a.preventDefault(),f(),o.call(null,null)):8==a.which&&(a.preventDefault(),0<p.length&&(p=p.substring(0,p.length-1),b()))});$(g).on("keypress",function(a){if(keydown)switch(a=0==a.which?a.keyCode:a.which,a){case 40:case 38:case 13:case 27:case 8:break;
default:p+=String.fromCharCode(a),b()}})},show:function(b,d){o=d;e=b;p="";i.empty();e.sort(a);for(var f=0;f<e.length;f++){var h=document.createElement("tr");0==f&&(h.className="selection",n=$(h));var q;if(e[f].label instanceof Array)for(var m=0;m<e[f].label.length;m++){q=document.createElement("td");var j=document.createElement("span");j.className="label";j.appendChild(document.createTextNode(e[f].label[m]));q.appendChild(j);h.appendChild(q)}else q=document.createElement("td"),j=document.createElement("span"),
j.className="label",j.appendChild(document.createTextNode(e[f].label)),q.appendChild(j),h.appendChild(q);e[f].tooltip&&(m=document.createElement("span"),m.className="tooltip",m.innerHTML=e[f].tooltip,q.appendChild(m));i.append(h);$(h).click(function(){n.removeClass("selection");$(this).addClass("selection");c($(this))});$(h).dblclick(function(){var a=i.find("tr").index(n);g.css("display","none");l&&l.css("display","none");o.call(null,e[a])})}c(n);g.fadeIn().focus()},position:function(a){g.css({visibility:"hidden",
display:"block"});g.css({left:a.pageX,top:a.pageY+15});var c=window.innerWidth||Math.max(document.body.offsetWidth,document.documentElement.offsetWidth),b=window.innerHeight||Math.max(document.body.offsetHeight,document.documentElement.offsetHeight),e=g[0].getBoundingClientRect(),d=e.right-c,f=e.bottom-b;0<d&&(e.right-e.left>c&&(g[0].style.width=c-5+"px",d-=e.right-e.left-c),g.css("left",(left=a.pageX-d)+"px"));0<f&&(c=e.bottom-15-e.top,0<e.top-c?(f=c+15,below=!1):c>b&&(g.height(b-5+"px"),f-=c-b),
g.css("top",(top=a.pageY-f)+"px"));g.css({visibility:"visible",display:"none"})}}}();eXide.namespace("eXide.events.Sender");eXide.events.Sender=function(){Constr=function(){};Constr.prototype={addEventListener:function(b,c,a){"function"==typeof c&&(a=c,c=null);this.events=this.events||{};var d=this.events[b];d||(d=[],this.events[b]=d);d.push({obj:c,callback:a})},$triggerEvent:function(b,c){this.events=this.events||{};var a=this.events[b];if(a)for(var d=0;d<a.length;d++)a[d].callback.apply(a[d].obj,c)}};return Constr}();eXide.namespace("eXide.edit.commands");
eXide.edit.commands=function(){function b(a){if(a)return{win:a[0],mac:a[1],sender:"editor"}}var c=require("ace/lib/useragent"),a=require("ace/snippets").snippetManager,d={};return{init:function(f){var e=f.editor.commands;$.ajax({url:"keybindings.js",dataType:"json",async:!1,success:function(g){e.addCommand({name:"gotoLine",bindKey:b(g.gotoLine),exec:function(){f.gotoLine()}});e.addCommand({name:"fold",bindKey:b(g.fold),exec:function(a){a.session.toggleFold(!1)},readOnly:!0});e.addCommand({name:"selectMoreBefore",
exec:function(a){a.selectMore(-1)},bindKey:{win:"Ctrl-Alt-Left",mac:"Ctrl-Alt-Command-Left"},readOnly:!0});e.addCommand({name:"selectMoreAfter",exec:function(a){a.selectMore(1)},bindKey:{win:"Ctrl-Alt-Right",mac:"Ctrl-Alt-Command-Right"},readOnly:!0});e.addCommand({name:"unfold",bindKey:b(g.unfold),exec:function(a){a.session.toggleFold(!0)},readOnly:!0});e.addCommand({name:"saveDocument",bindKey:b(g.saveDocument),exec:function(){eXide.app.saveDocument()}});e.addCommand({name:"runQuery",bindKey:b(g.runQuery),
exec:function(){eXide.app.runQuery()}});e.addCommand({name:"openDocument",bindKey:b(g.openDocument),exec:function(){eXide.app.openDocument()}});e.addCommand({name:"newDocumentFromTemplate",bindKey:b(g.newDocumentFromTemplate),exec:function(){eXide.app.newDocumentFromTemplate()}});e.addCommand({name:"closeDocument",bindKey:b(g.closeDocument),exec:function(){eXide.app.closeDocument()}});e.addCommand({name:"autocomplete",bindKey:b(g.autocomplete),exec:function(){f.autocomplete()}});e.addCommand({name:"nextTab",
bindKey:b(g.nextTab),exec:function(){f.nextTab()}});e.addCommand({name:"previousTab",bindKey:b(g.previousTab),exec:function(){f.previousTab()}});e.addCommand({name:"xquery-format",bindKey:b(g.xqueryFormat),exec:function(){f.exec("format")}});e.addCommand({name:"functionDoc",bindKey:b(g.functionDoc),exec:function(){f.exec("showFunctionDoc")}});e.addCommand({name:"gotoDefinition",bindKey:b(g.gotoDefinition),exec:function(){f.exec("gotoDefinition")}});e.addCommand({name:"gotoSymbol",hint:"Goto symbol",
bindKey:b(g.gotoSymbol),exec:function(){f.exec("gotoSymbol")}});e.addCommand({name:"searchReplace",bindKey:b(g.searchReplace),exec:function(){f.search.open()}});e.addCommand({name:"findModule",bindKey:b(g.findModule),exec:function(){var a=f.getActiveDocument();eXide.find.Modules.select(a.syntax)}});e.addCommand({name:"escape",bindKey:b(g.escape),exec:function(a){f.getActiveDocument().template=null;a.clearSelection()}});e.addCommand({name:"dbManager",bindKey:b(g.dbManager),exec:function(){eXide.app.manage()}});
e.addCommand({name:"toggleComment",bindKey:b(g.toggleComment),exec:function(a){a.toggleCommentLines()}});e.addCommand({name:"synchronize",bindKey:b(g.synchronize),exec:function(){eXide.app.synchronize()}});e.addCommand({name:"preferences",bindKey:b(g.preferences),exec:function(){eXide.app.showPreferences()}});e.addCommand({name:"openApp",bindKey:b(g.openApp),exec:function(){eXide.app.openApp()}});e.addCommand({name:"quickfix",bindKey:b(g.quickfix),exec:function(){f.exec("quickFix")}});e.addCommand({name:"expandSelection",
bindKey:b(g.expandSelection),exec:function(){f.exec("expandSelection")}});e.addCommand({name:"renameSymbol",bindKey:b(g.renameSymbol),exec:function(){f.exec("rename")}});e.addCommand({name:"removeTags",bindKey:b(g.removeTags),exec:function(){f.exec("removeTags")}});e.addCommand({name:"extractFunction",hint:"Extract Function",bindKey:b(g.extractFunction),exec:function(){f.exec("extractFunction")}});e.addCommand({name:"extractVariable",hint:"Extract Variable",bindKey:b(g.extractVariable),exec:function(){f.exec("extractVariable")}});
e.addCommand({name:"snippet",hint:"code snippet",bindKey:{mac:"Tab",win:"Tab"},exec:function(c){var b=a.expandWithTab(c);b||(b=f.autocomplete(!1));b||c.execCommand("indent")}});e.addCommand({name:"openTab",hint:"select open tab",bindKey:b(g.openTab),exec:function(){f.selectTab()}});e.addCommand({name:"toggleQueryResults",hint:"toggle query results panel",bindKey:b(g.toggleQueryResults),exec:function(){eXide.app.toggleResultsPanel()}});e.addCommand({name:"commandPalette",hint:"Command Palette",bindKey:b(g.commandPalette),
exec:function(){eXide.app.getMenu().commandPalette()}});e.addCommand({name:"findFiles",hint:"Find in files",bindKey:b(g.findFiles),exec:function(){eXide.app.findFiles()}});g=f.editor.commands;for(key in g.commands){var h=g.commands[key];h.bindKey&&(d[h.name]=c.isMac?h.bindKey.mac:h.bindKey.win)}}})},help:function(a,b){$(a).find("table").each(function(){this.innerHTML="";var a=b.editor.commands;for(key in a.commands){var d=a.commands[key],f=document.createElement("tr"),j=document.createElement("td");
j.appendChild(document.createTextNode(d.name));f.appendChild(j);j=document.createElement("td");d.bindKey&&(c.isMac?j.appendChild(document.createTextNode(d.bindKey.mac)):j.appendChild(document.createTextNode(d.bindKey.win)));f.appendChild(j);this.appendChild(f)}})},getShortcut:function(a){return d[a]}}}();eXide.namespace("eXide.edit.ModeHelper");
eXide.edit.ModeHelper=function(){var b=require("ace/snippets").snippetManager,c=require("ace/range").Range;Constr=function(a){this.parent=a;this.editor=this.parent.editor;this.commands={};this.addCommand("locate",this.locate)};Constr.prototype={activate:function(){},deactivate:function(){},addCommand:function(a,c){this.commands||(this.commands={});this.commands[a]=c},exec:function(a,c,b){if(this.commands&&this.commands[a]){for(var c=[c],e=0;e<b.length;e++)c.push(b[e]);$.log("Calling command %s ...",
a);this.commands[a].apply(this,c)}else eXide.util.message(a+" not supported in this mode.")},validate:function(a,c,b){b&&b(a)},createOutline:function(){d3.select("#outline").selectAll("li").transition().duration(400).style("opacity",0).remove()},documentSaved:function(){},locate:function(a,c,b){"number"==typeof b&&(this.editor.gotoLine(b+1),this.editor.focus());return!1},autocomplete:function(a,d){function f(a){g&&e.editor.getSession().remove(g);b.insertSnippet(e.editor,a.template)}var e=this,g;void 0===
d&&(d=!0);void 0===d&&(d=!0);var h=this.editor.getSelection(),i=h.getSelectionLead(),j=this.editor.renderer.textToScreenCoordinates(i.row,i.column),l;if(h.isEmpty()){h=i.row;l=this.editor.getSession().getDisplayLine(i.row);for(var n=i.column-1,i=i.column;0<=n;){var o=l.substring(n,i);if(o.match(/^\$[\w:\-_\.]+$/))break;if(!o.match(/^[\w:\-_\.]+$/)){n++;break}n--}l=l.substring(n,i);i++;if(""===l&&!d)return!1;g=new c(h,n,h,i)}else if(!d)return!1;eXide.util.Popup.position(j);j=this.getTemplates(a,l,
[]);if(0==j.length)return!1;1<j.length?eXide.util.Popup.show(j,function(a){a&&f(a)}):1==j.length&&f(j[0]);return!0},getTemplates:function(a,c,b){a=eXide.util.Snippets.getTemplates(a,c);for(c=0;c<a.length;c++)b.push({type:"template",label:"[S] "+a[c].name,template:a[c].template,completion:a[c].completion});return b}};return Constr}();eXide.namespace("eXide.edit.XQueryModeHelper");
eXide.edit.XQueryModeHelper=function(){function b(a){var c;c=a.line?a["#text"]:a;var b=l.exec(c),e=-1;b?e=parseInt(b[1])-1:a.line&&(e=parseInt(a.line)-1);return{line:e,column:parseInt(a.column||0),msg:c}}var c=/^[\$\w:\-_\.]+/,a=require("lib/visitors/SemanticHighlighter").SemanticHighlighter,d=require("lib/XQueryParser").XQueryParser,f=require("lib/JSONParseTreeHandler").JSONParseTreeHandler,e=require("lib/Translator").Translator,g=require("lib/visitors/CodeFormatter").CodeFormatter;require("lib/Compiler");
var h=require("ace/range").Range,i=require("ace/anchor").Anchor,j=require("ace/snippets").snippetManager;Constr=function(a,c){this.parent=a;this.editor=this.parent.editor;this.xqDebugger=null;this.funcDefRe=/declare\s+((?:%[\w\:\-]+(?:\([^\)]*\))?\s*)*)function\s+([^\(]+)\(/g;this.varDefRe=/declare\s+(?:%\w+\s+)*variable\s+\$[^\s;]+/gm;this.varRe=/declare\s+(?:%\w+\s+)*variable\s+(\$[^\s;]+)/;this.parseImportRe=/import\s+module\s+namespace\s+[^=]+\s*=\s*["'][^"']+["']\s*at\s+["'][^"']+["']\s*;/g;
this.moduleRe=/import\s+module\s+namespace\s+([^=\s]+)\s*=\s*["']([^"']+)["']\s*at\s+["']([^"']+)["']\s*;/;this.trimRe=/^[\x09\x0a\x0b\x0c\x0d\x20\xa0\u1680\u180e\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u2028\u2029\u202f\u205f\u3000]+|[\x09\x0a\x0b\x0c\x0d\x20\xa0\u1680\u180e\u2000\u2001\u2002\u2003\u2004\u2005\u2006\u2007\u2008\u2009\u200a\u2028\u2029\u202f\u205f\u3000]+$/g;this.addCommand("format",this.format);this.addCommand("expandSelection",this.expandSelection);this.addCommand("rename",
this.rename);this.addCommand("extractFunction",this.extractFunction);this.addCommand("extractVariable",this.extractVariable);this.addCommand("showFunctionDoc",this.showFunctionDoc);this.addCommand("gotoDefinition",this.gotoDefinition);this.addCommand("gotoSymbol",this.gotoSymbol);this.addCommand("locate",this.locate);this.addCommand("closeTag",this.closeTag);this.addCommand("importModule",this.importModule);this.addCommand("quickFix",this.quickFix);this.addCommand("debug",this.initDebugger);this.addCommand("stepOver",
this.stepOver);this.addCommand("stepInto",this.stepInto);var b=this;this.menu=$("#menu-xquery").hide();c.click("#menu-xquery-format",function(){b.format(a.getActiveDocument())});c.click("#menu-xquery-expand",function(){b.expandSelection(a.getActiveDocument())});c.click("#menu-xquery-rename",function(){b.rename(a.getActiveDocument())});c.click("#menu-xquery-extract-function",function(){b.extractFunction(a.getActiveDocument())});c.click("#menu-xquery-extract-variable",function(){b.extractVariable(a.getActiveDocument())});
c.click("#menu-xquery-run-test",function(){b.runTest(a.getActiveDocument())});b.validating=null;b.validationListeners=[]};eXide.util.oop.inherit(Constr,eXide.edit.ModeHelper);Constr.prototype.activate=function(){this.menu.show();this.parent.updateStatus("")};Constr.prototype.deactivate=function(){this.menu.hide()};Constr.prototype.afterValidate=function(a,c){this.validationListeners.push({context:a,exec:c})};Constr.prototype.closeTag=function(a,c){var e="xmldb:exist://"+a.getBasePath(),d=this;$.ajax({type:"POST",
url:"modules/compile.xql",data:{q:c,base:e},dataType:"json",success:function(a){if("fail"==a.result){var a=b(a.error),c=/constructor:\s([^\)]+)\)?$/.exec(a.msg);c&&0<c.length?d.editor.insert(c[1]+">"):(c=/tag:.*;\sexpected:\s(.*)$/.exec(a.msg))&&0<c.length&&d.editor.insert(c[1]+">")}},error:function(){}})};Constr.prototype.validate=function(a,c,b){var e=this,d="xmldb:exist://"+a.getBasePath();this.xqlint(a);for(var f=0;f<this.validationListeners.length;f++){var g=this.validationListeners[f];g.exec.apply(g.context,
[a])}this.validationListeners.length=0;$.ajax({type:"POST",url:"modules/compile.xql",data:{q:c,base:d},dataType:"json",success:function(c){c=e.compileError(c,a);b&&b.call(this,c)},error:function(a,c){b&&b.call(this,!1);$.log("Compile error: %s - %s",c,a.responseText)}})};Constr.prototype.compileError=function(a,c){if("fail"==a.result){var e=b(a.error),d={row:e.line,column:e.column,text:e.msg,type:"error"};this.parent.updateStatus(e.msg,c.getPath()+"#"+e.line);e=this.clearAnnotations(c,"error");e.push(d);
c.getSession().setAnnotations(e);return!1}c.getSession().setAnnotations(this.clearAnnotations(c,"error"));this.parent.updateStatus("");return!0};Constr.prototype.xqlint=function(c){if(!(c.ast&&c.lastValidation>=c.getLastChanged())){$.log("Running xqlint...");var b=c.getSession(),g=c.getText(),h=new f(g),i=new d(g,h);try{i.parse_XQuery()}catch(j){$.log("Error while parsing XQuery: %s",i.getErrorMessage(j)),j instanceof i.ParseException&&h.closeParseTree()}try{var r=h.getParseTree(),q=new e(r);c.ast=
q.translate();c.lastValidation=(new Date).getTime();var m=new a(r,g),l=c.getSession().getMode();l.$tokenizer.tokens=m.getTokens();l.$tokenizer.lines=b.getDocument().getAllLines();b.bgTokenizer.lines=[];b.bgTokenizer.states=[];for(var v=Object.keys(l.$tokenizer.tokens),g=0;g<v.length;g++){var w=parseInt(v[g]);b.bgTokenizer.fireUpdateEvent(w,w)}for(var t=c.ast.markers,y=this.clearAnnotations(c,"warning"),g=0;g<t.length;g++)"error"!==t[g].type&&y.push({row:t[g].pos.sl,column:t[g].pos.sc,text:t[g].message,
type:t[g].type,pos:t[g].pos});b.setAnnotations(y)}catch(A){$.log("Error while processing ast: %s",A.message)}}};Constr.prototype.clearAnnotations=function(a,c){for(var b=[],e=a.getSession().getAnnotations(),d=0;d<e.length;d++)e[d].type!==c&&b.push(e[d]);return b};Constr.prototype.autocomplete=function(a,c){this.xqlint(a);void 0===c&&(c=!0);var b=this.editor.getSelection(),e=a.getSession(),d=b.getSelectionLead(),f="",g="templates",i;if(b.isEmpty()){var m=eXide.edit.XQueryUtils.findNode(a.ast,{line:d.row,
col:d.column});$.log("Autocomplete AST node: %o; doc: %o",m,a.ast);if(m){var j=m.getParent;if("VarRef"===j.name||"VarName"===j.name)g="variables",b=m.pos.sl,i=m.pos.ec,"EQName"===m.name?(f=m.value,e=m.pos.sc-1):e=m.pos.sc,m=j;else{var j=eXide.edit.XQueryUtils.findAncestor(m,"Import"),l=eXide.edit.XQueryUtils.findAncestor(m,"NamespaceDecl");if(j){if(g="modules","NCName"==m.name?f=m.value:"URILiteral"==m.name&&(b=eXide.edit.XQueryUtils.findSibling(m,"NCName"))&&(f=eXide.edit.XQueryUtils.getValue(b)),
b=j.pos.sl,e=j.pos.sc,i=j.pos.ec,j=eXide.edit.XQueryUtils.findNext(j,"Separator"))i=j.pos.ec}else if(l){if(g="namespaces","NCName"==m.name?f=m.value:"URILiteral"==m.name&&(b=eXide.edit.XQueryUtils.findSibling(m,"NCName"))&&(f=eXide.edit.XQueryUtils.getValue(b)),b=l.pos.sl,e=l.pos.sc,i=l.pos.ec,j=eXide.edit.XQueryUtils.findNext(l,"Separator"))i=j.pos.ec}else if("EQName"==m.name)g="functions",f=m.value,b=m.pos.sl,e=m.pos.sc,i=m.pos.ec;else{if(!c)return!1;b=d.row;i=e=d.column}}}else{g="functions";b=
d.row;line=e.getDisplayLine(d.row);e=d.column-1;for(i=d.column;0<=e;){f=line.substring(e,i);if(f.match(/^\$[\w:\-_\.]+$/))break;if(!f.match(/^[\w:\-_\.]+$/)){e++;break}e--}f=line.substring(e,i);i++;if(""===f&&!c)return!1;"$"==f.substring(0,1)&&(g="variables",f=f.substring(1))}b=new h(b,e,b,i)}else g="templates",b=null;if(!c&&"templates"===g)return!1;$.log("completing token: %s, mode: %s, range: %o",f,g,b);d=this.editor.renderer.textToScreenCoordinates(d.row,d.column);eXide.util.Popup.position(d);
"templates"==g?this.templateLookup(a,f,b,!0):"functions"==g?this.functionLookup(a,f,b,!0):"namespaces"==g?this.namespaceLookup(a,f,b,!0):"variables"==g?this.variableLookup(a,m,f,b,!0):this.moduleLookup(a,f,b,!0);return!0};Constr.prototype.variableLookup=function(a,c,b,e,d){"$"==b.substring(0,1)&&(b=b.substring(1));$.log("Lookup variable %s",b);var f=new eXide.edit.InScopeVariables(a.ast,c),c=[],g=b?RegExp("^\\$?"+b):null;if(f=f.getStack())for(var h=0;h<f.length;h++)(!b||g.test(f[h]))&&c.push({label:f[h],
template:"$"+f[h],type:"variable"});for(h=0;h<a.functions.length;h++)"variable"==a.functions[h].type&&(!b||g.test(a.functions[h].name))&&c.push({label:a.functions[h].name,template:"$"+a.functions[h].name,type:"variable"});this.$showPopup(a,e,c,d)};Constr.prototype.functionLookup=function(a,c,b,e){var d=this;$.ajax({url:"modules/docs.xql",dataType:"text",type:"POST",data:{prefix:c},success:function(f){var f=$.parseJSON(f),g=[],h=RegExp("^"+c);$.each(a.functions,function(a,c){c.name.match(h)&&g.push(c)});
f&&(g=g.concat(f));for(var f=[],i=0;i<g.length;i++){var j={label:g[i].signature?g[i].signature:g[i].name,type:g[i].type};g[i].help&&(j.tooltip=g[i].help);f.push(j)}d.getTemplates(a,c,f);d.$showPopup(a,b,f,e)},error:function(a,c){eXide.util.error(c)}})};Constr.prototype.templateLookup=function(a,c,b,e){var d=[];this.getTemplates(a,c,d);this.$showPopup(a,b,d,e)};Constr.prototype.moduleLookup=function(a,c,b,e){var d=this;$.getJSON("modules/find.xql",{prefix:c},function(c){if(c){for(var f=[],g=0;g<c.length;g++)f.push({type:"template",
label:[c[g].prefix,c[g].uri],tooltip:c[g].at,template:c[g].at?"import module namespace "+c[g].prefix+'="'+c[g].uri+'" at "'+c[g].at+'";':"import module namespace "+c[g].prefix+'="'+c[g].uri+'";'});d.$showPopup(a,b,f,e)}})};Constr.prototype.namespaceLookup=function(a,c,b,e){var d=this;$.getJSON("templates/namespaces.json",function(f){if(f){var g=[],h;for(h in f)(!h||h===c)&&g.push({type:"namespace",label:[h,f[h]],template:"declare namespace "+h+'="'+f[h]+'";'});d.$showPopup(a,b,g,e)}})};Constr.prototype.gotoSymbol=
function(a){for(var c=this,b=[],e=0;e<a.functions.length;e++)item={label:a.functions[e].signature?a.functions[e].signature:a.functions[e].name,name:a.functions[e].name,type:a.functions[e].type},a.functions[e].help&&(item.tooltip=a.functions[e].help),b.push(item);1<b.length&&(this.parent.getWidth(),e=this.parent.getOffset().left,eXide.util.Popup.position({pageX:e,pageY:40}),eXide.util.Popup.show(b,function(b){b&&c.parent.outline.gotoDefinition(a,b.name)}))};Constr.prototype.$showPopup=function(a,c,
b,e){function d(b){if(e){var g=b.label,g="function"==b.type?eXide.util.parseSignature(g):b.template;c&&f.editor.getSession().remove(c);"variable"===b.type?f.editor.insert(g):j.insertSnippet(f.editor,g);b.completion&&f.autocomplete(a)}$.log("template applied")}var f=this;1<b.length||!e?eXide.util.Popup.show(b,function(a){a&&d(a)}):1==b.length&&d(b[0])};Constr.prototype.getFunctionAtCursor=function(a,b){var e,d=eXide.edit.XQueryUtils.findNode(a.ast,{line:b.row,col:b.column});if(d&&(d=eXide.edit.XQueryUtils.findAncestor(d,
"FunctionCall")))e=d.children[0].value;if(!e){e=b.row;e=this.editor.getSession().getDisplayLine(e);d=b.column;do d--;while(0<=d&&e.charAt(d).match(c));d++;for(var f=b.column;f<e.length&&e.charAt(f).match(c);)f++;e=e.substring(d,f)}return e};Constr.prototype.showFunctionDoc=function(a){this.xqlint(a);var c=this.editor.getSelection().getSelectionLead(),b=this.editor.renderer.textToScreenCoordinates(c.row,c.column);eXide.util.Popup.position(b);c=this.getFunctionAtCursor(a,c);this.functionLookup(a,c,
null,!1)};Constr.prototype.quickFix=function(a,c){c||(c=this.editor.getCursorPosition().row);$.log("Requesting quick fix for %s at %d",a.getName(),c);var b=this.editor.renderer.textToScreenCoordinates(c,0);eXide.util.Popup.position(b);for(var e=[],d=a.getSession().getAnnotations(),f=0;f<d.length;f++)d[f].row===c&&(b=eXide.edit.XQueryQuickFix.getResolutions(this,this.editor,a,d[f]),$.each(b,function(a,c){e.push({label:c.action,resolve:c.resolve,annotation:d[f]})}));if(0<e.length){var g=this;eXide.util.Popup.show(e,
function(c){if(c){c.resolve(g,g.parent,a,c.annotation);g.editor.focus()}})}};Constr.prototype.gotoDefinition=function(a){this.xqlint(a);var c=this.editor.getSelection().getSelectionLead();(c=this.getFunctionAtCursor(a,c))&&this.parent.outline.gotoDefinition(a,c)};Constr.prototype.locate=function(a,c,b){switch(c){case "function":this.gotoFunction(a,b);break;default:this.gotoVarDecl(a,b)}};Constr.prototype.format=function(a){var c=this.editor.getSelectionRange(),b=a.getSession().getTextRange(c);if(0==
b.length)eXide.util.error("Please select code to format.");else{var e=a.getSession().doc.getLine(c.start.row).match(/^\s*/)[0],h=new f(b),b=new d(b,h);try{b.parse_XQuery();for(var i=h.getParseTree(),r=(new g(i,!0)).format().split(/\n/),h=0;h<r.length;h++)r[h]=e+r[h];a.getSession().replace(c,r.join("\n"))}catch(j){console.log("Error parsing XQuery code: %s",b.getErrorMessage(j)),eXide.util.error("Code could not be parsed. Please select a valid code block.")}}};Constr.prototype.extractVariable=function(a){this.xqlint(a);
var c=this.editor.getSelectionRange(),b=a.getSession().getTextRange(c);if(0==b.length)eXide.util.error("Please select code to extract.");else{var e=new i(a.getSession().getDocument(),c.start.row,c.start.column);this.parent.validationEnabled=!1;c=eXide.edit.XQueryUtils.findNode(a.ast,{line:c.start.row,col:c.start.column+1});if(a=eXide.edit.XQueryUtils.findAncestor(c,["IntermediateClause","InitialClause","ReturnClause"]))b="let $${1} := "+b.replace("$","\\$");else{a=eXide.edit.XQueryUtils.findAncestor(c,
"StatementsAndOptionalExpr");a=eXide.edit.XQueryUtils.findChild(a,"Expr");if(!a){eXide.util.error("Extract variable: unable to determine context. Giving up.");return}b="let $${1} := "+b.replace("$","\\$")+"\nreturn"}$.log("extract variable: context: %o",a);this.editor.insert("$");this.editor.gotoLine(a.pos.sl+1,a.pos.sc);this.editor.insert("\n");this.editor.gotoLine(a.pos.sl+1,a.pos.sc);j.insertSnippet(this.editor,b);this.editor.focus();b=this.editor.getSelection();b.toOrientedRange();a=e.getPosition();
c=new h(a.row,a.column,a.row,a.column);c.cursor=a;b.addRange(c);e.detach();this.parent.validationEnabled=!0}};Constr.prototype.extractFunction=function(a){this.xqlint(a);var c=this.editor.getSelectionRange(),b=a.getSession().getTextRange(c);if(0==b.length)eXide.util.error("Please select code to extract.");else{this.parent.validationEnabled=!1;var g=eXide.edit.XQueryUtils.findNode(a.ast,{line:c.start.row,col:c.start.column+1}),j=[],l=new f(b),r=new d(b,l);try{r.parse_XQuery();for(var q=l.getParseTree(),
q=(new e(q)).translate(),m=q.markers,q={},l=0;l<m.length;l++)if("error"===m[l].type){var x=/\[XPST0008\]\s"([^"]+)": undeclared variable.*/.exec(m[l].message);x&&2==x.length&&(q[x[1]]=0)}for(var v in q)j.push(v)}catch(w){eXide.util.error("Not a valid code block: "+r.getErrorMessage(w));return}r=new eXide.edit.PrologAdder(this.parent,a);g=r.getInsertionPoint(g);g=new i(a.getSession().getDocument(),g,0);this.editor.remove(c);m="(";for(l=0;l<j.length;l++)0<l&&(m+=", "),m+="$"+j[l];this.editor.insert(m+
")");this.editor.gotoLine(c.start.row,c.start.column);a=new i(a.getSession().getDocument(),c.start.row,c.start.column);r.createFunction(j,b,g.getPosition().row);this.editor.focus();b=this.editor.getSelection();b.toOrientedRange();j=a.getPosition();c=new h(j.row,j.column,j.row,j.column);c.cursor=j;b.addRange(c);a.detach();g.detach();this.parent.validationEnabled=!0}};Constr.prototype.gotoFunction=function(a,c){$.log("Goto function %s",c);var b=this.getModuleNamespacePrefix();null!=b&&(c=c.replace(/[^:]+:/,
b+":"));var e=a.$session.getLength(),d=function(c){for(var b=0;b<e;b++)if(a.$session.getLine(b).match(c))return b};if((b=d(RegExp("function\\s+"+c+"\\s*\\(")))||(b=d(RegExp("function\\s+"+c+"$"))))return this.editor.gotoLine(b+1),this.editor.focus()};Constr.prototype.gotoVarDecl=function(a,c){var b=this.getModuleNamespacePrefix();null!=b&&(c=c.replace(/[^:]+:/,"$"+b+":"));$.log("Goto variable declaration %s",c);for(var b=RegExp("variable\\s+\\"+c),e=a.$session.getLength(),d=0;d<e;d++)if(a.$session.getLine(d).match(b)){this.editor.gotoLine(d+
1);this.editor.focus();break}};Constr.prototype.getModuleNamespacePrefix=function(){for(var a=/^\s*module\s+namespace\s+([^=\s]+)\s*=/,c=this.parent.getActiveDocument().$session.getLength(),b=0;b<c;b++){var e=this.parent.getActiveDocument().$session.getLine(b).match(a);if(e)return e[1]}return null};Constr.prototype.importModule=function(a,c,b,e){$.log("location = %s path = %s",e,a.path);if(e)var d=a.getBasePath(),e=0===e.lastIndexOf(d,0)?e.substring(d.length+1):"xmldb:exist://"+e;(new eXide.edit.PrologAdder(this.parent,
a)).importModule(c,b,e)};Constr.prototype.expandSelection=function(a){this.xqlint(a);var c=this.editor.getSelection(),b=c.getRange();if(a=b.start.column==b.end.column&&b.start.line==b.end.line?eXide.edit.XQueryUtils.findNode(a.ast,{line:b.start.row,col:b.start.column}):eXide.edit.XQueryUtils.findNodeForRange(a.ast,{line:b.start.row,col:b.start.column},{line:b.end.row,col:b.end.column})){for(b=a.getParent;b&&eXide.edit.XQueryUtils.samePosition(a.pos,b.pos)&&!(a=b,b=b.getParent,!b););a=new h(b.pos.sl,
b.pos.sc,b.pos.el,b.pos.ec);c.setSelectionRange(a)}};Constr.prototype.rename=function(a){function c(a){e.toOrientedRange();$.each(a,function(a,c){var b=new h(c.pos.sl,c.pos.sc,c.pos.el,c.pos.ec);b.cursor=b.end;e.addRange(b)});b.editor.focus()}this.xqlint(a);var b=this,e=this.editor.getSelection(),d=e.getSelectionLead();if(d=eXide.edit.XQueryUtils.findNode(a.ast,{line:d.row,col:d.column}))if("QName"==d.name&&"DirElemConstructor"==d.getParent.name)a=eXide.edit.XQueryUtils.findSiblings(d,"QName"),a.push(d),
c(a);else if("VarName"==d.getParent.name||"Param"==d.getParent.name)a=eXide.edit.XQueryUtils.getValue(d),(d=eXide.edit.XQueryUtils.findVariableContext(d,a))?(a=(new eXide.edit.VariableReferences(a,d)).getReferences(),c(a)):eXide.util.message("Rename failed: unable to determine context, sorry.");else if("EQName"==d.name&&("FunctionDecl"==d.getParent.name||"FunctionCall"==d.getParent.name)){var f=d.value,d=parseInt(d.getParent.arity);$.log("searching calls to function: %s#%d",f,d);a=new eXide.edit.FunctionCalls(f,
d,a.ast);d=a.getReferences();a.declaration?(d.push(a.declaration),c(d)):eXide.util.message("Rename failed: function declaration not found.")}else eXide.util.message("Please position cursor within variable or function name.");else eXide.util.message("Rename failed: node not found in syntax tree, sorry.")};Constr.prototype.runTest=function(a){var c=this;this.xqlint(a);var b=new eXide.edit.ModuleInfo(a.ast);b.isModule()&&b.hasTests()&&$.ajax({type:"POST",url:"modules/run-test.xql",data:{source:a.getPath()},
dataType:"html",success:function(a){c.parent.updateStatus("");c.parent.clearErrors();eXide.app.showResultsPanel();$(".results-container .results").empty().append(a)},error:function(a){eXide.util.error(a.responseText,"Server Error")}})};Constr.prototype.createOutline=function(a,c){var b=a.getText();this.$parseLocalFunctions(b,a);(b=this.$parseImports(b))?this.$resolveImports(a,b,c):c(a)};Constr.prototype.$sortFunctions=function(a){a.functions.sort(function(a,c){return a.source&&!c.source?1:c.source&&
!a.source?-1:a.name==c.name?0:a.name>c.name?1:-1})};Constr.prototype.$parseLocalFunctions=function(a,c){for(c.functions=[];;){var b=this.funcDefRe.exec(a);if(null==b)break;var e=this.funcDefRe.lastIndex,d=this.$findMatchingParen(a,e),f=(3==b.length?b[2]:b[1]).replace(this.trimRe,""),b=3==b.length?b[1]:"public",e=f+"("+a.substring(e,d)+")";-1!==b.indexOf("%private")&&(b="private");c.functions.push({type:eXide.edit.Document.TYPE_FUNCTION,name:f,visibility:b,signature:e,sort:"$$"+e})}if(e=a.match(this.varDefRe))for(d=
0;d<e.length;d++)f=this.varRe.exec(e[d]),b=f[1].substr(1).split(":"),b.splice(1,0,":$"),f=f[1],"$"==f.substring(0,1)&&(f=f.substring(1)),c.functions.push({type:eXide.edit.Document.TYPE_VARIABLE,name:f,sort:"$$"+b.join("")});this.$sortFunctions(c)};Constr.prototype.$findMatchingParen=function(a,c){for(var b=1,e=c;e<a.length;e++){var d=a.charAt(e);if(")"==d){if(b-=1,0==b)return e}else"("==d&&(b+=1)}return-1};Constr.prototype.$parseImports=function(a){return a.match(this.parseImportRe)};Constr.prototype.$resolveImports=
function(a,c,b){for(var e=this,d=[],f=[],g=0;g<c.length;g++){var h=this.moduleRe.exec(c[g]);null!=h&&4==h.length&&(f.push("prefix="+encodeURIComponent(h[1])),f.push("uri="+encodeURIComponent(h[2])),f.push("source="+encodeURIComponent(h[3])))}c="xmldb:exist://"+a.getBasePath();f.push("base="+encodeURIComponent(c));$.ajax({url:"outline",dataType:"json",type:"POST",data:f.join("&"),success:function(c){if(null!=c){for(var c=c.modules,f=0;f<c.length;f++){var g=c[f].functions;if(g)for(var h=0;h<g.length;h++)d.push({type:eXide.edit.Document.TYPE_FUNCTION,
name:g[h].name,signature:g[h].signature,visibility:g[h].visibility,source:c[f].source,sort:g[h].signature});if(g=c[f].variables)for(h=0;h<g.length;h++){var i=g[h].split(":");i.splice(1,0,":$");d.push({type:eXide.edit.Document.TYPE_VARIABLE,name:g[h],source:c[f].source,sort:i.join("")})}}a.functions=a.functions.concat(d);e.$sortFunctions(a)}b&&b(a)}});return d};Constr.prototype.initDebugger=function(a){this.xqDebugger=new eXide.XQueryDebuger(this.editor,a);this.xqDebugger.init()};Constr.prototype.stepOver=
function(){this.xqDebugger&&this.xqDebugger.stepOver()};Constr.prototype.stepInto=function(){this.xqDebugger&&this.xqDebugger.stepInto()};var l=/.*line:?\s(\d+)/i;return Constr}();eXide.namespace("eXide.edit.XMLModeHelper");
eXide.edit.XMLModeHelper=function(){var b=require("ace/token_iterator").TokenIterator,c=require("ace/range").Range;Constr=function(a,c){var b=this;this.parent=a;this.editor=this.parent.editor;this.menu=$("#menu-xml").hide();c.click("#menu-xml-rename",function(){b.rename(a.getActiveDocument())});c.click("#menu-xml-select-element",function(){b.selectElement(a.getActiveDocument())});c.click("#menu-xml-remove-tag",function(){b.deleteTags(a.getActiveDocument())});this.addCommand("closeTag",this.closeTag);
this.addCommand("removeTags",this.deleteTags);this.addCommand("suggest",this.suggest);this.addCommand("rename",this.rename);this.addCommand("expandSelection",this.selectElement)};eXide.util.oop.inherit(Constr,eXide.edit.ModeHelper);Constr.prototype.activate=function(){this.menu.show()};Constr.prototype.deactivate=function(){this.menu.hide()};Constr.prototype.closeTag=function(a,c,b){a.getBasePath();var e=this;$.ajax({type:"POST",url:"modules/validate-xml.xql",data:{xml:c,validate:"no"},dataType:"json",
success:function(a){a.status&&"invalid"==a.status&&parseInt(a.message.line)-1<=b&&(a=/element type \"([^\"]+)\"/.exec(a.message["#text"]))&&0<a.length&&e.editor.insert(a[1]+">")},error:function(){}})};Constr.prototype.validate=function(a,c,b){var e=this;$.ajax({type:"POST",url:"modules/validate-xml.xql",data:{xml:c},dataType:"json",success:function(c){e.compileError(c,a);b.call(this,!0)},error:function(a,c){b.call(this,!0);$.log("Compile error: %s - %s",c,a.responseText)}})};Constr.prototype.compileError=
function(a,c){$.log("Validation returned %o",a);if(a.status&&"invalid"==a.status){var b;b=a.message instanceof Array?a.message:[a.message];for(var e=[],g=0;g<b.length;g++)e.push({row:parseInt(b[g].line)-1,text:b[g]["#text"],type:"error"});this.parent.updateStatus(b[0]["#text"],c.getPath()+"#"+b[0].line);c.getSession().setAnnotations(e)}else this.parent.clearErrors(),this.parent.updateStatus("")};Constr.prototype.suggest=function(a,c,b,e){$.log("Getting suggestions for %s",c);$.ajax({type:"POST",url:"modules/validate-xml.xql",
data:{xml:c,row:b,column:e},dataType:"json",success:function(c){$this.compileError(c,a);onComplete.call(this,!0)},error:function(a,c){onComplete.call(this,!0);$.log("Compile error: %s - %s",c,a.responseText)}})};Constr.prototype.documentSaved=function(a){if(/.*\.xconf$/.test(a.getName())){var c=a.getBasePath();eXide.util.Dialog.input("Apply Configuration?","You have saved a collection configuration file. Would you like to apply it to collection "+c.replace(/^\/db\/system\/config/,"")+" now?",function(){eXide.util.message("Apply configuration and reindex...");
$.ajax({type:"POST",url:"modules/apply-config.xql",data:{collection:a.getBasePath(),config:a.getName()},dataType:"json",success:function(a){a.error?eXide.util.error("Failed to apply configuration: "+a.error):eXide.util.success("Configuration applied.")},error:function(a){eXide.util.error("Failed to apply configuration: "+a.responseText)}})})}};Constr.prototype.selectElement=function(a){var d=this.findStartEndTags(a,!1);if(d.start){for(var f=new b(a.getSession(),d.end.row,d.end.column),e=f.stepForward();e;){if(">"===
e.value){d.end.row=f.getCurrentTokenRow();d.end.column=f.getCurrentTokenColumn()+1;break}e=f.stepForward()}f=new b(a.getSession(),d.start.row,d.start.column);for(e=f.getCurrentToken();e;){if("<"===e.value){d.start.row=f.getCurrentTokenRow();d.start.column=f.getCurrentTokenColumn();break}e=f.stepBackward()}a=this.editor.getSelection();d=new c(d.start.row,d.start.column,d.end.row,d.end.column);a.setSelectionRange(d)}};Constr.prototype.rename=function(a){a=this.findStartEndTags(a,!0);if(a.start){var b=
this.editor.getSelection(),f=new c(a.start.row,a.start.column,a.start.row,a.start.column+a.start.name.length);f.cursor=f.end;b.setSelectionRange(f);b.toOrientedRange();a.end&&(f=new c(a.end.row,a.end.column,a.end.row,a.end.column+a.end.name.length),f.cursor=f.end,b.addRange(f));this.editor.focus()}};Constr.prototype.deleteTags=function(a){var c=this.findStartEndTags(a,!1);if(c.start){var b=this.selectTag(a,c.end);a.getSession().remove(b);b=this.selectTag(a,c.start);a.getSession().remove(b)}};Constr.prototype.findStartEndTags=
function(a){function c(a,b){var e=a.getCurrentTokenColumn();return a.getCurrentTokenRow()==b.row&&b.column>=e&&b.column<=e+a.getCurrentToken().value.length}for(var f=this.editor.getSelection().getRange().start,a=new b(a.getSession(),0,0),e=[],g=!1,h=a.stepForward(),i,j;h;){if("meta.tag.name"===h.type.substring(0,13)){if(g){if(g=e.pop(),i==g||i&&i.stack==e.length||c(a,f)){i=g;j={name:h.value,row:a.getCurrentTokenRow(),column:a.getCurrentTokenColumn()};break}}else h={name:h.value,length:h.value.length,
row:a.getCurrentTokenRow(),column:a.getCurrentTokenColumn(),stack:e.length},e.push(h),c(a,f)&&(i=h);g=!1}else"</"===h.value?g=!0:"/>"===h.value?e.pop():c(a,f)&&(i=e[e.length-1]);h=a.stepForward()}return{start:i,end:j}};Constr.prototype.selectTag=function(a,d){for(var f=new c(d.row,d.column,d.row,d.column),e=new b(a.getSession(),d.row,d.column),g=e.stepForward();g;){if(">"===g.value){f.end.row=e.getCurrentTokenRow();f.end.column=e.getCurrentTokenColumn()+1;break}g=e.stepForward()}e=new b(a.getSession(),
d.row,d.column);for(g=e.getCurrentToken();g;){if("<"===g.value||"</"===g.value){f.start.row=e.getCurrentTokenRow();f.start.column=e.getCurrentTokenColumn();break}g=e.stepBackward()}return f};return Constr}();eXide.namespace("eXide.edit.LessModeHelper");
eXide.edit.LessModeHelper=function(){var b=require("ace/token_iterator").TokenIterator;Constr=function(c){this.parent=c;this.editor=this.parent.editor;this.addCommand("locate",this.locate)};eXide.util.oop.inherit(Constr,eXide.edit.ModeHelper);Constr.prototype.documentSaved=function(c){var a=this,b=c.getText(),f="/exist/"+c.getBasePath().replace(/^\/db\//,"")+"/";(new less.Parser({paths:[f],optimization:3})).parse(b,function(b,d){b?eXide.util.error("Error: "+b.message):a.saveCSS(c,d.toCSS())})};Constr.prototype.saveCSS=
function(c,a){var b=c.getPath().replace(/\.less$/,".css");eXide.util.message("Compiling less file to "+b);$.ajax({url:"store/"+b,type:"PUT",data:a,dataType:"json",contentType:"text/css",success:function(a){"error"==a.status?eXide.util.error(a.message):eXide.util.message(b+" stored.")},error:function(a){eXide.util.error(a.responseText)}})};Constr.prototype.createOutline=function(c,a){for(var d=new b(c.getSession(),0,0),f=d.stepForward();null!=f;){if("paren.lparen"==f.type&&"{"==f.value){for(var f=
[],e=d.getCurrentTokenRow(),g=new b(c.getSession(),e,d.getCurrentTokenColumn()),h;null!=(h=g.stepBackward())&&!(g.getCurrentTokenRow()<e);)f.push(h.value);f=f.reverse().join("");c.functions.push({type:eXide.edit.Document.TYPE_FUNCTION,name:f,source:c.getPath(),signature:f,sort:f,row:d.getCurrentTokenRow(),column:d.getCurrentTokenColumn()});lastVar=""}f=d.stepForward()}a&&a(c)};return Constr}();eXide.namespace("eXide.edit.JavascriptModeHelper");
eXide.edit.JavascriptModeHelper=function(){var b=/^[\$\w\-_]+/,c=require("ace/token_iterator").TokenIterator;Constr=function(a){this.parent=a;this.editor=this.parent.editor;this.addCommand("gotoDefinition",this.gotoDefinition);this.addCommand("locate",this.locate);this.addCommand("gotoSymbol",this.gotoSymbol)};eXide.util.oop.inherit(Constr,eXide.edit.ModeHelper);Constr.prototype.createOutline=function(a,b){for(var f=new c(a.getSession(),0,0),e=f.stepForward();null!=e;)"entity.name.function"==e.type&&
a.functions.push({type:eXide.edit.Document.TYPE_FUNCTION,name:e.value,signature:e.value,sort:e.value,row:f.getCurrentTokenRow(),column:f.getCurrentTokenColumn()}),e=f.stepForward();b&&b(a)};Constr.prototype.gotoSymbol=function(a){for(var c=this,b=[],e=0;e<a.functions.length;e++)item={label:a.functions[e].name,name:a.functions[e].name,type:a.functions[e].type,row:a.functions[e].row},b.push(item);1<b.length&&(a=this.parent.getOffset().left,eXide.util.Popup.position({pageX:a,pageY:20}),eXide.util.Popup.show(b,
function(a){a&&c.editor.gotoLine(a.row+1);c.editor.focus()}))};Constr.prototype.gotoDefinition=function(a){var c=this.editor.getSelection().getSelectionLead();(c=this.getFunctionAtCursor(c))&&this.locate(a,null,c)};Constr.prototype.locate=function(a,c,b){"number"==typeof b?this.editor.gotoLine(b+1):(a=this.parent.outline.findDefinition(a,b))&&a.row&&this.editor.gotoLine(a.row+1)};Constr.prototype.getFunctionAtCursor=function(a){var c=a.row,c=this.editor.getSession().getDisplayLine(c),f=a.column;do f--;
while(0<=f&&c.charAt(f).match(b));f++;for(a=a.column;a<c.length&&c.charAt(a).match(b);)a++;return c.substring(f,a)};return Constr}();eXide.namespace("eXide.edit.CssModeHelper");
eXide.edit.CssModeHelper=function(){var b=require("ace/token_iterator").TokenIterator;Constr=function(c){this.parent=c;this.editor=this.parent.editor;this.addCommand("locate",this.locate);this.addCommand("gotoSymbol",this.gotoSymbol)};eXide.util.oop.inherit(Constr,eXide.edit.ModeHelper);Constr.prototype.createOutline=function(c,a){for(var d=new b(c.getSession(),0,0),f=d.stepForward(),e="";null!=f;)"variable"==f.type||"keyword"==f.type?(0<e.length&&(e+=" "),e+=f.value):"paren.rparen"==f.type?e="":
"paren.lparen"==f.type&&""!==e&&(c.functions.push({type:eXide.edit.Document.TYPE_FUNCTION,name:e,source:c.getPath(),signature:e,sort:e,row:d.getCurrentTokenRow(),column:d.getCurrentTokenColumn()}),e=""),f=d.stepForward();a&&a(c)};Constr.prototype.gotoSymbol=function(c){for(var a=this,b=[],f=0;f<c.functions.length;f++)""!==c.functions[f].name&&(item={label:c.functions[f].name,name:c.functions[f].name,type:c.functions[f].type,row:c.functions[f].row},b.push(item));1<b.length&&(c=this.parent.getOffset().left,
eXide.util.Popup.position({pageX:c,pageY:40}),eXide.util.Popup.show(b,function(c){c&&a.editor.gotoLine(c.row+1)}))};return Constr}();eXide.namespace("eXide.edit.Outline");
eXide.edit.Outline=function(){Constr=function(){this.currentDoc=null;var b=this;$("#outline-filter").keyup(function(){b.filter(this.value)})};Constr.prototype={getTemplates:function(b){for(var b=RegExp("^"+b),c=[],a=0;a<this.templates.length;a++)this.templates[a].name.match(b)&&c.push(this.templates[a]);return c},gotoDefinition:function(b,c){$.each(b.functions,function(a,b){if(c==b.name)return eXide.app.locate(b.type,""==b.source?null:b.source,c),!1})},findDefinition:function(b,c){for(var a=0;a<b.functions.length;a++){var d=
b.functions[a];if(c==d.name)return d}return null},updateOutline:function(b){var c=this;c.currentDoc=b;b.functions=[];var a=b.getModeHelper();null!=a&&a.createOutline(b,function(){c.$outlineUpdate(b)})},clearOutline:function(){$("#outline").empty()},filter:function(b){var c=RegExp(b,"i");$("#outline li a").each(function(){var a=$(this);c.test(a.text())?a.show():a.hide()})},$outlineUpdate:function(b){this.currentDoc==b&&(eXide.app.resize(),b=d3.select("#outline").selectAll("li").data(b.functions,function(c){return c.sort}),
b.enter().append("li").attr("class",function(c){return c.type==eXide.edit.Document.TYPE_FUNCTION?"ace_support.ace_function":"ace_variable"}).append("a").style("opacity",0).attr("title",function(c){return c.signature?c.signature:null}).attr("href",function(c){return"#"+(c.source?c.source:"")}).attr("class",function(c){return(c.type==eXide.edit.Document.TYPE_FUNCTION?"t.function":"t_variable")+" "+("private"===c.visibility?"private":"public")}).text(function(c){return c.type==eXide.edit.Document.TYPE_VARIABLE?
"$"+c.name:c.name}).on("click",function(c){var a=this.hash.substring(1);c.row?eXide.app.locate("function",""==a?null:a,parseInt(c.row)):c.type==eXide.edit.Document.TYPE_FUNCTION?eXide.app.locate("function",""==a?null:a,c.name):eXide.app.locate("variable",""==a?null:a,c.name)}).transition().duration(800).style("opacity",1),b.exit().transition().duration(400).style("opacity",0).remove(),b.sort(function(c,a){var b;if(null==c||null==a)b=-1;else{b=c.sort;var f=a.sort;b=b.toLowerCase();f=f.toLowerCase();
b=b>f?1:b==f?0:-1}return b}))}};return Constr}();eXide.namespace("eXide.edit.XQueryDebuger");
eXide.XQueryDebuger=function(){Constr=function(b,c){this.doc=c;this.count=0;this.session="";this.existURL="xmldb:exist://"+document.location.hostname+":"+document.location.port;this.editor=b};Constr.prototype.init=function(){this.count++;$.log("init "+this.existURL+this.doc.getPath()+" times "+this.count);this.runCommand({action:"init"})};Constr.prototype.stepOver=function(){this.runCommand({action:"step"})};Constr.prototype.stepInto=function(){this.runCommand({action:"step-into"})};Constr.prototype.stepOut=
function(){this.runCommand({action:"step-out"})};Constr.prototype.runCommand=function(b){var c=this;b.session=this.session;b.resource=this.existURL+this.doc.getPath();$.ajax({type:"POST",url:"modules/debuger.xql",data:b,dataType:"json",success:function(a){$.log("response: %o",a);c.session=a.session;c.editor.gotoLine(a.stack[0].lineno);a.context&&a.context.properties&&$.each(a.context.properties,function(a,b){var e=c.getVariable(b);$(e).appendTo($("div#debuger.content tbody#variables"))});eXide.util.message("Good response. Session: "+
c.session)},error:function(a,c){eXide.util.error(a.responseText,"Server Error in session "+c)}})};Constr.prototype.getVariable=function(b){var c=$('<tr><td class="name"></td><td class="type"></td><td class="value"></td></tr>');c.children(".name").append(b.name);c.children(".type").append(b.type);"node"===b.type?c.children(".value").append($('<div id="valueHighLight">'+b.value+"</div>")):c.children(".value").append(b.value);return c};return Constr}();eXide.namespace("eXide.edit.CodeValidator");
eXide.edit.CodeValidator=function(){function b(c){c=c.getModeHelper();return!c||!c.validate?!1:!0}Constr=function(c){this.editor=c;this.inProgress=!1;this.enabled=!0;this.deferred=this.validateTimeout=null};eXide.util.oop.inherit(Constr,eXide.events.Sender);Constr.prototype.triggerDelayed=function(c){if(this.enabled&&b(c)&&c.needsValidation()){var a=this,d=(new Date).getTime();this.validateTimeout&&700>d-c.lastChangeEvent&&clearTimeout(this.validateTimeout);this.deferred=$.Deferred();this.validateTimeout=
setTimeout(function(){a.triggerNow.apply(a,[c])},700)}};Constr.prototype.triggerNow=function(c){if(!this.enabled||!b(c)||!c.needsValidation())return null;if(this.inProgress)return this.deferred;var a=this;this.deferred||(this.deferred=$.Deferred());this.inProgress=!0;c.getModeHelper().validate(c,c.getText(),function(b){c.lastValidation=(new Date).getTime();a.inProgress=false;a.deferred.resolve([b]);a.deferred=null;$.log("Validation completed: valid = %s",b);a.$triggerEvent("validate",[c]);b&&a.$triggerEvent("documentValid",
[c])});return this.deferred};Constr.prototype.setEnabled=function(b){this.enabled=b};return Constr}();eXide.namespace("eXide.edit.Document");
eXide.edit.Document=function(){Constr=function(b,c,a){this.name=b;this.path=c.replace(/\/{2,}/g,"/");this.mime=null;this.syntax="xquery";this.saved=!1;this.editable=!0;this.functions=[];this.helper=null;this.history=[];this.$session=a;this.externalLink=null;this.lastChangeEvent=(new Date).getTime();this.lastValidation=0;this.ast=null;b=eXide.app.getPreference("softWrap");this.$session.setUseWrapMode(0!=b);0<b?this.$session.setWrapLimitRange(b,b):0>b&&this.$session.setWrapLimitRange(null,null);this.$session.setFoldStyle("markbegin")};
Constr.TYPE_FUNCTION="function";Constr.TYPE_VARIABLE="variable";Constr.TYPE_TEMPLATE="template";Constr.prototype.needsValidation=function(){return this.isNew()&&this.isSaved()?!1:!this.ast||this.lastChangeEvent>this.lastValidation};Constr.prototype.getText=function(){return this.$session.getValue()};Constr.prototype.setText=function(b){this.$session.setValue(b)};Constr.prototype.getName=function(){return this.name};Constr.prototype.getPath=function(){return this.path};Constr.prototype.setPath=function(b){this.path=
b};Constr.prototype.getBasePath=function(){return this.path.replace(/(^.+)\/[^\/]*$/,"$1")};Constr.prototype.getMime=function(){return this.mime};Constr.prototype.setMime=function(b){this.mime=b};Constr.prototype.getSyntax=function(){return this.syntax};Constr.prototype.setSyntax=function(b){this.syntax=b};Constr.prototype.getSession=function(){return this.$session};Constr.prototype.isSaved=function(){return this.saved};Constr.prototype.isNew=function(){return/__new__/.test(this.path)};Constr.prototype.isEditable=
function(){return this.editable};Constr.prototype.isXQuery=function(){return"application/xquery"==this.mime};Constr.prototype.setModeHelper=function(b){this.helper=b};Constr.prototype.getModeHelper=function(){return this.helper};Constr.prototype.addToHistory=function(b){this.history.push(b)};Constr.prototype.getLastLine=function(){return this.history.pop(line)};Constr.prototype.getCurrentLine=function(){return this.$session.getSelection().getSelectionLead().row};Constr.prototype.getLastChanged=function(){return this.lastChangeEvent};
Constr.prototype.getExternalLink=function(){return this.externalLink};return Constr}();eXide.namespace("eXide.edit.Editor");
eXide.edit.Editor=function(){var b=require("ace/virtual_renderer").VirtualRenderer,c=require("ace/editor").Editor,a=require("ace/edit_session").EditSession,d=require("ace/undomanager").UndoManager;require("ace/snippets");var f=require("ace/lib/net");Constr=function(a,d,h){var i=this;i.container=a;i.menubar=d;i.projects=h;i.documents=[];i.activeDoc=null;i.tabCounter=0;i.newDocCounter=0;i.pendingCheck=!1;i.recheck=!1;i.themes={};i.initializing=!0;a=new b(i.container,"ace/theme/eclipse");a.setShowGutter(!0);
this.editor=new c(a);this.editor.setBehavioursEnabled(!0);this.editor.setShowFoldWidgets(!0);this.editor.setFadeFoldWidgets(!1);require("ace/multi_select").MultiSelect(this.editor);eXide.edit.commands.init(i);d.editor=this;this.outline=new eXide.edit.Outline;this.validator=new eXide.edit.CodeValidator(this);this.addEventListener("activate",this.outline,this.outline.updateOutline);this.validator.addEventListener("validate",this.outline,this.outline.updateOutline);this.addEventListener("close",this.outline,
this.outline.clearOutline);this.status=document.getElementById("error-status");$(this.status).click(function(a){a.preventDefault();var b=this.pathname,a=this.hash.substring(1);if(b=i.getDocument(b))i.switchTo(b),i.editor.gotoLine(parseInt(a)+1)});var j=$("#tabs-container");j.css({overflow:"hidden"});j.mousemove(function(a){var b=j.find("ul"),c=j.width(),b=b.find("li:last-child"),b=b[0].offsetLeft+b.outerWidth(),a=(a.pageX-j.offset().left)*(b-c)/c;j.scrollLeft(a)});this.validateTimeout=null;this.validationEnabled=
!0;a=new eXide.edit.XMLModeHelper(i,d);i.modes={xquery:new eXide.edit.XQueryModeHelper(i,d),xml:a,html:a,less:new eXide.edit.LessModeHelper(i),javascript:new eXide.edit.JavascriptModeHelper(i),css:new eXide.edit.CssModeHelper(i),tmsnippet:new eXide.edit.SnippetModeHelper(i)};$("#dialog-goto-line").dialog({modal:!1,autoOpen:!1,height:200,width:300,buttons:{Goto:function(){var a=$(this).find('input[name="row"]').val(),b=$(this).find('input[name="column"]').val();b&&""!=b?i.editor.gotoLine(a,b,!0):i.editor.gotoLine(a,
0,!0);$(this).dialog("close");i.editor.focus()},Cancel:function(){$(this).dialog("close");i.editor.focus()}},open:function(){$(this).find("input[name='row']").val("");$(this).find("input[name='column']").val("");$(this).find("input:first").focus();var a=$(this);a.find("input").keyup(function(b){13==b.keyCode&&a.parent().find(".ui-dialog-buttonpane button:first").trigger("click")})}});this.editor.on("guttermousedown",function(a){!a.getButton()&&"markers"==i.editor.renderer.$gutterLayer.getRegion(a)&&
(a=a.getDocumentPosition().row,i.exec("quickFix",a))});var l=require("ace/ext/emmet");f.loadScript("$shared/resources/scripts/ace/emmet.js",function(){l.setCore(window.emmet);i.editor.setOption("enableEmmet",!0)})};eXide.util.oop.inherit(Constr,eXide.events.Sender);Constr.prototype.init=function(){0==this.documents.length&&this.newDocument(null,"xquery");this.initializing=!1;var a=this.getActiveDocument();this.$triggerEvent("activate",[a])};Constr.prototype.exec=function(){if(this.activeDoc.getModeHelper()){var a=
Array.prototype.slice.call(arguments,1);this.activeDoc.getModeHelper().exec(arguments[0],this.activeDoc,a)}else eXide.util.message("Not supported in this mode.")};Constr.prototype.getActiveDocument=function(){return this.activeDoc};Constr.prototype.getText=function(){return this.activeDoc.getText()};Constr.prototype.newDocument=function(b,c){for(var d=0,f=0;f<this.documents.length;f++)this.documents[f].path.match(/^__new__(\d+)/)&&(d=parseInt(RegExp.$1));d++;f=b&&"string"==typeof b?new a(b):c&&"xquery"===
c?new a('xquery version "3.0";\n\n'):new a("");d=new eXide.edit.Document("new-document "+d,"__new__"+d,f);d.saved=!0;c?d.setSyntax(c):d.setSyntax("text");this.$initDocument(d,!0)};Constr.prototype.newDocumentWithText=function(b,c,d){b=new eXide.edit.Document(d.name,d.path,new a(b));b.editable=d.writable;b.mime=c;b.syntax=eXide.util.mimeTypes.getLangFromMime(c);b.saved=!1;d.line&&(b.addToHistory(d.line),this.editor.gotoLine(d.line));this.$initDocument(b)};Constr.prototype.newDocumentFromTemplate=function(b,
c){if(!c||0==c.length)this.newDocument(null,b);else{var d=this;$.ajax({url:"modules/get-template.xql",type:"POST",data:{template:c},dataType:"text",success:function(c){for(var f=0,g=0;g<d.documents.length;g++)d.documents[g].path.match(/^__new__(\d+)/)&&(f=parseInt(RegExp.$1));f++;c=new a(c);f=new eXide.edit.Document("new-document "+f,"__new__"+f,c);f.setSyntax(b);d.$initDocument(f,!0)}})}};Constr.prototype.openDocument=function(b,c,d,f){d.writable?eXide.util.message("Opening "+d.path):eXide.util.message("Opening "+
d.path+" readonly!");/\.snippet/.test(d.name)&&(c="application/tmsnippet");b=new eXide.edit.Document(d.name,d.path,new a(b));b.editable=d.writable;b.mime=c;b.syntax=eXide.util.mimeTypes.getLangFromMime(c);b.externalLink=f;b.saved=!0;d.line&&(b.addToHistory(d.line),c=b.$session.getSelection(),c.clearSelection(),c.moveCursorTo(d.line,1),b.$session.setScrollTop(d.line));$.log("opening %s, mime: %s, syntax: %s, line: %i",d.name,b.mime,b.syntax,d.line);this.updateStatus("");(d=this.activeDoc.getModeHelper())&&
d.deactivate();this.$initDocument(b)};Constr.prototype.$initDocument=function(a,b){var c=this;c.$setMode(a,b);a.$session.setUndoManager(new d);a.$session.addEventListener("change",function(){a.saved&&(a.saved=!1,c.updateTabStatus(a.path,a));a.lastChangeEvent=(new Date).getTime();c.validator.triggerDelayed(a)});c.addTab(a);c.editor.setSession(a.$session);c.editor.resize();c.editor.focus();a.$session.getDocument().on("change",function(){c.$triggerEvent("change",[c.activeDoc])});a.getModeHelper()&&a.getModeHelper().activate()};
Constr.prototype.setMode=function(a){this.activeDoc.syntax=a;this.$setMode(this.activeDoc,!0)};Constr.prototype.$setMode=function(a,b){var c;switch(a.getSyntax()){case "xquery":c=new (require("eXide/mode/xquery").Mode)(this);c.$id="xquery";a.$session.setMode(c);b&&(a.mime="application/xquery");break;case "xml":c=new (require("eXide/mode/xml").Mode)(this);c.$id="xml";a.$session.setMode(c);b&&(a.mime="application/xml");break;case "html":c=new (require("eXide/mode/html").Mode)(this);c.$id="html";a.$session.setMode(c);
b&&(a.mime="text/html");break;case "javascript":c=new (require("ace/mode/javascript").Mode);c.$id="javascript";a.$session.setMode(c);b&&(a.mime="application/x-javascript");break;case "css":c=new (require("ace/mode/css").Mode);c.$id="css";a.$session.setMode(c);b&&(a.mime="text/css");break;case "text":c=require("ace/mode/text").Mode;a.$session.setMode(new c);b&&(a.mime="text/text");break;case "less":c=new (require("ace/mode/less").Mode);c.$id="less";a.$session.setMode(c);b&&(a.mime="application/less");
break;case "tmsnippet":c=require("ace/mode/snippets").Mode;a.$session.setUseSoftTabs(!1);a.$session.setMode(new c);b&&(a.mime="application/tmsnippet");break;case "json":c=require("ace/mode/json").Mode;a.$session.setUseSoftTabs(!1);a.$session.setMode(new c);b&&(a.mime="application/json");break;case "markdown":c=require("ace/mode/markdown").Mode,a.$session.setMode(new c),b&&(a.mime="text/x-markdown")}eXide.util.Snippets.init(a.getSyntax());(c=this.modes[a.getSyntax()])||(c=new eXide.edit.ModeHelper(this));
a.setModeHelper(c)};Constr.prototype.closeDocument=function(){this.$triggerEvent("close",[this.activeDoc]);$('#tabs a[title="'+this.activeDoc.path+'"]').parent().remove();this.menubar.remove("buffers",this.activeDoc.path);for(var a=0;a<this.documents.length;a++)this.documents[a].path==this.activeDoc.path&&this.documents.splice(a,1);0==this.documents.length?this.newDocument(null,"xquery"):(this.activeDoc=this.documents[this.documents.length-1],$('#tabs a[title="'+this.activeDoc.path+'"]').addClass("active"),
this.editor.setSession(this.activeDoc.$session),this.editor.resize(),this.$triggerEvent("activate",[this.activeDoc]))};Constr.prototype.saveDocument=function(a,c,b){var d=this,f=d.activeDoc.path,l=d.activeDoc.name;a&&(d.activeDoc.path=a.path,d.activeDoc.name=a.name);eXide.util.message("Storing resource "+d.activeDoc.name+"...");$.ajax({url:"store"+d.activeDoc.path,type:"PUT",data:d.activeDoc.getText(),dataType:"json",contentType:d.activeDoc.mime?d.activeDoc.mime:"application/octet-stream",success:function(a){if(a.status==
"error"){d.activeDoc.path=f;d.activeDoc.name=l;b?b.apply(d.activeDoc,[a.message]):eXide.util.error(a.message)}else{d.activeDoc.saved=true;d.activeDoc.externalLink=a.externalLink;d.updateTabStatus(f,d.activeDoc);c?c.apply(d.activeDoc):eXide.util.success(d.activeDoc.name+" stored.");(a=d.activeDoc.getModeHelper())&&a.documentSaved(d.activeDoc);d.$triggerEvent("saved",[d.activeDoc])}},error:function(a){d.activeDoc.path=f;d.activeDoc.name=l;b?b.apply(d.activeDoc,a.responseText):eXide.util.error(a.responseText)}})};
Constr.prototype.reload=function(a){this.activeDoc.getSession().setValue(a);this.activeDoc.saved=!0;this.updateTabStatus(this.activeDoc.path,this.activeDoc)};Constr.prototype.getDocument=function(a){for(var a=eXide.util.normalizePath(a),b=0;b<this.documents.length;b++)if(this.documents[b].path==a)return this.documents[b];return null};Constr.prototype.onInput=function(a,b){var c=a.getModeHelper();if(c&&c.onInput)c.onInput(a,b)};Constr.prototype.autocomplete=function(a){var b=this.activeDoc.getModeHelper();
return b&&b.autocomplete?b.autocomplete(this.activeDoc,a):!1};Constr.prototype.getHeight=function(){return $("#fullscreen").height()};Constr.prototype.getWidth=function(){return $(this.container).width()};Constr.prototype.getOffset=function(){return $(this.container).offset()};Constr.prototype.resize=function(){this.editor.resize()};Constr.prototype.clearErrors=function(){this.editor.getSession().clearAnnotations()};Constr.prototype.forEachDocument=function(a){for(var b=0;b<this.documents.length;b++)a(this.documents[b])};
Constr.prototype.gotoLine=function(){$("#dialog-goto-line").dialog("open");$("#dialog-goto-line input[type='text']").val("");$('#dialog-goto-line input[name="row"]').focus()};Constr.prototype.addTab=function(a){var b=this,c="t"+b.tabCounter++,d=a.name;16<d.length&&(d=d.substring(0,13)+"...");a.saved||(d+="*");$("#tabs li a").removeClass("active");var f=document.createElement("li"),l=document.createElement("a");l.appendChild(document.createTextNode(d));l.className="tab active";l.id=c;l.title=a.path;
f.appendChild(l);$("#tabs").append(f);$(l).click(function(c){c.preventDefault();b.switchTo(a)});b.menubar.add("buffers",d,l.title,function(){b.switchTo(a)});b.activeDoc=a;b.documents.push(a);b.initializing||b.$triggerEvent("activate",[a]);b.scrollToTab($(l))};Constr.prototype.selectTab=function(){for(var a=this,b=[],c=0;c<this.documents.length;c++)item={label:this.documents[c].name,pos:c},b.push(item);1<b.length&&(c=this.getOffset().left,eXide.util.Popup.position({pageX:c,pageY:40}),eXide.util.Popup.show(b,
function(b){b&&a.switchTo(a.documents[b.pos])}))};Constr.prototype.switchTo=function(a){var b=this.activeDoc.getModeHelper();b&&b.deactivate();this.editor.setSession(a.$session);this.editor.resize();this.activeDoc=a;var c=this;$("#tabs a").each(function(){var b=$(this);this.title==a.path?(b.addClass("active"),c.scrollToTab(b)):b.removeClass("active")});this.updateStatus("");this.$triggerEvent("activate",[a]);(b=a.getModeHelper())&&b.activate();this.activeDoc.ast||this.validator.triggerNow(this.activeDoc)};
Constr.prototype.updateTabStatus=function(a,b){var c;c=b.saved?b.name:b.name+"*";$('#tabs a[title="'+a+'"]').attr("title",b.path).text(c)};Constr.prototype.scrollToTab=function(a){var b=a.offset().left,a=b+a.outerWidth(),c=$("#tabs-container").innerWidth(),d=$("#tabs-container").scrollLeft();a>c?$("#tabs-container").scrollLeft(a-c):b<d&&(b<c?$("#tabs-container").scrollLeft(0):$("#tabs-container").scrollLeft(b));$.log("Scrolling to %d %d",b,$("#tabs-container").scrollLeft())};Constr.prototype.setTheme=
function(a){$.log("Changing theme to %s",a);var b=this;b.loadTheme(a,function(){b.editor.setTheme("ace/theme/"+a);b.$triggerEvent("setTheme",[require(b.editor.getTheme())])})};Constr.prototype.loadTheme=function(a,b){if(this.themes[a])return b();require("ace/lib/net");this.themes[a]=1;var c="$shared/resources/scripts/ace/theme-"+a.split("/").pop()+".js",d=document.getElementsByTagName("head")[0],f=document.createElement("script");f.src=c;d.appendChild(f);f.onload=b};Constr.prototype.updateStatus=
function(a,b){this.status.innerHTML=a;b&&(this.status.href=b)};Constr.prototype.evalError=function(a,b){var c=/.*line\s(\d+)/i.exec(a),d=-1;c&&(d=parseInt(c[1]));b&&(this.editor.focus(),this.editor.gotoLine(d));c=[{row:d-1,text:a,type:"error"}];this.updateStatus(a);this.editor.getSession().setAnnotations(c)};Constr.prototype.focus=function(){this.editor.focus()};Constr.prototype.saveState=function(){var a=0;$.each(this.documents,function(b,c){if(c.path.match("^__new__.*")){var d=c.getText();d&&0<
d.length&&(localStorage["eXide."+a+".path"]=c.path,localStorage["eXide."+a+".name"]=c.name,localStorage["eXide."+a+".mime"]=c.mime,localStorage["eXide."+a+".data"]=c.getText(),localStorage["eXide."+a+".last-line"]=c.getCurrentLine())}else localStorage["eXide."+a+".path"]=c.path,localStorage["eXide."+a+".name"]=c.name,localStorage["eXide."+a+".mime"]=c.mime,localStorage["eXide."+a+".writable"]=c.editable?"true":"false",localStorage["eXide."+a+".last-line"]=c.getCurrentLine(),c.saved||(localStorage["eXide."+
a+".data"]=c.getText());a++});localStorage["eXide.documents"]=a};return Constr}();eXide.namespace("eXide.edit.Projects");
eXide.edit.Projects=function(){Constr=function(){this.projects={}};Constr.prototype.findProject=function(b,c){var a=this.getProjectFor(b);a?c(a):this.getProject(b,c)};Constr.prototype.getProject=function(b,c){var a=this;$.getJSON("modules/deployment.xql",{info:b},function(b){if(b){var f=a.projects[b.abbrev];f?eXide.util.oop.extend(f,b):(f=b,a.projects[b.abbrev]=f);"function"==typeof c&&c(f)}else"function"==typeof c&&c(null)})};Constr.prototype.getProjectFor=function(b){for(k in this.projects){var c=
this.projects[k];if(b.substring(0,c.root.length)===c.root)return c}return null};Constr.prototype.saveState=function(){localStorage["eXide.projects"]=JSON.stringify(this.projects)};Constr.prototype.restoreState=function(){var b=this;localStorage["eXide.projects"]&&(this.projects=JSON.parse(localStorage["eXide.projects"]),"object"!=typeof this.projects&&(this.projects={}));$.each(this.projects,function(){this.root&&b.getProject(this.root)})};return Constr}();eXide.namespace("eXide.edit.PackageEditor");
eXide.edit.PackageEditor=function(){Constr=function(b){var c=this;this.projects=b;this.currentProject=null;this.container=$("#dialog-deploy");this.container.dialog({appendTo:"#layout-container",title:"Deployment Editor",modal:!1,autoOpen:!1,width:520,height:600});this.syncDialog=$("#synchronize-dialog");this.syncDialog.dialog({appendTo:"#layout-container",title:"Synchronize to Directory",modal:!1,autoOpen:!1,width:500,height:440,buttons:{Apply:function(){var a=c.syncDialog.find('input[name="dir"]').val();
a&&0<a.length&&(c.currentProject.dir=a);c.currentProject.autoSync=c.syncDialog.find('input[name="auto"]').is(":checked");$(this).dialog("close")},Synchronize:function(){var a=c.syncDialog.find('input[name="dir"]').val();!a||0==a.length?$("#synchronize-report").text("No output directory specified!"):(c.currentProject.dir=a,a=c.syncDialog.find("form").serialize(),$("#synchronize-report").text("Synchronization in progress ..."),$("#synchronize-report").load("modules/synchronize.xql",a))},Close:function(){$(this).dialog("close")}}});
this.gitCheckoutDialog=$("#dialog-git-checkout");this.gitCheckoutDialog.dialog({appendTo:"#layout-container",title:"Git Checkout",modal:!1,autoOpen:!1,width:500,height:240,buttons:{"Switch Branch":function(){var a=$("[name='git-checkout']",c.gitCheckoutDialog.find("form")).val();eXide.app.git.command(c.currentProject,"checkout",a,function(){$("#toolbar-current-branch").text(a);$("#menu-git-active").text(a)});$(this).dialog("close")},Cancel:function(){$(this).dialog("close")}}});this.gitCommitDialog=
$("#dialog-git-commit");this.gitCommitDialog.dialog({appendTo:"#layout-container",title:"Synchonize and Commit",modal:!1,autoOpen:!1,width:500,height:360,buttons:{"Sync and Commit":function(){var a=c.gitCommitDialog.find("form"),b=$("[name='git-commit-title']",a).val(),f=$("[name='git-commit-desc']",a).val(),e=b+"\n\n"+f,a=$("[name='start']",a).val();!b||0==b.length?$("#git-commit-status").text("title for commit message is required"):($("#git-commit-status").text("Synchronization in progress ..."),
$("#git-commit-status").load("modules/synchronize.xql",{collection:c.currentProject.root,start:a},function(a,b){"success"==b&&eXide.app.git.command(c.currentProject,"commit",e)}),$(this).dialog("close"))},Cancel:function(){$(this).dialog("close")}}})};eXide.util.oop.inherit(Constr,eXide.events.Sender);Constr.prototype.open=function(b){var c=this,a=null;b&&(a={collection:b});$.ajax({url:"modules/deployment.xql",type:"POST",data:a,success:function(a){c.container.html(a);c.container.form({done:function(){var a=
c.container.find("form").serialize();$.ajax({url:"modules/deployment.xql",type:"POST",dataType:"json",data:a,success:function(a){c.container.dialog("close");c.$triggerEvent("change",[a])},error:function(a){eXide.util.error(a.responseText)}})},cancel:function(){c.container.dialog("close")}});c.container.find(".author-repeat").repeat("#author-add-trigger",{deleteTrigger:"#author-remove-trigger"});c.container.dialog("open")},error:function(a){eXide.util.error(a.responseText)}})};Constr.prototype.deploy=
function(b){var c=this;eXide.util.Dialog.input("Deploy",'<p>Note: target has to be different from the source package or it will be overwritten!</p><p><label for="target">Target collection:</label><input id="deployment-target" type="text" name="target" value="'+b+'-test"size="30"/></p>',function(){var a=$("#deployment-target").val();""===a&&(a=b);$.ajax({url:"modules/deployment.xql",type:"POST",dataType:"json",data:{collection:b,target:a,deploy:"true"},success:function(a){a=location.protocol+"//"+
location.hostname+":"+location.port+"/exist/apps/"+a+"/";eXide.util.Dialog.message("Application Deployed",'<p>The application has been deployed. On a standard installation the following link should open it:</p><center><a href="'+a+'" target="_new">'+a+"</a></center>");c.$triggerEvent("change",b)},error:function(a){404==a.status?eXide.util.error("Deployment failed. The document currently opened in the editor should belong to an application package."):eXide.util.Dialog.warning("Deployment Error","<p>An error has been reported by the database:</p><p>"+
a.responseText+"</p>")}})})};Constr.prototype.download=function(b){window.location.href="modules/deployment.xql?download=true&collection="+encodeURIComponent(b)};Constr.prototype.synchronize=function(b){var c=this;c.projects.findProject(b,function(a){a?eXide.app.login.isAdmin?($("#synchronize-report").empty(),c.currentProject=a,c.syncDialog.find(".project-name").text(a.abbrev),c.syncDialog.find('input[name="start"]').val(a.deployed),a.dir?c.syncDialog.find('input[name="dir"]').val(a.dir):c.syncDialog.find('input[name="dir"]').val(""),
c.syncDialog.find('input[name="collection"]').val(a.root),c.syncDialog.find('input[name="auto"]').attr("checked",a.autoSync),c.syncDialog.dialog("open")):eXide.util.error("You need to be logged in as an admin user with dba role to use this feature."):eXide.util.error("Application not found: The document currently opened in the editor should belong to an application package.")})};Constr.prototype.autoSync=function(b){(b=this.projects.getProjectFor(b))&&b.autoSync&&$.ajax({url:"modules/synchronize.xql",
type:"GET",data:{collection:b.root,start:b.deployed,dir:b.dir},success:function(){eXide.util.message("Synchronized directory")}})};Constr.prototype.runApp=function(b){this.projects.findProject(b,function(b){if(b){var a="/exist"+b.url.replace(/\/{2,}/,"/")+"/";eXide.util.Dialog.message("Run Application "+b.abbrev,'<p>Click on the following link to open your application:</p><center><a href="'+a+'" target="_new">'+a+"</a></center>")}else eXide.util.error("Application not found: The document currently opened in the editor should belong to an application package.")})};
Constr.prototype.saveState=function(){this.projects.saveState()};Constr.prototype.restoreState=function(){this.projects.restoreState()};Constr.prototype.gitCheckout=function(b){var c=this;c.projects.findProject(b,function(a){a?eXide.app.login.isAdmin?(c.currentProject=a,a=d3.select("#git-checkout-select").selectAll("option").data(a.gitBranch).attr("value",function(a){return a}).text(String),a.enter().append("option").attr("value",function(a){return a}).text(String),a.exit().remove(),c.gitCheckoutDialog.dialog("open")):
eXide.util.error("You need to be logged in as an admin user with dba role to use this feature."):eXide.util.error("Application not found: The document currently opened in the editor should belong to an application package.")})};Constr.prototype.gitCommit=function(b){var c=this;c.projects.findProject(b,function(a){a?eXide.app.login.isAdmin?(c.currentProject=a,c.gitCommitDialog.dialog("open")):eXide.util.error("You need to be logged in as an admin user with dba role to use this feature."):eXide.util.error("Application not found: The document currently opened in the editor should belong to an application package.")})};
return Constr}();eXide.namespace("eXide.util.Menubar");
eXide.util.Menubar=function(){Constr=function(b){var c=this;this.container=b;this.editor=null;this.commands={};var a=!1;$("ul li>a",this.container).click(function(){var b=$(this),f=$("ul li>a.open",c.container);0<f.length?(f.removeClass("open"),f.next("ul").fadeOut(100,function(){b.addClass("open");b.next("ul").fadeIn(100)})):(b.addClass("open"),b.next("ul").fadeIn(200));a=!0;return!1});$("body").click(function(){a&&($("ul li ul",c.container).fadeOut(100),$("ul li>a",c.container).removeClass("open"))})};
Constr.prototype.commandPalette=function(){var b=[],c;for(c in this.commands)b.push(this.commands[c]);1<b.length&&(c=this.editor.getOffset().left,eXide.util.Popup.position({pageX:c,pageY:40}),eXide.util.Popup.show(b,function(a){a&&(a.callback(),$this.editor&&$this.editor.focus())}))};Constr.prototype.click=function(b,c,a){var d=this,b=$(b),f=b.text();a||(a=b.attr("data-command"));if(a){var e=eXide.edit.commands.getShortcut(a);e&&(e=e.replace(/Command/g,String.fromCharCode(8984)),e=e.replace(/Shift/g,
String.fromCharCode(8679)),e=e.replace(/Option/g,String.fromCharCode(8997)),e=e.replace(/Control/g,"^"),b.each(function(){var a=document.createElement("span");a.className="shortcut";a.appendChild(document.createTextNode(e));this.appendChild(a)}))}b.attr("id")&&(d.commands[b.attr("id")]={label:[f,b.find(".shortcut").text()],callback:c});b.click(function(a){a.preventDefault();c();d.editor&&d.editor.focus();$("ul li ul",d.container).fadeOut(100);$("ul li>a",d.container).removeClass("open")})};Constr.prototype.add=
function(b,c,a,d){var f=this,b=$(this.container).find('ul li[title="'+b+'"]'),e=b.find("ul");e.append($('<li><a href="#" title="'+a+'">'+c+"</a></li>"));e.find("li:last-child a").click(function(a){a.preventDefault();e.fadeOut(100);$("ul li>a",f.container).removeClass("open");d();f.editor&&f.editor.focus()})};Constr.prototype.remove=function(b,c){b=$(this.container).find('ul li[title="'+b+'"]');b.find('ul li a[title = "'+c+'"]').remove()};return Constr}();eXide.namespace("eXide.util.Help");
eXide.util.Help=function(){var b=null,c=-1;$(document).ready(function(){$(document.body).append('<div id="eXide-dialog-help">\t<div class="help" id="eXide-dialog-help-body"></div></div>');helpDialog=$("#eXide-dialog-help");helpDialog.dialog({appendTo:"#layout-container",modal:!1,title:"Quick Start",autoOpen:!1,width:600,height:400,buttons:{OK:function(){$(this).dialog("close")},Next:function(){eXide.util.Help.next()},Previous:function(){eXide.util.Help.previous()}}})});return{show:function(){helpDialog.dialog("open");
b?eXide.util.Help.next():eXide.util.Help.load()},next:function(){c+1<b.length&&(c++,$("#eXide-dialog-help-body").html(b[c]))},previous:function(){0<c&&(c--,$("#eXide-dialog-help-body").html(b[c]))},showFirstTime:function(){if(eXide.util.supportsHtml5Storage){var a=localStorage.getItem("eXide.hints");(!a||1==a)&&eXide.util.Help.show()}},load:function(){$.ajax({url:"help.html",type:"GET",success:function(a){b=$("section",a);eXide.util.Help.show()},error:function(a){404==a.status?eXide.util.error("Failed to open help texts."):
eXide.util.Dialog.warning("Deployment Error","<p>An error has been reported by the database:</p><p>"+a.responseText+"</p>");helpDialog.dialog("close")}})}}}();eXide.namespace("eXide.util.Preferences");
eXide.util.Preferences=function(){var b={theme:"tomorrow",fontSize:14,font:"Default",showInvisibles:!1,showPrintMargin:!0,showHScroll:!1,indent:-1,indentSize:4,softWrap:-1};Constr=function(c){this.editor=c;this.preferences=$.extend({},b);var a=this,d=$("#preferences-dialog");$("select, input",d).change(function(){a.updatePreferences()});$("#preferences-dialog").dialog({appendTo:"#layout-container",title:"Preferences",modal:!1,autoOpen:!1,height:400,width:600,buttons:{Close:function(){$(this).dialog("close");
c.focus()},"Reset Defaults":function(){a.preferences=$.extend({},b);a.updateForm()}}})};Constr.prototype.show=function(){this.updateForm();$("#preferences-dialog").dialog("open")};Constr.prototype.updateForm=function(){var b=$("#preferences-dialog form");$('select[name="theme"]',b).val(this.preferences.theme);$('select[name="font-size"]',b).val(this.preferences.fontSize);$('select[name="font"]',b).val(this.preferences.font);$('input[name="show-invisibles"]',b).attr("checked",this.preferences.showInvisibles);
$('input[name="print-margin"]',b).attr("checked",this.preferences.showPrintMargin);var a=this.preferences.indent,d=this.preferences.indentSize;0===a?a="Tabs":-1===a&&(a="Spaces");$('select[name="indent"]',b).val(a);$('select[name="indent-size"]',b).val(d);a=this.preferences.softWrap;0===a?a="off":-1===a&&(a="free");$('input[name="soft-wrap"]',b).val(a)};Constr.prototype.updatePreferences=function(){var b=$("#preferences-dialog form");this.preferences.theme=$('select[name="theme"]',b).val();this.preferences.fontSize=
parseInt($('select[name="font-size"]',b).val());this.preferences.font=$('select[name="font"]',b).val();this.preferences.showInvisibles=$('input[name="show-invisibles"]',b).is(":checked");this.preferences.showPrintMargin=$('input[name="print-margin"]',b).is(":checked");var a=$('select[name="indent"]',b).val(),d=parseInt($('select[name="indent-size"]',b).val(),10);"Spaces"===a?a=-1:"Tabs"===a&&(a=0);this.preferences.indent=parseInt(a,10);this.preferences.indentSize=parseInt(d,10);b=$('select[name="soft-wrap"]',
b).val();"free"===b?b=-1:"off"===b&&(b=0);this.preferences.softWrap=parseInt(b,10);this.applyPreferences()};Constr.prototype.applyPreferences=function(){var b=this;this.editor.setTheme(this.preferences.theme);this.editor.editor.setShowInvisibles(this.preferences.showInvisibles);this.editor.editor.setShowPrintMargin(this.preferences.showPrintMargin);this.editor.forEachDocument(function(a){0<b.preferences.softWrap?a.getSession().setWrapLimitRange(b.preferences.softWrap,b.preferences.softWrap):0>b.preferences.softWrap&&
a.getSession().setWrapLimitRange(null,null);a.getSession().setUseWrapMode(0!=b.preferences.softWrap);0>b.preferences.indent?(a.getSession().setTabSize(b.preferences.indentSize),a.getSession().setUseSoftTabs(!0)):0<=b.preferences.indent&&a.getSession().setUseSoftTabs(!1)});if(this.preferences.font){var a=this.preferences.font+", monospace";$("#editor").css("font-family",a);$("#outline").css("font-family",a);$("#results-body").css("font-family",a)}this.editor.editor.setFontSize(this.preferences.fontSize+
"px");this.editor.resize()};Constr.prototype.get=function(b){return this.preferences[b]};Constr.prototype.read=function(){localStorage["eXide.preferences"]&&(this.preferences=JSON.parse(localStorage.getItem("eXide.preferences")));this.applyPreferences()};Constr.prototype.save=function(){localStorage.setItem("eXide.preferences",JSON.stringify(this.preferences));localStorage.setItem("eXide.firstTime",0)};return Constr}();$(document).ready(function(){window.name="eXide";var b;var c=window.location.search.substr(1).split("&");if(""==c)b={};else{for(var a={},d=0;d<c.length;++d){var f=c[d].split("=");2==f.length&&(a[f[0]]=decodeURIComponent(f[1].replace(/\+/g," ")))}b=a}eXide.app.init(function(){var a=b.snip;b.open?eXide.app.findDocument(b.open):a&&eXide.app.newDocument(a,"xquery");window.opener&&window.opener.eXide_onload&&window.opener.eXide_onload(eXide.app)})});eXide.namespace("eXide.app");
eXide.app=function(){var b,c,a,d,f,e,g={},h,i=null,j=0,l=0,n=0,o=0,p=!0,s="south",z={html:1,javascript:1,css:1,less:1},u=function(a){eXide.util.error("Failed to apply configuration: "+a.responseText)};return{init:function(c){Modernizr.flexbox?(f=new eXide.edit.Projects,h=new eXide.util.Menubar($(".menu")),b=new eXide.edit.Editor(document.getElementById("editor"),h),a=new eXide.edit.PackageEditor(f),d=new eXide.browse.Browser(document.getElementById("open-dialog")),a.addEventListener("change",null,
function(a){d.changeToCollection(a);eXide.app.openDocument()}),e=new eXide.util.Preferences(b),b.addEventListener("setTheme",eXide.app.setTheme),eXide.app.initGUI(h),eXide.app.getLogin(function(){eXide.app.initStatus("Restoring state");eXide.app.restoreState(function(a){b.init();c&&c(a);eXide.configuration.allowGuest?$("#splash").fadeOut(400):eXide.app.requireLogin(function(){$("#splash").fadeOut(400)})})}),b.addEventListener("outlineChange",eXide.app.onOutlineChange),b.validator.addEventListener("documentValid",
function(a){a.isXQuery()&&$("#live-preview").is(":checked")&&eXide.app.runQuery(a.getPath(),!0)}),b.addEventListener("saved",function(a){$("#live-preview").is(":checked")&&z[a.getSyntax()]&&document.getElementById("results-iframe").contentDocument.location.reload(!0)}),$(window).unload(function(){eXide.app.saveState()}),eXide.find.Modules.addEventListener("open",null,function(a){eXide.app.findDocument(a.at)}),eXide.find.Modules.addEventListener("import",null,function(a){b.exec("importModule",a.prefix,
a.uri,a.at)})):$("#startup-error").show()},hasFocus:function(){return p},getEditor:function(){return b},getMenu:function(){return h},resize:function(a){$("#editor");if(a){var a=$(".panel-"+s),c=$("#results-body");$("#results-iframe").width(c.innerWidth());$("#results-iframe").height(a.innerHeight()-$(".navbar",a).height()-8);$("#results-body").height(a.innerHeight()-$(".navbar",a).height()-8)}b.resize()},newDocument:function(a,c){b.newDocument(a,c)},newDocumentFromTemplate:function(){$("#dialog-templates").dialog("open")},
findDocument:function(a,c){var d=b.getDocument(a);null==d?(d={name:a.match(/[^\/]+$/)[0],path:a},eXide.app.$doOpenDocument(d,function(){c&&b.editor.gotoLine(c)})):(b.switchTo(d),c&&b.editor.gotoLine(c))},locate:function(a,c,d){if(null==c)b.exec("locate",a,d);else{var e=b.getDocument(c);null==e?(c={name:c.match(/[^\/]+$/)[0],path:c},eXide.app.$doOpenDocument(c,function(c){c&&b.exec("locate",a,d)})):(b.switchTo(e),b.exec("locate",a,d))}},openDocument:function(){d.reload(["reload"],"open");$("#open-dialog").dialog("option",
"title","Open Document");$("#open-dialog").dialog("option","buttons",{cancel:function(){$(this).dialog("close");b.focus()},open:eXide.app.openSelectedDocument});$("#open-dialog").dialog("open")},openSelectedDocument:function(a){var b=d.getSelection();b&&eXide.app.$doOpenDocument(b);(void 0==a||a)&&$("#open-dialog").dialog("close")},$doOpenDocument:function(a,c,d){a.path=eXide.util.normalizePath(a.path);var e=b.getDocument(a.path);if(e&&!d)return b.switchTo(e),c&&c(a),!0;$.ajax({url:"modules/load.xql?path="+
a.path,dataType:"text",success:function(e,f,g){d?b.reload(e):(f=eXide.util.mimeTypes.getMime(g.getResponseHeader("Content-Type")),g=g.getResponseHeader("X-Link"),b.openDocument(e,f,a,g));c&&c(a);return!0},error:function(b){eXide.util.error("Failed to load document "+a.path+": "+b.status+" "+b.statusText);c&&c(null);return!1}})},reloadDocument:function(){var a=b.getActiveDocument();a.isSaved()?eXide.app.$reloadDocument(a):eXide.util.Dialog.input("Reload Document","Do you really want to reload the document?",
function(){eXide.app.$reloadDocument(a)})},$reloadDocument:function(a){a={name:a.getName(),path:a.getPath()};eXide.app.$doOpenDocument(a,null,!0)},closeDocument:function(){b.getActiveDocument().isSaved()?b.closeDocument():$("#dialog-confirm-close").dialog({appendTo:"#layout-container",resizable:!1,height:140,modal:!0,buttons:{Close:function(){$(this).dialog("close");b.closeDocument()},Cancel:function(){$(this).dialog("close")}},open:function(){$(this).closest(".ui-dialog").find(".ui-dialog-buttonpane button:eq(0)").focus();
$(this).closest(".ui-dialog").find(".ui-dialog-buttonpane button:eq(1)").blur()}})},saveDocument:function(){eXide.app.requireLogin(function(){b.getActiveDocument().getPath().match("^__new__")?(d.reload(["reload","create"],"save"),$("#open-dialog").dialog("option","title","Save Document"),$("#open-dialog").dialog("option","buttons",{Cancel:function(){$(this).dialog("close")},Save:function(){b.saveDocument(d.getSelection(),function(){$("#open-dialog").dialog("close");a.autoSync(b.getActiveDocument().getBasePath());
eXide.app.updateStatus(this)},function(a){eXide.util.Dialog.warning("Failed to Save Document",a)})}}),$("#open-dialog").dialog("open")):b.saveDocument(null,function(){eXide.util.message(b.getActiveDocument().getName()+" stored.");a.autoSync(b.getActiveDocument().getBasePath())},function(a){eXide.util.Dialog.warning("Failed to Save Document",a)})})},saveDocumentAs:function(){eXide.app.requireLogin(function(){d.reload(["reload","create"],"save");$("#open-dialog").dialog("option","title","Save Document As ...");
$("#open-dialog").dialog("option","buttons",{Cancel:function(){$(this).dialog("close")},Save:function(){b.saveDocument(d.getSelection(),function(){$("#open-dialog").dialog("close");a.autoSync(b.getActiveDocument().getBasePath());eXide.app.updateStatus(this)},function(a){eXide.util.Dialog.warning("Failed to Save Document",a)})}});$("#open-dialog").dialog("open")})},exec:function(){b.exec(arguments)},download:function(){var a=b.getActiveDocument();a.getPath().match("^__new__")||!a.isSaved()?eXide.util.error("There are unsaved changes in the document. Please save it first."):
window.location.href="modules/load.xql?download=true&path="+encodeURIComponent(a.getPath())},runQuery:function(a,c){function d(){b.updateStatus("");b.clearErrors();eXide.app.showResultsPanel();n=l=1}if(!eXide.configuration.allowExecution&&!eXide.app.login.isAdmin)eXide.util.error("You are not allowed to execute XQuery code.");else if(!a&&"html"==b.getActiveDocument().getSyntax()){d();var e=document.getElementById("results-iframe");$(e).show();e.src=b.getActiveDocument().getExternalLink();$("#serialization-mode").attr("disabled",
"disabled").val("html")}else{e=b.getText();if(a)if(e=b.getDocument(a))e=e.$session.getValue();else return;else i=b.getActiveDocument().getPath();b.updateStatus("Running query ...");$("#serialization-mode").removeAttr("disabled");var f=$("#serialization-mode").val(),g="xmldb:exist://"+b.getActiveDocument().getBasePath();$(".results-container .results").empty();$.ajax({type:"POST",url:"execute",dataType:"xml"==f?f:"text",data:{qu:e,base:g,output:f},success:function(a){switch(f){case "xml":$("#results-iframe").hide();
a=a.documentElement;"error"==a.nodeName?(a=$(a).text(),b.evalError(a,!c)):(d(),j=a.getAttribute("hits"),o=l+10-1,j<o&&(o=j),eXide.util.message("Found "+j+" in "+a.getAttribute("elapsed")+"s"),eXide.app.retrieveNext());break;default:d();var e=document.getElementById("results-iframe");$(e).show();e.contentWindow.document.open("text/html","replace");e.contentWindow.document.write(a);e.contentWindow.document.close()}},error:function(a){eXide.util.error(a.responseText,"Server Error")}})}},checkQuery:function(){b.validator.triggerNow(b.getActiveDocument())},
retrieveNext:function(){$.log("retrieveNext: %d",n);if(0<n&&n<=o){var a="results/"+n;n++;$.ajax({url:a,dataType:"html",success:function(a){$(".results-container .results").append(a);$(".results-container .current").text("Showing results "+l+" to "+(n-1)+" of "+j);$(".results-container .pos:last a").click(function(){eXide.app.findDocument($(this).data("path"));return!1});eXide.app.retrieveNext()}})}},browseNext:function(){0<n&&o<j&&(l=n,o=n+10-1,j<o&&(o=j),$(".results-container .results").empty(),
eXide.app.retrieveNext());return!1},browsePrevious:function(){0<n&&1<l&&(l-=10,1>l&&(l=1),n=l,o=n+9,j<o&&(o=j),$(".results-container .results").empty(),eXide.app.retrieveNext());return!1},manage:function(){eXide.app.requireLogin(function(){d.reload("reload create upload properties open cut copy paste".split(" "),"manage");$("#open-dialog").dialog("option","title","DB Manager");$("#open-dialog").dialog("option","buttons",{Close:function(){$(this).dialog("close")}});$("#open-dialog").dialog("open")})},
deploymentSettings:function(){var c=b.getActiveDocument().getPath(),d=/^(.*)\/[^\/]+$/.exec(c);d&&eXide.app.requireLogin(function(){$.log("Editing deployment settings for collection: %s",d[1]);a.open(d[1])})},newDeployment:function(){eXide.app.requireLogin(function(){a.open()})},deploy:function(){eXide.app.requireLogin(function(){var c=b.getActiveDocument().getPath(),c=/^(.*)\/[^\/]+$/.exec(c);if(!c)return eXide.util.error("The file open in the editor does not belong to an application package!"),
!1;$.log("Deploying application from collection: %s",c[1]);a.deploy(c[1])});return!1},synchronize:function(){eXide.app.requireLogin(function(){var c=b.getActiveDocument().getPath();(c=/^(.*)\/[^\/]+$/.exec(c))?a.synchronize(c[1]):eXide.util.error("The file open in the editor does not belong to an application package!")})},gitCheckout:function(){eXide.app.requireLogin(function(){var c=b.getActiveDocument().getPath();(c=/^(.*)\/[^\/]+$/.exec(c))?a.gitCheckout(c[1]):eXide.util.error("The file open in the editor does not belong to an application package!")})},
gitCommit:function(){eXide.app.requireLogin(function(){var c=b.getActiveDocument().getPath();(c=/^(.*)\/[^\/]+$/.exec(c))?a.gitCommit(c[1]):eXide.util.error("The file open in the editor does not belong to an application package!")})},downloadApp:function(){eXide.app.requireLogin(function(){var c=b.getActiveDocument().getPath(),c=/^(.*)\/[^\/]+$/.exec(c);$.log("downloading %s",c);c?a.download(c[1]):eXide.util.error("The file open in the editor does not belong to an application package!")})},openApp:function(){var c=
b.getActiveDocument().getPath();(c=/^(.*)\/[^\/]+$/.exec(c))?a.runApp(c[1]):eXide.util.error("The file open in the editor does not belong to an application package!")},restoreState:function(d){if(!eXide.util.supportsHtml5Storage)return!1;e.read();c.restoreState();var f={},g=localStorage["eXide.documents"];g||(g=0);for(var h=[],i=0;i<g;i++){var j={path:localStorage["eXide."+i+".path"],name:localStorage["eXide."+i+".name"],writable:"true"==localStorage["eXide."+i+".writable"],line:parseInt(localStorage["eXide."+
i+".last-line"])};if(j.name){$.log("Restoring doc %s, going to line = %i",j.path,j.line);var l=localStorage["eXide."+i+".data"];l?b.newDocumentWithText(l,localStorage["eXide."+i+".mime"],j):h.push(j);f[j.path]=j}}this.restoreDocs(h,function(){b.getActiveDocument()||eXide.app.newDocument("","xquery");b.validator.triggerNow(b.getActiveDocument());d&&d(f)});a.restoreState();return f},restoreDocs:function(a,b){if(0==a.length)b();else{var c=this,d=a.pop();eXide.app.$doOpenDocument(d,function(){c.restoreDocs(a,
b)})}},saveState:function(){eXide.util.supportsHtml5Storage&&(localStorage.clear(),e.save(),c.saveState(),localStorage["eXide.layout.resultPanel"]=s,b.saveState(),a.saveState())},getLogin:function(a){$.ajax({url:"login",dataType:"json",success:function(b){b&&b.user?(eXide.app.login=b,$("#user").text("Logged in as "+eXide.app.login.user+". "),a&&a(eXide.app.login.user)):(eXide.app.login=null,a&&a(null))},error:function(){eXide.app.login=null;$("#user").text("Login");a&&a(null)}})},enforceLogin:function(){eXide.app.requireLogin(function(){(!eXide.app.login||
"guest"===eXide.app.login.user)&&eXide.app.enforceLogin()})},$checkLogin:function(){if(eXide.app.login)return!0;eXide.util.error("Warning: you are not logged in.");return!1},requireLogin:function(a){eXide.app.login?a():($("#login-dialog").dialog("option","close",function(){eXide.app.login?a():eXide.util.error("Warning: you are not logged in!")}),$("#login-dialog").dialog("open"))},showPreferences:function(){e.show()},getPreference:function(a){return e.get(a)},startDebug:function(){var a=$("#debug span.ui-icon");
a.hasClass("ui-icon-stop")?(a.removeClass("ui-icon-stop"),a.addClass("ui-icon-play")):(a.removeClass("ui-icon-play"),a.addClass("ui-icon-stop"));b.exec("debug");$.log("start debugging click")},stepOver:function(){b.exec("stepOver")},stepInto:function(){b.exec("stepInto")},setTheme:function(a){$("#outline-body").removeClass().addClass(a.cssClass);$("#results-body").removeClass().addClass(a.cssClass)},updateStatus:function(a){$("#syntax").val(a.getSyntax());$("#status span").text(eXide.util.normalizePath(a.getPath()));
!a.isNew()&&("xquery"==a.getSyntax()||"html"==a.getSyntax()||"xml"==a.getSyntax())?($("#status a").attr("href",a.getExternalLink()),$("#status a").css("visibility","visible")):$("#status a").css("visibility","hidden")},showResultsPanel:function(){c.show(s);eXide.app.resize(!0)},toggleResultsPanel:function(){eXide.app.resize(!0)},prepareResultsPanel:function(a){$("#results-body").parent().children(":not(.resize-handle)").detach().appendTo(".panel-"+a);$("#results-iframe").hide()},switchResultsPanel:function(){var a=
"south"===s?"east":"south";eXide.app.prepareResultsPanel(a);c.hide(s);s=a;"south"===s?$(".layout-switcher").attr("src","resources/images/layouts_split.png"):$(".layout-switcher").attr("src","resources/images/layouts_split_vertical.png");eXide.app.showResultsPanel()},initStatus:function(a){$("#splash-status").text(a)},git:{branch:function(a){console.info("git.branch");eXide.app.login.isAdmin&&$.ajax({type:"GET",url:"modules/git.xql",data:{target:a.root,"git-command":"branch"},dataType:"json",success:function(b){b=
b.stdout?$.isArray(b.stdout.line)?b.stdout.line:[b.stdout.line]:[];a.gitBranch=$.map(b,function(b,c){var d=b.split(" ").pop();/^\*/.test(b)&&(a.gitCurrentBranch=d,a.gitCurrentBranchIndex=c);return d});$("#toolbar-current-branch").text(a.gitCurrentBranch);$("#menu-git-active").text(a.gitCurrentBranch);$("#menu-git-working-dir").text(a.workingDir)},error:u})},command:function(a,c,d,e){eXide.app.login.isAdmin&&$.ajax({type:"GET",url:"modules/git.xql",data:{target:a.root,"git-command":c,"git-option":d},
dataType:"json",success:function(a){"function"==typeof e&&e(a);b.updateStatus("");b.clearErrors();eXide.app.showResultsPanel();n=l=1;var c=document.getElementById("results-iframe");$(c).show();c.contentWindow.document.open("text/html","replace");c.contentWindow.document.write(JSON.stringify(a));c.contentWindow.document.close()},error:u})}},findFiles:function(){var a=b.getActiveDocument();f.findProject(a.getBasePath(),function(c){eXide.find.Files.open(a,c,function(a){b.updateStatus("");b.clearErrors();
n=l=1;var c=document.getElementById("results-iframe");$(c).show();eXide.app.showResultsPanel();c.contentWindow.document.open("text/html","replace");c.contentWindow.document.write("<html><body><p>Searching ...</p></body></html>");c.contentWindow.document.close();c.src="modules/search.xql?"+a})})},initGUI:function(a){eXide.util.supportsHtml5Storage&&localStorage.getItem("eXide.firstTime")&&(s=localStorage["eXide.layout.resultPanel"]||"south");c=new eXide.app.Layout(b);"south"==s?c.hide("east"):c.hide("south");
eXide.app.prepareResultsPanel(s);$("#open-dialog").dialog({appendTo:"#layout-container",title:"Open file",modal:!1,autoOpen:!1,height:480,width:600,open:function(){d.init()},resize:function(){d.resize()}});$("#login-dialog").dialog({appendTo:"#layout-container",title:"Login",modal:!0,autoOpen:!1,buttons:{Login:function(){var a=$('#login-form input[name="user"]').val(),c=$('#login-form input[name="password"]').val(),a={user:a,password:c};$('#login-form input[name="duration"]').is(":checked")&&(a.duration=
"P14D");$.ajax({url:"login",data:a,dataType:"json",success:function(a){eXide.app.login=a;$.log("Logged in as %s. Is dba: %s",eXide.app.login.user,eXide.app.login.isAdmin);$("#login-dialog").dialog("close");$("#user").text("Logged in as "+eXide.app.login.user+". ");b.focus()},error:function(a,b,c){$("#login-error").text("Login failed. "+c);$("#login-dialog input:first").focus()}})},Cancel:function(){$(this).dialog("close");b.focus()}},open:function(){$(this).find("input").val("");$(this).find("input:first").focus();
$("#login-error").empty();var a=$(this);a.find("input").keyup(function(b){13==b.keyCode&&a.parent().find(".ui-dialog-buttonpane button:first").trigger("click")})}});$("#keyboard-help").dialog({appendTo:"#layout-container",title:"Keyboard Shortcuts",modal:!1,autoOpen:!1,height:400,width:350,buttons:{Close:function(){$(this).dialog("close")}},open:function(){eXide.edit.commands.help($("#keyboard-help"),b)}});$("#about-dialog").dialog({appendTo:"#layout-container",title:"About",modal:!1,autoOpen:!1,
height:300,width:450,buttons:{Close:function(){$(this).dialog("close")}}});$("#dialog-templates").dialog({appendTo:"#layout-container",title:"New document",modal:!1,autoOpen:!1,height:280,width:550,dataType:"json",open:function(){$.ajax({url:"modules/get-template.xql",type:"POST",success:function(a){g=a;$("#dialog-templates .templates").hide();$("#dialog-templates .type-select").val("")}})},buttons:{Cancel:function(){$(this).dialog("close");b.focus()},Create:function(){var a=$(this).find(".type-select").val(),
c=$(this).find(".templates select").val();$.log("creating new doc with mode: %s and template: %s",a,c);b.newDocumentFromTemplate(a,c);$(this).dialog("close");b.focus()}}});$("#dialog-templates .type-select").change(function(){var a=$("#dialog-templates .templates"),b=$("select",a),c=$(this).val();b.empty();if(c=g[c]){for(var d="<option value=''>None</option>",e=0;e<c.length;e++)d+="<option value='"+c[e].name+"'>"+c[e].description+"</option>";b.html(d);a.show()}else a.hide()});eXide.util.Popup.init("#autocomplete-box",
b);$(".toolbar-buttons").buttonset();var h=$("#open").button("option","icons",{primary:"ui-icon-folder-open"});h.click(eXide.app.openDocument);a.click("#menu-file-open",eXide.app.openDocument);h=$("#close").button("option","icons",{primary:"ui-icon-close"});h.click(eXide.app.closeDocument);a.click("#menu-file-close",eXide.app.closeDocument);h=$("#new").button("option","icons",{primary:"ui-icon-document"});h.click(function(){eXide.app.newDocumentFromTemplate()});h=$("#new-xquery").button("option",
"icons",{primary:"ui-icon-document"});h.click(function(){eXide.app.newDocument(null,"xquery")});a.click("#menu-file-new",eXide.app.newDocumentFromTemplate);a.click("#menu-file-new-xquery",function(){eXide.app.newDocument(null,"xquery")});h=$("#run").button("option","icons",{primary:"ui-icon-play"});h.click(function(){eXide.app.runQuery()});h=$("#debug").button("option","icons",{primary:"ui-icon-seek-end"});h.click(eXide.app.startDebug);h=$("#debug-actions #step-over").button("option","icons",{primary:"ui-icon-seek-end"});
h.click(eXide.app.stepOver);h=$("#debug-actions #step-into").button("option","icons",{primary:"ui-icon-seek-end"});h.click(eXide.app.stepInto);h=$("#debug-actions #step-out").button("option","icons",{primary:"ui-icon-seek-end"});h.click(eXide.app.startDebug);h=$("#validate").button("option","icons",{primary:"ui-icon-check"});h.click(eXide.app.checkQuery);h=$("#save").button("option","icons",{primary:"ui-icon-disk"});h.click(eXide.app.saveDocument);a.click("#menu-file-save",eXide.app.saveDocument);
a.click("#menu-file-save-as",eXide.app.saveDocumentAs);a.click("#menu-file-reload",eXide.app.reloadDocument);h=$("#download").button("option","icons",{primary:"ui-icon-transferthick-e-w"});h.click(eXide.app.download);a.click("#menu-file-download",eXide.app.download);a.click("#menu-file-manager",eXide.app.manage);a.click("#menu-deploy-new",eXide.app.newDeployment);a.click("#menu-deploy-edit",eXide.app.deploymentSettings);a.click("#menu-deploy-deploy",eXide.app.deploy);a.click("#menu-deploy-sync",eXide.app.synchronize);
a.click("#menu-deploy-download",eXide.app.downloadApp);a.click("#menu-git-checkout",eXide.app.gitCheckout);a.click("#menu-git-commit",eXide.app.gitCommit);a.click("#menu-edit-undo",function(){b.editor.undo()});a.click("#menu-edit-redo",function(){b.editor.redo()});a.click("#menu-edit-find",function(){require("ace/config").loadModule("ace/ext/searchbox",function(a){a.Search(b.editor)})});a.click("#menu-edit-find-files",function(){eXide.app.findFiles()});a.click("#menu-edit-toggle-comment",function(){b.editor.toggleCommentLines()});
a.click("#menu-edit-preferences",function(){e.show()});a.click("#menu-navigate-definition",function(){b.exec("gotoDefinition")});a.click("#menu-navigate-modules",function(){var a=b.getActiveDocument();eXide.find.Modules.select(a.syntax)});a.click("#menu-navigate-info",function(){b.exec("showFunctionDoc")});a.click("#menu-navigate-symbol",function(){b.exec("gotoSymbol")});a.click("#menu-navigate-buffer",function(){b.selectTab()});a.click("#menu-navigate-commands",function(){eXide.app.getMenu().commandPalette()});
a.click("#menu-navigate-toggle-results",function(){eXide.app.toggleResultsPanel()});a.click("#menu-deploy-run",eXide.app.openApp);a.click("#menu-help-keyboard",function(){$("#keyboard-help").dialog("open")});a.click("#menu-help-about",function(){$("#about-dialog").dialog("open")});a.click("#menu-help-documentation",function(){window.open("docs/doc.html")});$("#syntax").change(function(){b.setMode($(this).val())});b.addEventListener("activate",null,function(a){eXide.app.updateStatus(a);f.findProject(a.getBasePath(),
function(a){a?($("#toolbar-current-app").text(a.abbrev),$("#menu-deploy-active").text(a.abbrev),"true"==a.git||!0==a.git?($(".current-branch").show(),$("#menu-git").show(),eXide.app.git.branch(a)):($(".current-branch").hide(),$("#menu-git").hide())):($("#toolbar-current-app").text("unknown"),$("#menu-deploy-active").text("unknown"),$(".current-branch").hide(),$("#menu-git").hide())})});$("#user").click(function(a){a.preventDefault();eXide.app.login?($.get("login?logout=logout"),$("#user").text("Login"),
eXide.app.login=null):$("#login-dialog").dialog("open")});eXide.util.supportsFullScreen()||$("#toggle-fullscreen").hide();$("#toggle-fullscreen").click(function(a){a.preventDefault();eXide.util.requestFullScreen(document.getElementById("fullscreen"))});$(".results-container .layout-switcher").click(eXide.app.switchResultsPanel);$(".results-container .next").click(eXide.app.browseNext);$(".results-container .previous").click(eXide.app.browsePrevious);$("#serialization-mode").change(function(){i&&eXide.app.runQuery(i)});
$("#error-status").mouseover(function(){var a=this;$("#ext-status-bar").each(function(){this.innerHTML=a.innerHTML;$(this).css("display","block")})});$("#ext-status-bar").mouseout(function(){$(this).css("display","none")});$(window).blur(function(){p=!1});$(window).focus(function(){var a=!p;p=!0;a&&eXide.app.getLogin()});$("#dialog-startup").dialog({appendTo:"#layout-container",modal:!1,title:"Quick Start",autoOpen:!1,width:400,height:300,buttons:{OK:function(){$(this).dialog("close")}}});eXide.util.supportsHtml5Storage&&
(a=localStorage.getItem("eXide.firstTime"),(!a||1==a)&&$("#dialog-startup").dialog("open"))}}}();eXide.namespace("eXide.edit.Template");
eXide.edit.Template=function(){var b=/\n/;Constr=function(c,a,d,f){var e=d.split(b).length;this.code=d;this.editor=c.editor;this.range=a;this.type=f;a?(this.startLine=a.start.row,this.startColumn=a.start.column):(c=this.editor.getCursorPosition(),this.startLine=c.row,this.startColumn=c.column);this.endLine=this.startLine+e-1;$.log("startLine = %i, endLine = %i",this.startLine,this.endLine);this.currentLine=this.startLine;this.lineOffset=this.startColumn;this.regex=/(?:\$[\w\-:_]+|\u2423)/g;0<this.startColumn&&
(this.regex.lastIndex=this.startColumn)};Constr.prototype={insert:function(){this.range&&this.editor.getSession().remove(this.range);this.editor.insert(this.code);var b=this.editor.getSelection().getSelectionLead();"$"!=this.code.substring(0,1)&&0<b.column&&this.editor.navigateLeft();"variable"!=this.type&&this.nextParam();this.editor.focus()},nextParam:function(){var b=this.editor.getSession(),a=this.editor.getSelection(),d=a.getSelectionLead();$.log("lead.row = %i startLine = %i",d.row,this.startLine);
if(d.row<this.startLine||d.row>this.endLine)return!1;for(var f=d=!1;this.currentLine<=this.endLine;){var e=b.getDisplayLine(this.currentLine);$.log("Checking line %s",e);if(e=this.regex.exec(e)){$.log("Matched %s",e[0]);a.setSelectionAnchor(this.currentLine,e.index);a.selectTo(this.currentLine,e.index+e[0].length);1===e[0].length&&b.remove(a.getRange());this.lineOffset=e.index;f=!0;break}else this.lineOffset=0,this.currentLine++;this.currentLine>this.endLine&&!d&&($.log("loop %i",this.startColumn),
this.currentLine=this.startLine,0<this.startColumn&&(this.lineOffset=this.startColumn,this.regex.lastIndex=this.lineOffset),d=!0)}return f}};return Constr}();eXide.namespace("eXide.browse.ResourceBrowser");
eXide.browse.ResourceBrowser=function(){var b=[{id:"name",name:"Name",field:"name",width:180,formatter:function(a,b,c,g,h){return h.isCollection?'<span class="collection"><img src="resources/images/folder.png"/> '+c+"</span>":c},editor:Slick.Editors.Text},{id:"permissions",name:"Permissions",field:"permissions",width:80},{id:"owner",name:"Owner",field:"owner",width:65},{id:"group",name:"Group",field:"group",width:65},{id:"lastMod",name:"Last Modified",field:"last-modified",width:140}],c={editable:!1,
multiSelect:!1,forceSyncScrolling:!0,forceFitColumns:!0},a={editable:!0,autoEdit:!0,multiSelect:!0,autoHeight:!1,enableCellNavigation:!0,forceSyncScrolling:!0,forceFitColumns:!0};Constr=function(c,f){var e=this;this.container=$(c);this.breadcrumbs=$(".eXide-browse-breadcrumbs",f);this.loading=!1;this.clipboard=[];this.clipboardMode="copy";this.events={activate:[],activateCollection:[],activateParent:[]};this.mode="save";this.inEditor=!1;this.collection="/db";this.data=[];this.grid=new Slick.Grid(this.container,
this.data,b,a);var g=new Slick.RowSelectionModel;this.grid.setSelectionModel(g);g.onSelectedRangesChanged.subscribe(function(){var a=g.getSelectedRows();if(0!=e.data.length){for(var b=!0,c=0;c<a.length;c++)if(a[c]<e.data.length&&e.data[a[c]]&&!e.data[a[c]].writable){b=!1;break}e.$triggerEvent("activate",[1==a.length&&e.data[a[0]]&&!e.data[a[0]].isCollection?e.data[a[0]]:null,b])}});this.grid.onDblClick.subscribe(function(a){a=e.grid.getCellFromEvent(a);if(e.data[a.row].isCollection){var b;b=".."==
e.data[a.row].name?e.collection.replace(/\/[^\/]+$/,""):e.collection+"/"+e.data[a.row].name;e.$triggerEvent("activateCollection",[b,e.data[a.row].writable]);e.update(b,!1)}else eXide.app.openSelectedDocument()});this.grid.onKeyDown.subscribe(function(a){if(!e.inEditor&&!a.shiftKey&&!a.altKey&&!a.ctrlKey)switch(a.which){case 13:a.stopPropagation();a.preventDefault();a=g.getSelectedRows();if(1==a.length)if(e.data[a[0]].isCollection){var b;b=".."==e.data[a[0]].name?e.collection.replace(/\/[^\/]+$/,""):
e.collection+"/"+e.data[a[0]].name;e.$triggerEvent("activateCollection",[b,e.data[a[0]].writable]);e.update(b,!1)}else eXide.app.openSelectedDocument();break;case 8:a.stopPropagation();a.preventDefault();a=e.collection.lastIndexOf("/");0<a&&"/db"!=e.collection&&(a=e.collection.substring(0,a),e.$triggerEvent("activateCollection",[a]),e.update(a,!1));break;case 46:e.deleteResource()}});this.grid.onBeforeEditCell.subscribe(function(a,b){e.inEditor=!0;e.oldValue=e.data[b.row].name});this.grid.onBeforeCellEditorDestroy.subscribe(function(){e.inEditor=
!1});this.grid.onCellChange.subscribe(function(a,b){e.oldValue&&$.getJSON("modules/collections.xql",{target:e.data[b.row].name,rename:e.oldValue,root:e.collection},function(a){e.reload();e.data[b.row].isCollection&&e.$triggerEvent("activateCollection",[e.data[b.row].name]);"fail"==a.status&&eXide.util.Dialog.warning("Rename Error",a.message)})});this.grid.onViewportChanged.subscribe(function(){var a=e.grid.getViewport();e.load(a.top,a.bottom)});$("#resource-properties-dialog").dialog({title:"Resource/collection properties",
modal:!0,autoOpen:!1,height:380,width:460,buttons:{Cancel:function(){$(this).dialog("close")},Apply:function(){var a=this,b=e.grid.getSelectionModel().getSelectedRows();if(0!=b.length){for(var c=[],d=0;d<b.length;d++)c.push(e.collection+"/"+e.data[b[d]].name);b=$("form",a).serialize();b=b+"&"+$.param({"modify[]":c});$.getJSON("modules/collections.xql",b,function(){$(a).dialog("close");e.reload()})}}}})};eXide.util.oop.inherit(Constr,eXide.events.Sender);Constr.prototype.setCollection=function(a){this.collection=
a;this.updateBreadcrumbs()};Constr.prototype.updateBreadcrumbs=function(){this.breadcrumbs.empty();for(var a=this,b=this.collection.split("/"),c=$("<span>/</span>"),g="/",h=0;h<b.length;h++){var i=b[h];i&&0<i.length&&(g+=i+"/",i=$('<a href="#">').append(i),i.data("collection",g),c.append(i).append("/"),i.click(function(b){b.preventDefault();a.update($(this).data("collection"),!1)}))}this.breadcrumbs.html(c)};Constr.prototype.setMode=function(b){this.mode=b;"manage"==b?this.grid.setOptions(a):this.grid.setOptions(c)};
Constr.prototype.resize=function(){console.log("Resizing canvas...");var a=$(".eXide-browse-main").height();$(".eXide-browse-resources").height(a);this.grid.resizeCanvas();this.grid.focus()};Constr.prototype.update=function(a,b){if(b||a!==this.collection)$.log("Opening resources for %s",a),this.setCollection(a),this.grid.invalidate(),this.data.length=0,this.grid.setSelectedRows([]),this.grid.onViewportChanged.notify(),this.grid.resetActiveCell(),this.grid.setActiveCell(0,1),this.grid.focus()};Constr.prototype.load=
function(a,b){if(!this.loading&&(!this.data[a]||!(b>=this.data.length||this.data[b]))){var c=this;this.loading=!0;b+=20;$.getJSON("modules/collections.xql",{root:this.collection,view:"r",start:a,end:b},function(g){c.loading=!1;for(var h=a;h<=b;h++)c.grid.invalidateRow(h);if(g&&g.items){c.data.length=g.total;for(h=0;h<g.items.length;h++)c.data[a+h]=g.items[h]}else c.data.length=0;c.grid.updateRowCount();c.grid.render();0==a&&(c.grid.resetActiveCell(),c.grid.setActiveCell(0,1),c.grid.focus())})}};Constr.prototype.hasSelection=
function(){var a=this.grid.getSelectionModel().getSelectedRows();return a&&0<a.length};Constr.prototype.getSelected=function(){var a=this.grid.getSelectionModel().getSelectedRows();if(0==a.length)return null;for(var b=[],c=0;c<a.length;c++)b.push(this.collection+"/"+this.data[a[c]].name);return b};Constr.prototype.createCollection=function(){var a=this;eXide.app.$checkLogin()&&eXide.util.Dialog.input("Create Collection",'<label for="collection">Name: </label><input type="text" name="collection" id="eXide-browse-collection-name"/>',
function(){$.getJSON("modules/collections.xql",{create:$("#eXide-browse-collection-name").val(),collection:a.collection},function(b){"fail"==b.status?eXide.util.Dialog.warning("Create Collection Error",b.message):a.reload()})})};Constr.prototype.deleteCollection=function(){var a=this;eXide.util.Dialog.input("Confirm Deletion","Are you sure you want to delete collection "+a.selected+"?",function(){$.getJSON("modules/collections.xql",{remove:a.collection},function(b){"fail"==b.status?eXide.util.Dialog.warning("Delete Collection Error",
b.message):a.reload()})})};Constr.prototype.deleteResource=function(){var a=this.grid.getSelectionModel().getSelectedRows();if(0!=a.length){for(var b=[],c=0;c<a.length;c++)b.push(this.data[a[c]].name);var g=this;eXide.util.Dialog.input("Confirm Deletion","Are you sure you want to delete the selected resources?",function(){$.log("Deleting resources %o",b);$.getJSON("modules/collections.xql",{remove:b,root:g.collection},function(a){g.reload();"fail"==a.status&&eXide.util.Dialog.warning("Delete Resource Error",
a.message)})})}};Constr.prototype.properties=function(){var a=this.grid.getSelectionModel().getSelectedRows();if(0!=a.length){for(var b=[],c=0;c<a.length;c++)".."!=this.data[a[c]].name&&b.push(this.collection+"/"+this.data[a[c]].name);0<b.length&&($("#resource-properties-content").load("modules/collections.xql",{properties:b}),$("#resource-properties-dialog").dialog("open"))}};Constr.prototype.cut=function(){this.clipboardMode="move";this.copy()};Constr.prototype.copy=function(){var a=this.grid.getSelectionModel().getSelectedRows();
this.clipboard=[];for(var b=0;b<a.length;b++){var c=this.data[a[b]].name;"/"!=c.substr(0,1)&&(c=this.collection+"/"+c);this.clipboard.push(c)}$.log("Clipboard: %o",this.clipboard)};Constr.prototype.paste=function(){var a=this;$.log("Copying resources %o to %s",this.clipboard,this.collection);var b={root:this.collection};b[this.clipboardMode]=this.clipboard;$.getJSON("modules/collections.xql",b,function(b){$.log(b.status);"fail"==b.status?eXide.util.Dialog.warning("Delete Resource Error",b.message):
a.reload()})};Constr.prototype.focus=function(){this.container.find(".grid-canvas").focus()};Constr.prototype.reload=function(){this.grid.invalidate();this.data.length=0;this.update(this.collection,!0)};return Constr}();eXide.namespace("eXide.browse.Upload");
eXide.browse.Upload=function(){function b(b,a,d){$(a).fileupload({sequentialUploads:!0,autoUpload:!1,dataType:"json",dropZone:d}).on("fileuploadadd",function(a,d){$("#file_upload thead").show();d.context=$("#files");$.each(d.files,function(a,f){if("."!=f.name){var i=f.name;f.webkitRelativePath?i=f.webkitRelativePath:f.relativePath&&(i=f.relativePath+i);f.path=i;var j=$('<tr data-name="'+i+'"/>');j.append($("<td/>").text(f.name));j.append($("<td/>").text(f.size));j.append($('<td class="file_upload_progress"><div class="ui-progressbar-value" style="width: 0%;"></div></td>'));
j.appendTo(d.context);d.formData={path:i,collection:$('input[name="collection"]',b).val()};d.submit().done(function(){j.remove()})}})}).on("fileuploadprogress",function(a,d){$.each(d.files,function(a,f){var i=parseInt(100*(d.loaded/d.total),10);$("tr[data-name='"+f.path+"']",b).find(".ui-progressbar-value").css("width",i+"%")})}).on("fileuploaddone",function(){}).on("fileuploadfail",function(a,b){console.log("error: ",b)})}Constr=function(c){this.container=c;this.events={done:[]};b(c,"#file_upload",
$(".file_upload_drop"));var a=document.createElement("input");"webkitdirectory"in a||"mozdirectory"in a||"odirectory"in a||"msdirectory"in a||"directory"in a?b(c,"#dir_upload",null):$("#dir_upload").parent().hide();var d=this;$("#eXide-browse-upload-done").button().click(function(){$("#files").empty();d.$triggerEvent("done",[])})};eXide.util.oop.inherit(Constr,eXide.events.Sender);Constr.prototype.update=function(b){$.log("Upload collection: %s",b);$("#files").empty();$("#file_upload thead").hide();
$('input[name="collection"]',this.container).val(b)};return Constr}();eXide.namespace("eXide.browse.Browser");
eXide.browse.Browser=function(){function b(b,a,d,f,e){var g=document.createElement("button");g.title=a;g.id="eXide-browse-toolbar-"+d;g.tabindex=f;a=document.createElement("img");a.src="resources/images/"+e;g.appendChild(a);b.append(g);return g}Constr=function(c){var a=this;this.mode="open";var d=$(".eXide-browse-toolbar",c),f=b(d,"Reload","reload",1,"arrow_refresh.png");$(f).click(function(){a.resources.reload(!0)});this.btnCreateCollection=b(d,"Create Collection","create",3,"folder_add.png");$(this.btnCreateCollection).click(function(b){b.preventDefault();
a.resources.createCollection()});this.btnUpload=b(d,"Upload Files","upload",4,"database_add.png");$(this.btnUpload).click(function(a){a.preventDefault();$(".eXide-browse-resources",c).hide();$(".eXide-browse-upload",c).show()});this.btnDeleteResource=b(d,"Delete","delete-resource",5,"bin.png");$(this.btnDeleteResource).click(function(b){b.preventDefault();a.deleteSelected()});this.btnProperties=b(d,"Properties","properties",10,"application_form_edit.png");$(this.btnProperties).click(function(b){b.preventDefault();
a.resources.properties()});f=b(d,"Open Selected","open",6,"page_edit.png");$(f).click(function(a){a.preventDefault();eXide.app.openSelectedDocument(!1)});this.btnCopy=b(d,"Copy","copy",7,"page_copy.png");this.btnCut=b(d,"Cut","cut",8,"cut.png");this.btnPaste=b(d,"Paste","paste",9,"page_paste.png");this.selection=$(".eXide-browse-form input",c);this.container=c;this.resources=new eXide.browse.ResourceBrowser($(".eXide-browse-resources",c),c);this.upload=new eXide.browse.Upload($(".eXide-browse-upload",
c).hide());this.resources.addEventListener("activate",this,this.onActivateResource);this.resources.addEventListener("activateCollection",this,this.onActivateCollection);this.upload.addEventListener("done",this,function(){$(".eXide-browse-resources",c).show();$(".eXide-browse-upload",c).hide();this.reload()});$(this.btnCopy).click(function(b){b.preventDefault();a.resources.copy()});$(this.btnCut).click(function(b){b.preventDefault();a.resources.cut()});$(this.btnPaste).click(function(b){b.preventDefault();
a.resources.paste()})};Constr.prototype={init:function(){this.resources.resize();this.resources.reload()},reload:function(b,a){if(b){$(".eXide-browse-toolbar button",this.container).hide();for(var d=0;d<b.length;d++)$("#eXide-browse-toolbar-"+b[d]).show()}a&&(this.mode=a);this.resources.setMode(a);this.resources.reload();"save"===this.mode?$(".eXide-browse-form",this.container).show().focus():$(".eXide-browse-form",this.container).hide();this.resize();$(this.selection).val("")},resize:function(){},
deleteSelected:function(){this.resources.getSelected();this.resources.deleteResource()},getSelection:function(){var b=$(this.selection).val();return null==b||""==b?null:{name:b,path:this.resources.collection+"/"+b,writable:!0}},changeToCollection:function(b){this.resources.update(b,!0)},onActivateResource:function(b,a){b?$(this.selection).val(b.name):$(this.selection).val("");"open"!=this.mode&&a?($(this.btnDeleteResource).css("display",""),$(this.btnProperties).css("display","")):($(this.btnDeleteResource).css("display",
"none"),$(this.btnProperties).css("display","none"))},onActivateCollection:function(b,a){$.log("Activate collection: %s %s",b,this.mode);switch(this.mode){case "open":case "save":$(".eXide-browse-toolbar button",this.container).hide();$(this.btnCreateCollection).css("display","");break;default:a?($(this.btnCreateCollection).css("display",""),$(this.btnUpload).css("display",""),$(this.btnCut).css("display",""),$(this.btnPaste).css("display",""),$(this.btnDeleteResource).css("display","")):($(this.btnCreateCollection).css("display",
"none"),$(this.btnUpload).css("display","none"),$(this.btnCut).css("display","none"),$(this.btnPaste).css("display","none"),$(this.btnDeleteResource).css("display","none"))}this.upload.update(b,a)}};return Constr}();eXide.namespace("eXide.find.IncrementalSearch");
eXide.find.IncrementalSearch=function(){var b={backwards:!1,wrap:!0,caseSensitive:!1,wholeWord:!1,regExp:!1};Constr=function(b,a){var d=this;d.input=$(b);d.input.hide();d.input.keyup(function(a){switch(a.which){case 27:case 13:a.preventDefault();d.input.hide();d.editor.focus();break;case 40:a.preventDefault();d.editor.findNext();break;case 38:a.preventDefault();d.editor.findPrevious();break;case 71:if(a.metaKey||a.ctrlKey){a.preventDefault();d.editor.findNext();break}default:d.onChange()}});d.editor=
a};Constr.prototype.start=function(){this.currentLine=this.editor.getSession().getSelection().getSelectionLead().row;this.input.val("");this.input.show().focus()};Constr.prototype.onChange=function(){this.editor.gotoLine(this.currentLine);var c=this.input.val();this.editor.find(c,b,!0);this.input.focus()};return Constr}();eXide.namespace("eXide.find.SearchReplace");
eXide.find.SearchReplace=function(){Constr=function(b){var c=this;c.editor=b;c.needleSet=!1;c.lastSearch=null;c.container=$("#find-replace-dialog");c.container.dialog({modal:!1,autoOpen:!1,height:300,width:600,buttons:{Close:function(){$(this).dialog("close");c.editor.focus()},Replace:function(){c.replace(!1)},"Replace All":function(){c.replace(!0)},"Find Next":function(){c.find(1)},"Find Previous":function(){c.find(-1)}}})};Constr.prototype.open=function(){this.container.dialog("open");this.container.find("input[name='search']").focus()};
Constr.prototype.find=function(b){var c=this.container.find("input[name='search']").val();$.log("Searching for %s",c);c&&0<c.length&&(null!=this.lastSearch&&this.lastSearch==c?-1==b?this.editor.findPrevious():this.editor.findNext():(this.editor.find(c,this.getOptions(),!0),this.needleSet=!0),this.editor.focus())};Constr.prototype.replace=function(b){var c=this.container.find("input[name='search']").val();if(c&&0<c.length&&(this.needleSet||(this.editor.find(c,this.getOptions(),!0),this.needleSet=!0),
(c=this.container.find("input[name='replace']").val())&&0<c.length))b?this.editor.replaceAll(c):(this.editor.replace(c),this.editor.findNext())};Constr.prototype.getOptions=function(){var b=this.container.find("input[name='case']").is(":checked"),c=this.container.find("input[name = 'regex']").is(":checked");return{wrap:!0,caseSensitive:b,regExp:c}};return Constr}();eXide.namespace("eXide.find.Files");
eXide.find.Files=function(){var b;$(document).ready(function(){b=$("#find-dialog");b.dialog({title:"Search binary files",modal:!1,autoOpen:!1,height:400,width:600})});return{open:function(c,a,d){a?(b.find("input.project").get().disabled=!1,b.find("input.project").val(a.root),b.find(".project-path").text(a.abbrev)):b.find("input.project").get().disabled=!0;b.find("input[name='collection']").val(c.getBasePath());b.dialog("option","buttons",{Close:function(){$(this).dialog("close");self.editor.focus()},
Search:function(){var a=b.find("form").serialize();d(a);$(this).dialog("close")}});b.dialog("open")}}}();eXide.namespace("eXide.find.Modules");
eXide.find.Modules=function(){var b={open:[],"import":[]},c=[{id:"prefix",name:"Prefix",field:"prefix",sortable:!0,resizable:!0,maxWidth:100,minWidth:60},{id:"uri",name:"URI",field:"uri",sortable:!0,resizable:!0,minWidth:100},{id:"at",name:"Location",field:"at",sortable:!0,resizable:!0}],a={editable:!1,multiSelect:!1,forceFitColumns:!0},d=[],f;$(document).ready(function(){$("#select-module-dialog").dialog({modal:!1,autoOpen:!1,height:400,width:600,open:eXide.find.Modules.$init});f=new Slick.Grid("#module-list",
d,c,a);var b=new Slick.RowSelectionModel({selectActiveRow:!0});f.setSelectionModel(b);f.onDblClick.subscribe(function(a){a=f.getCellFromEvent(a);eXide.find.Modules.$triggerEvent("open",[d[a.row]])});f.onSort.subscribe(function(a,b){$.log("sorting on field: %s",b.sortCol.field);d.sort(function(a,c){var d=b.sortCol.field,e=a[d],d=c[d],e=(e==d?0:e>d?1:-1)*(b.sortAsc?1:-1);return 0!=e?e:0});f.invalidate();f.render()})});return{select:function(a){var b={Open:function(){eXide.find.Modules.trigger("open");
$(this).dialog("close")},Cancel:function(){$(this).dialog("close")}};"xquery"==a&&(b.Import=function(){eXide.find.Modules.trigger("import");$(this).dialog("close")});$("#select-module-dialog").dialog("option","buttons",b);$("#select-module-dialog").dialog("open")},trigger:function(a){var b=f.getSelectionModel().getSelectedRows();1==b.length&&eXide.find.Modules.$triggerEvent(a,[d[b[0]]])},$init:function(){f.resizeCanvas();f.invalidate();d.length=0;$.getJSON("modules/find.xql",function(a){d.length=
a.length;for(var b=0;b<a.length;b++)d[b]=a[b];f.updateRowCount();f.render();f.setActiveCell(0,0);f.setSelectedRows([0]);$("#module-list").find(".grid-canvas").focus()})},addEventListener:function(a,c,d){(a=b[a])&&a.push({obj:c,callback:d})},$triggerEvent:function(a,c){var d=b[a];if(d)for(var f=0;f<d.length;f++)d[f].callback.apply(d[f].obj,c)}}}();eXide.namespace("eXide.edit.Visitor");eXide.edit.Visitor=function(){Constr=function(){};Constr.prototype.visit=function(b,c){var a=b.name,d=!1;"function"===typeof this[a]&&(d=!0===this[a](b)?!0:!1);d||this.visitChildren(b,c)};Constr.prototype.visitChildren=function(b,c){for(var a=0;a<b.children.length;a++){var d=b.children[a];if(void 0!==c&&"function"===typeof c[d.name])c[d.name](d);else this.visit(d,c)}};return Constr}();eXide.namespace("eXide.edit.XQueryUtils");
eXide.edit.XQueryUtils=function(){return{findNode:function(b,c){if(!0===eXide.edit.XQueryUtils.inRange(b.pos,c,!1)){for(var a in b.children){var d=eXide.edit.XQueryUtils.findNode(b.children[a],c);if(null!==d)return d}return b}return null},findNodeForRange:function(b,c,a){var d=b.pos;if(!0===eXide.edit.XQueryUtils.inRange(d,c)&&!0===eXide.edit.XQueryUtils.inRange(d,a)){for(var f in b.children)if(d=eXide.edit.XQueryUtils.findNode(b.children[f],c,a),null!==d)return d;return b}return null},inRange:function(b,
c,a){if(b&&b.sl<=c.line&&c.line<=b.el){if(b.sl<c.line&&c.line<b.el)return!0;if(b.sl==c.line&&c.line<b.el)return b.sc<=c.col;if(b.sl==c.line&&b.el===c.line)return b.sc<=c.col&&c.col<=b.ec+(a?1:0);if(b.sl<c.line&&b.el===c.line)return c.col<=b.ec+(a?1:0)}},samePosition:function(b,c){return b.sl==c.sl&&b.sc==c.sc&&b.el==c.el&&b.ec==c.ec},findNext:function(b,c){for(var a=b.getParent.children,d=0;d<a.length;d++)if(a[d]==b)for(var f=d+1;f<a.length;f++)if(a[f].name==c)return a[f];return null},findChild:function(b,
c){for(var a=b.children,d=0;d<a.length;d++)if(a[d].name==c)return a[d];return null},findSibling:function(b,c){for(var a=b.getParent.children,d=0;d<a.length;d++)if(a[d].name==c)return a[d];return null},findSiblings:function(b,c){for(var a=b.getParent.children,d=[],f=0;f<a.length;f++)a[f]!=b&&a[f].name==c&&d.push(a[f]);return d},findAncestor:function(b,c){if(c instanceof Array)for(;null!==b;){if(-1<$.inArray(b.name,c))return b;b=b.getParent}else for(;null!==b;){if(b.name==c)return b;b=b.getParent}return null},
findVariableContext:function(b,c){for(var a=b.getParent;null!==a;){if(("FLWORExpr"===a.name||"FunctionDecl"===a.name)&&null!==eXide.edit.XQueryUtils.findVarDecl(a,c))return a;if("FunctionDecl"===a.name)break;a=a.getParent}return null},getValue:function(b){var c="";if(b.value)c=b.value;else for(var a=0;a<b.children.length;a++)c+=eXide.edit.XQueryUtils.getValue(b.children[a]);return c},findVarDecl:function(b,c){for(var a=(new eXide.edit.VariableReferences(c,b)).getReferences(),d=0;d<a.length;d++)if(a[d].getParent&&
"LetBinding"===a[d].getParent.name||"ForBinding"===a[d].getParent.name||"Param"===a[d].getParent.name)return a[d];return null},getPath:function(b){for(var c=[b.name],b=b.getParent;b;)c.push(b.name),b=b.getParent;return c.reverse().join("/")}}}();eXide.namespace("eXide.edit.VariableReferences");
eXide.edit.VariableReferences=function(){require("ace/range");Constr=function(b,c){this.variable=b;this.references=[];this.visit(c)};eXide.util.oop.inherit(Constr,eXide.edit.Visitor);Constr.prototype.VarName=function(b){eXide.edit.XQueryUtils.getValue(b)==this.variable&&this.references.push(b)};Constr.prototype.Param=function(b){for(var c=0;c<b.children.length;c++)b.children[c].value===this.variable&&this.references.push(b.children[c])};Constr.prototype.getReferences=function(){return this.references};
return Constr}();eXide.namespace("eXide.edit.InScopeVariables");
eXide.edit.InScopeVariables=function(){require("ace/range");Constr=function(b,c){this.node=c;this.stack=[];this.variables=null;this.visit(b)};eXide.util.oop.inherit(Constr,eXide.edit.Visitor);Constr.prototype.FLWORExpr=function(b){var c=this.stack.length;this.visitChildren(b);this.stack.length=c;return!0};Constr.prototype.VarName=function(b){if(b==this.node)return this.variables=this.deepCopy(this.stack),!0;if("ForBinding"===b.getParent.name||"LetBinding"===b.getParent.name)b=eXide.edit.XQueryUtils.getValue(b),
this.stack.push(b)};Constr.prototype.VarRef=function(b){return b==this.node?(this.variables=this.deepCopy(this.stack),!0):!1};Constr.prototype.VarDecl=function(b){var c=this;this.visitChildren(b,{VarName:function(a){a=eXide.edit.XQueryUtils.getValue(a);c.stack.push(a);return!0},VarValue:function(){return!0}});return!0};Constr.prototype.FunctionDecl=function(b){var c=this.deepCopy(this.stack);this.visitChildren(b);this.stack=c;return!0};Constr.prototype.Param=function(b){var c=this;this.visitChildren(b,
{EQName:function(a){c.stack.push(a.value)}});return!0};Constr.prototype.deepCopy=function(b){for(var c=[],a=0;a<b.length;a++)c.push(b[a]);return c};Constr.prototype.getStack=function(){return this.variables};return Constr}();eXide.namespace("eXide.edit.FunctionParameters");
eXide.edit.FunctionParameters=function(){require("ace/range");Constr=function(b){this.parameters=[];this.visit(b)};eXide.util.oop.inherit(Constr,eXide.edit.Visitor);Constr.prototype.Argument=function(b){var c;this.visitChildren(b,{VarName:function(a){c=eXide.edit.XQueryUtils.getValue(a);return!1}});c?this.parameters.push(c):this.parameters.push("argument"+this.parameters.length);return!0};Constr.prototype.getParameters=function(){return this.parameters};return Constr}();eXide.namespace("eXide.edit.FunctionCalls");
eXide.edit.FunctionCalls=function(){require("ace/range");Constr=function(b,c,a){this.name=b;this.arity=c;this.references=[];this.declaration=null;this.visit(a)};eXide.util.oop.inherit(Constr,eXide.edit.Visitor);Constr.prototype.FunctionCall=function(b){if(b.arity!==this.arity)return!1;b.children[0].value===this.name&&this.references.push(b.children[0]);return!1};Constr.prototype.FunctionDecl=function(b){var c=this;parseInt(b.arity)===this.arity&&this.visitChildren(b,{EQName:function(a){if(a.value===
c.name)return c.declaration=a,!0}});return!1};Constr.prototype.getReferences=function(){return this.references};return Constr}();
eXide.edit.ModuleInfo=function(){Constr=function(b){this.moduleNamespace=this.modulePrefix=null;this.annotations={};this.functions=[];this.prolog=null;this.visit(b)};eXide.util.oop.inherit(Constr,eXide.edit.Visitor);Constr.prototype.isModule=function(){return null!==this.moduleNamespace};Constr.prototype.hasTests=function(){for(var b in this.annotations)if(/test\:/.test(b))return!0;return!1};Constr.prototype.Prolog=function(b){this.prolog=b};Constr.prototype.FunctionDecl=function(b){this.functions.push(b)};
Constr.prototype.ModuleDecl=function(b){var c=this;this.visitChildren(b,{NCName:function(a){c.modulePrefix=eXide.edit.XQueryUtils.getValue(a);return!1},URILiteral:function(a){c.moduleNamespace=a.value;return!1}});return!1};Constr.prototype.Annotation=function(b){var c=this;this.visitChildren(b,{EQName:function(a){c.annotations[a.value]=1;return!1}});return!1};return Constr}();eXide.namespace("eXide.edit.XQueryQuickFix");
eXide.edit.XQueryQuickFix=function(){function b(a,b,c,h){var a=eXide.edit.XQueryUtils.findNode(c.ast,{line:h.row,col:h.column+1}).getParent,i=eXide.edit.XQueryUtils.findNext(a,"Separator"),a=h.pos.sl,c=h.pos.sc,j=i?i.pos.el:h.pos.el,h=i?i.pos.ec:h.pos.ec,i=b.editor.getSession().getLine(j),h=h==i.length?new d(a,c,j+1,0):new d(a,c,j,h);b.editor.getSession().remove(h)}var c=require("ace/snippets").snippetManager,a=[{regex:/Call to undeclared function/,getResolutions:function(a,b,c,d,i){var j=/undeclared function:\s+([\w\d\-_]+:[\w\d\-_]+)$/.exec(d.text);
if(2===j.length){var l=j[1].split(":")[0];return[{action:'Create function "'+j[1]+'"',resolve:function(a,b,c){a=new eXide.edit.PrologAdder(b,c);b=(new eXide.edit.FunctionParameters(i.getParent)).getParameters();a.addFunction(j[1],b)}},{action:'Import module "'+l+'"',resolve:function(a,b,c){(new eXide.edit.PrologAdder(b,c)).importModule(l)}}]}return null}},{regex:/unused namespace prefix/,getResolutions:function(a,c,d,h,i){a="Remove namespace declaration";eXide.edit.XQueryUtils.findAncestor(i,"ModuleImport")&&
(a="Remove module import");return[{resolve:b,action:a}]}},{regex:/No namespace defined/,getResolutions:function(a,b,c,d,i){var j=/for prefix (\w+)/.exec(d.text);if(2===j.length){if(i&&"FunctionCall"===i.getParent.name)return[{resolve:function(a,b,c){a.parent.validator.setEnabled(!1);(new eXide.edit.PrologAdder(b,c)).importModule(j[1]);a.xqlint(c);a.autocomplete(c);a.parent.validator.setEnabled(!0)},action:'Import module "'+j[1]+'"'}];if(i&&("EQName"===i.name||"ElementTest"===i.getParent.name||"OptionDecl"===
i.getParent.name))return[{resolve:function(a,b,c){a.parent.validator.setEnabled(!1);(new eXide.edit.PrologAdder(b,c)).declareNamespace(j[1]);a.xqlint(c);a.autocomplete(c);a.parent.validator.setEnabled(!0)},action:'Declare namespace "'+j[1]+'"'}]}}},{regex:/variable.*not set/,getResolutions:function(a,b,d,h,i){if("VarName"===i.getParent.name)return[{resolve:function(a,b,c){(new eXide.edit.PrologAdder(b,c)).declareVariable(i.value)},action:'Declare global variable "'+i.value+'"'},{resolve:function(a,
b){var d,e=eXide.edit.XQueryUtils.findAncestor(i,["IntermediateClause","InitialClause","ReturnClause"]);if(e)d="let \\$"+i.value+" := ${1:()}";else{e=eXide.edit.XQueryUtils.findAncestor(i,"StatementsAndOptionalExpr");e=eXide.edit.XQueryUtils.findChild(e,"Expr");if(!e){eXide.util.error("Extract variable: unable to determine context. Giving up.");return}d="let \\$"+i.value+" := ${1:()}\nreturn"}a.parent.validator.setEnabled(!1);$.log("extract variable: context: %o",e);b.editor.gotoLine(e.pos.sl+1,e.pos.sc);
b.editor.insert("\n");b.editor.gotoLine(e.pos.sl+1,e.pos.sc);c.insertSnippet(b.editor,d);b.editor.focus();a.parent.validator.setEnabled(!0)},action:"Create let statement"}]}}];require("lib/Compiler");var d=require("ace/range").Range;return{getResolutions:function(b,c,d,h){for(var i=[],j=0;j<a.length;j++)if(a[j].regex.test(h.text)){var l=eXide.edit.XQueryUtils.findNode(d.ast,{line:h.row,col:h.column+1}),l=a[j].getResolutions(b,c,d,h,l);if(null!=l)for(var n=0;n<l.length;n++)i.push(l[n])}return i}}}();
eXide.namespace("eXide.edit.PrologAdder");
eXide.edit.PrologAdder=function(){require("ace/range");var b=require("ace/snippets").snippetManager;Constr=function(b,a){this.editor=b;this.doc=a;this.program=this.prolog=null;this.visit(a.ast)};eXide.util.oop.inherit(Constr,eXide.edit.Visitor);Constr.prototype.Prolog=function(b){this.prolog=b};Constr.prototype.VersionDecl=function(b){this.decl=b};Constr.prototype.getInsertionPoint=function(b){var a=0;if(b){if(b=eXide.edit.XQueryUtils.findAncestor(b,"FunctionDecl"))a=b.pos.el}else 0<this.prolog.children.length?
a=this.prolog.pos.el:this.decl&&(a=this.decl.pos.el);return a};Constr.prototype.addFunction=function(c,a){this.prepareFunction();var d="declare function "+c+"(";if(a)for(var f=0;f<a.length;f++)0<f&&(d+=", "),d+="$${"+(f+1)+":"+a[f]+"}";d+=") {\n\t${"+(arguments.length+1)+":()}\n};";b.insertSnippet(this.editor.editor,d)};Constr.prototype.createFunction=function(b,a,d){for(var d=this.prepareFunction(d),f="declare function (",e=0;e<b.length;e++)0<e&&(f+=", "),f+="$"+b[e];this.editor.editor.insert(f+
(") {\n\t"+a+"\n};"));this.editor.editor.gotoLine(d,17)};Constr.prototype.prepareFunction=function(b){b=b||this.getInsertionPoint();this.editor.editor.gotoLine(b+1);this.editor.editor.navigateLineEnd();this.editor.editor.insert("\n\n");this.editor.editor.gotoLine(b+3,0);return b+3};Constr.prototype.importModule=function(c,a,d){var c=-1<c.indexOf(":")?c.substring(0,c.indexOf(":")):c,f=0;this.decl&&(f=this.decl.pos.el);for(var e=0;e<this.prolog.children.length;e++)if("Import"===this.prolog.children[e].name){f=
this.prolog.children[e].pos.sl-1;break}f=0>f?0:f;this.editor.editor.gotoLine(f+1);this.editor.editor.navigateLineEnd();this.editor.editor.insert("\n\n");this.editor.editor.gotoLine(f+3,0);a?(a="import module namespace "+c+'="'+a+'"',a=d?a+(' at "'+d+'";'):a+";"):a="import module namespace "+c+'="${1}";';b.insertSnippet(this.editor.editor,a);this.editor.editor.gotoLine(f+3,26+c.length)};Constr.prototype.declareNamespace=function(c){var a=0;this.decl&&(a=this.decl.pos.el);for(var d=0;d<this.prolog.children.length;d++)if("NamespaceDecl"===
this.prolog.children[d].name){a=this.prolog.children[d].pos.sl-1;break}a=0>a?0:a;this.editor.editor.gotoLine(a+1);this.editor.editor.navigateLineEnd();this.editor.editor.insert("\n\n");this.editor.editor.gotoLine(a+3,0);b.insertSnippet(this.editor.editor,"declare namespace "+c+'="${1}";')};Constr.prototype.declareVariable=function(c){$.log("prolog: %o",this.prolog);for(var a=-1,d=0;d<this.prolog.children.length;d++)if("AnnotatedDecl"===this.prolog.children[d].name){a=this.prolog.children[d].pos.sl-
1;break}0>a&&(a=0<this.prolog.children.length?this.prolog.children[this.prolog.children.length-1].pos.el:this.decl?this.decl.pos.el:0);$.log("Inserting at %d",a);this.editor.editor.gotoLine(a+1);this.editor.editor.navigateLineEnd();this.editor.editor.insert("\n\n");this.editor.editor.gotoLine(a+3,0);b.insertSnippet(this.editor.editor,"declare variable \\$"+c+" := ${1:expression};")};return Constr}();eXide.namespace("eXide.util.Snippets");
eXide.util.Snippets=function(){var b=require("ace/snippets").snippetManager,c={};return{init:function(a){c[a]||(c[a]=[],$.ajax({url:"templates/"+a+".snippets",dataType:"text",success:function(d){d=b.parseSnippetFile(d);b.register(d,a);c[a]=d}}))},getTemplates:function(a,b){for(var f=c[a.getSyntax()],e=[],g=0;g<f.length;g++)(!b||0==f[g].name.indexOf(b))&&e.push({TYPE:eXide.edit.Document.TYPE_TEMPLATE,name:f[g].name,template:f[g].content});return e},reload:function(a,d){var f=b.parseSnippetFile(d);
$.log("Replacing snippets %o for mode %s",f,a);b.register(f,a);c[a]=f}}}();eXide.namespace("eXide.edit.SnippetModeHelper");eXide.edit.SnippetModeHelper=function(){Constr=function(b){this.parent=b;this.editor=this.parent.editor};eXide.util.oop.inherit(Constr,eXide.edit.ModeHelper);Constr.prototype.documentSaved=function(b){var c=b.getText(),b=b.getName().replace(/\.snippets/,"");eXide.util.Snippets.reload(b,c)};return Constr}();eXide.namespace("eXide.app.FlexboxSplitter");
eXide.app.FlexboxSplitter=function(){Constr=function(b,c,a,d,f){var e=this;e.resizable=$(c);e.isHorizontal="west"==a||"east"==a;var g=e.resizable.find(".resize-handle"),c=g.find("span"),h=e.resizable.parents(".layout");e.prevSize=f;var i=!1;g.on("mousedown",function(c){c.preventDefault();var f=e.isHorizontal?c.pageX:c.pageY;i=!1;h.on("mousemove",function(c){var g=e.isHorizontal?c.pageX:c.pageY,c=f-g;i=0!==c;f=g;i&&(e.isHorizontal?(g=e.resizable.width(),c="west"==a?-c:c,g+c>=d&&e.resizable.width(g+
c)):(g=e.resizable.height(),g-(1-c)>=d&&e.resizable.height(g-(1-c))),b.resize())});$(document).on("mouseup",function(){h.off("mousemove");$(document).off("mouseup")})});c.click(function(){var c="west"==a||"east"==a?e.resizable.width():e.resizable.height();10==c?("west"==a||"east"==a?e.resizable.width(e.prevSize):e.resizable.height(e.prevSize),g.removeClass("minimized"),g.addClass("resize-handle"),e.resizable.find(">*:not(.minimized)").show()):(e.prevSize=c,"west"==a||"east"==a?e.resizable.width(10):
e.resizable.height(10),g.addClass("minimized"),g.removeClass("resize-handle"),e.resizable.find(">*:not(.minimized)").hide());b.resize()})};Constr.prototype.getSize=function(){return this.resizable.is(":hidden")?0:this.isHorizontal?this.resizable.width():this.resizable.height()};Constr.prototype.setSize=function(b){0===b?this.hide():(this.isHorizontal?this.resizable.width(b):this.resizable.height(b),10===b?(b=this.resizable.find(".resize-handle"),b.addClass("minimized"),this.resizable.find(">*:not(.minimized)").hide(),
b.removeClass("resize-handle")):(this.prevSize=b,this.resizable.find(">*:not(.minimized)").show()))};Constr.prototype.hide=function(){this.resizable.hide()};Constr.prototype.show=function(){this.resizable.is(":hidden")&&this.resizable.show();this.setSize(this.prevSize)};return Constr}();eXide.namespace("eXide.app.Layout");
eXide.app.Layout=function(){var b={west:200,south:0,east:0},c=function(a){this.editor=a;this.regions={west:new eXide.app.FlexboxSplitter(this,".panel-west","west",100,200),south:new eXide.app.FlexboxSplitter(this,".panel-south","south",100,200),east:new eXide.app.FlexboxSplitter(this,".panel-east","east",360,380)}};c.prototype.resize=function(){eXide.app.resize(!0)};c.prototype.hide=function(a){this.regions[a].hide()};c.prototype.show=function(a){this.regions[a].show()};c.prototype.saveState=function(){localStorage["eXide.layout.south"]=
this.regions.south.getSize();localStorage["eXide.layout.west"]=this.regions.west.getSize();localStorage["eXide.layout.east"]=this.regions.east.getSize()};c.prototype.restoreState=function(){for(var a in this.regions){var c=localStorage["eXide.layout."+a];c||(c=b[a]);this.regions[a].setSize(parseInt(c))}};return c}();