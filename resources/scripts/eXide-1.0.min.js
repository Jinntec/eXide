define("eXide/mode/xquery_highlight_rules",function(b,a){var e=b("ace/lib/oop"),d=b("ace/lib/lang"),c=b("ace/mode/text_highlight_rules").TextHighlightRules,f=function(){var c=d.arrayToMap("return for let where order by declare function variable xquery version option namespace import module switch default map if then else as and or typeswitch case ascending descending empty in".split(" "));this.$rules={start:[{token:"text",regex:"<\\!\\[CDATA\\[",next:"cdata"},{token:"xml_pe",regex:"<\\?.*?\\?>"},
{token:"comment",regex:"<\\!--",next:"comment"},{token:"comment",regex:"\\(:",next:"comment"},{token:"text",regex:"<\\/?",next:"tag"},{token:"constant",regex:"[+-]?\\d+(?:(?:\\.\\d*)?(?:[eE][+-]?\\d+)?)?\\b"},{token:"variable",regex:"\\$[a-zA-Z_][a-zA-Z0-9_\\-:]*\\b"},{token:"string",regex:'".*?"'},{token:"string",regex:"'.*?'"},{token:"text",regex:"\\s+"},{token:"comment",regex:"\\%\\w[\\w+_\\-:]+\\b"},{token:"support.function",regex:"\\w[\\w+_\\-:]+(?=\\()"},{token:"keyword.operator",regex:"\\*|=|<|>|\\-|\\+|and|or|eq|ne|lt|gt"},
{token:"lparen",regex:"[[({]"},{token:"rparen",regex:"[\\])}]"},{token:function(f){return c[f]?"keyword":"identifier"},regex:"[a-zA-Z_$][a-zA-Z0-9_$]*\\b"}],tag:[{token:"text",regex:">",next:"start"},{token:"keyword",regex:"[-_a-zA-Z0-9:]+"},{token:"text",regex:"\\s+"},{token:"string",regex:'".*?"'},{token:"string",regex:"'.*?'"}],cdata:[{token:"text",regex:"\\]\\]>",next:"start"},{token:"text",regex:"\\s+"},{token:"text",regex:"(?:[^\\]]|\\](?!\\]>))+"}],comment:[{token:"comment",regex:".*?--\>",
next:"start"},{token:"comment",regex:".*:\\)",next:"start"},{token:"comment",regex:".+"}]}};e.inherits(f,c);a.XQueryHighlightRules=f});
define("eXide/mode/behaviour/xquery",function(b,a){var e=b("ace/lib/oop"),d=b("ace/mode/behaviour").Behaviour,c=b("ace/mode/behaviour/cstyle").CstyleBehaviour,f=function(f){this.inherit(c,["braces","parens","string_dquotes"]);this.parent=f;this.add("brackets","insertion",function(c,f,a,d,b){return"\n"==b&&(f=a.getCursorPosition(),"</"==d.doc.getLine(f.row).substring(f.column,f.column+2))?(c=this.$getIndent(d.doc.getLine(f.row))+d.getTabString(),d=this.$getIndent(d.doc.getLine(f.row)),{text:"\n"+c+
"\n"+d,selection:[1,c.length,1,c.length]}):!1});this.add("comments","insertion",function(c,f,d,a,b){c=d.getCursorPosition();a=a.doc.getLine(c.row);if("\n"==b&&a.match(/^[\(\s]:/))return{text:"\n : ",selection:[1,3,1,3]};if(":"==b&&"("==a.substring(c.column-1,1))return $.log("cursor: %d",c.column),{text:":  :",selection:[2,2]}});this.add("slash","insertion",function(c,a,d,b,e){"/"==e&&(c=d.getCursorPosition(),a=b.doc.getLine(c.row),0<c.column&&"<"==a.charAt(c.column-1)&&(a=a.substring(0,c.column)+
"/"+a.substring(c.column),d=b.doc.getAllLines(),d[c.row]=a,f.exec("closeTag",d.join(b.doc.getNewLineCharacter()),c.row)));return!1})};e.inherits(f,d);a.XQueryBehaviour=f});
define("eXide/mode/xquery",function(b,a){var e=b("ace/lib/oop"),d=b("ace/mode/text").Mode,c=b("ace/tokenizer").Tokenizer,f=b("eXide/mode/xquery_highlight_rules").XQueryHighlightRules,g=b("eXide/mode/behaviour/xquery").XQueryBehaviour,h=b("ace/range").Range,i=function(a){this.$tokenizer=new c((new f).getRules());this.$behaviour=new g(a)};e.inherits(i,d);(function(){this.getNextLineIndent=function(c,f,a){c=this.$getIndent(f);f.match(/\s*(?:then|else|return|[{\(]|<\w+>)\s*$/)&&(c+=a);return c};this.checkOutdent=
function(c,f,a){return!/^\s+$/.test(f)?!1:/^\s*[\}\)]/.test(a)};this.autoOutdent=function(c,f,a){c=f.getLine(a).match(/^(\s*[\}\)])/);if(!c)return 0;var c=c[1].length,d=f.findMatchingBracket({row:a,column:c});if(!d||d.row==a)return 0;d=this.$getIndent(f.getLine(d.row));f.replace(new h(a,0,a,c-1),d)};this.$getIndent=function(c){return(c=c.match(/^(\s+)/))?c[1]:""};this.toggleCommentLines=function(c,f,a,d){for(var b=!0,g=/^\s*\(:(.*):\)/,c=a;c<=d;c++)if(!g.test(f.getLine(c))){b=!1;break}for(var e=new h(0,
0,0,0),c=a;c<=d;c++)a=f.getLine(c),e.start.row=c,e.end.row=c,e.end.column=a.length,f.replace(e,b?a.match(g)[1]:"(:"+a+":)")}}).call(i.prototype);a.Mode=i});
define("eXide/mode/behaviour/xml",function(b,a){function e(c,f){var a=!0,d=c.type.split(".");f.split(".").forEach(function(c){if(-1==d.indexOf(c))return a=!1});return a}var d=b("ace/lib/oop"),c=b("ace/mode/behaviour").Behaviour,f=b("ace/mode/behaviour/cstyle").CstyleBehaviour,g=b("ace/token_iterator").TokenIterator,h=function(c){this.inherit(f,["braces","parens","string_dquotes"]);this.parent=c;this.add("brackets","insertion",function(c,f,a,d,b){return"\n"==b&&(f=a.getCursorPosition(),"</"==d.doc.getLine(f.row).substring(f.column,
f.column+2))?(c=this.$getIndent(d.doc.getLine(f.row))+d.getTabString(),d=this.$getIndent(d.doc.getLine(f.row)),{text:"\n"+c+"\n"+d,selection:[1,c.length,1,c.length]}):!1});this.add("slash","insertion",function(f,a,d,b,g){"/"==g&&(f=d.getCursorPosition(),a=b.doc.getLine(f.row),0<f.column&&"<"==a.charAt(f.column-1)&&(a=a.substring(0,f.column)+"/"+a.substring(f.column),d=b.doc.getAllLines(),d[f.row]=a,c.exec("closeTag",d.join(b.doc.getNewLineCharacter()),f.row)));return!1});this.add("autoclosing","insertion",
function(c,f,a,d,b){if(">"==b){c=a.getCursorPosition();a=new g(d,c.row,c.column);d=a.getCurrentToken();f=!1;if(!d||!e(d,"meta.tag")&&(!e(d,"text")||!d.value.match("/"))){do d=a.stepBackward();while(d&&(e(d,"string")||e(d,"keyword.operator")||e(d,"entity.attribute-name")||e(d,"text")))}else f=!0;if(d&&e(d,"meta.tag-name")&&!a.stepBackward().value.match("/"))return a=d.value,f&&(a=a.substring(0,c.column-d.start)),{text:"></"+a+">",selection:[1,1]}}})};d.inherits(h,c);a.XMLBehaviour=h});
define("eXide/mode/xml",function(b,a){var e=b("ace/lib/oop"),d=b("ace/mode/xml").Mode,c=b("ace/tokenizer").Tokenizer,f=b("ace/mode/xml_highlight_rules").XmlHighlightRules,g=b("ace/mode/folding/xml").FoldMode,h=b("eXide/mode/behaviour/xml").XMLBehaviour,i=b("ace/range").Range,j=function(a){this.$tokenizer=new c((new f).getRules());this.$behaviour=new h(a);this.foldingRules=new g};e.inherits(j,d);(function(){this.toggleCommentLines=function(c,f,a,d){for(var b=!0,g=/^\s*<\!--(.*)--\>/,c=a;c<=d;c++)if(!g.test(f.getLine(c))){b=
!1;break}for(var e=new i(0,0,0,0),c=a;c<=d;c++)a=f.getLine(c),e.start.row=c,e.end.row=c,e.end.column=a.length,f.replace(e,b?a.match(g)[1]:"<\!--"+a+"--\>")}}).call(j.prototype);a.Mode=j});
define("eXide/mode/html",function(b,a){var e=b("ace/lib/oop"),d=b("ace/mode/html").Mode,c=b("ace/tokenizer").Tokenizer,f=b("ace/mode/html_highlight_rules").HtmlHighlightRules,g=b("ace/mode/folding/html").FoldMode,h=b("eXide/mode/behaviour/xml").XMLBehaviour,i=b("ace/range").Range,j=b("ace/mode/javascript").Mode,l=b("ace/mode/css").Mode,m=function(a){var d=new f;this.$tokenizer=new c(d.getRules());this.$behaviour=new h(a);this.foldingRules=new g;this.$embeds=d.getEmbeds();this.createModeDelegates({"js-":j,
"css-":l})};e.inherits(m,d);(function(){this.toggleCommentLines=function(c,f,a,d){for(var b=!0,g=/^\s*<\!--(.*)--\>/,c=a;c<=d;c++)if(!g.test(f.getLine(c))){b=!1;break}for(var e=new i(0,0,0,0),c=a;c<=d;c++)a=f.getLine(c),e.start.row=c,e.end.row=c,e.end.column=a.length,f.replace(e,b?a.match(g)[1]:"<\!--"+a+"--\>")}}).call(m.prototype);a.Mode=m});var eXide=eXide||{};eXide.namespace=function(b){var b=b.split("."),a=eXide,e;"eXide"==b[0]&&(b=b.slice(1));for(e=0;e<b.length;e++)"undefined"==typeof a[b[e]]&&(a[b[e]]={}),a=a[b[e]];return a};eXide.namespace("eXide.util");
eXide.util=function(){var b={dir1:"up",dir2:"left",firstpos1:15,firstpos2:15};return{popup:function(a,b,d,c){function f(c){h&&(h.empty(),c.find(".tooltip").each(function(){h.html($(this).html())}))}var g=$(a),h=b?$(b):null,i=null;d.sort(function(c,f){return c.label==f.label?0:c.label>f.label?1:-1});g.empty().css("display","block").focus();a=document.createElement("a");a.href="#";a.className="popup-close";a.appendChild(document.createTextNode("Close"));g.append(a);$(a).click(function(c){c.preventDefault();
g.css("display","none");h&&h.css("display","none")});a=document.createElement("ul");for(b=0;b<d.length;b++){var j=document.createElement("li");0==b&&(j.className="first");j.appendChild(document.createTextNode(d[b].label));if(d[b].tooltip){var l=document.createElement("span");l.className="tooltip";l.appendChild(document.createTextNode(d[b].tooltip));j.appendChild(l)}a.appendChild(j);$(j).click(function(){i.removeClass("selection");$(this).addClass("selection");i=$(this);f(i)});$(j).dblclick(function(){var f=
g.find("li").index(i);g.css("display","none");h&&h.css("display","none");c.call(null,d[f])})}g.append(a);i=g.find("ul li:first").addClass("selection");f(i);var m=$(a).css("position","absolute").scrollTop(0);h&&h.css({display:"block",top:m.offset().top+"px"});var n=m.innerHeight();$(g).keydown(function(a){a.preventDefault();if(40==a.which)a=i.next(),0<a.length&&(i.removeClass("selection"),a.addClass("selection"),i=a,a.position().top+a.height()>=n&&a.get(0).scrollIntoView(),f(a));else if(38==a.which)a=
i.prev(),0<a.length&&(i.removeClass("selection"),a.addClass("selection"),i=a,a.hasClass("first")?m.scrollTop(0):0>a.position().top&&a.get(0).scrollIntoView(),f(a));else if(13==a.which){var b=g.find("li").index(i);g.css("display","none");h&&h.css("display","none");$(g).unbind(a);c.call(null,d[b])}else return g.css("display","none"),h&&h.css("display","none"),$(g).unbind(a),c.call(null,null),!0;return!1})},supportsHtml5Storage:function(){try{return"localStorage"in window&&null!==window.localStorage}catch(a){return!1}},
normalizePath:function(a){if(!a)return a;for(var a=a.replace(/^xmldb:exist:\/\//,""),b=[],a=a.split("/"),d=a.length-1;-1<d;d--)".."==a[d]?d--:b.push(a[d]);return b.reverse().join("/")},parseSignature:function(a){var b=a.indexOf("(");if(-1<b){var d=a.substring(0,b+1),a=a.substring(b);if(a=a.match(/\$[\w:-_]+/g))for(b=0;b<a.length;b++)0<b&&(d+=", "),d+=a[b];return d+")"}return a},message:function(a){$.pnotify({pnotify_text:a,pnotify_shadow:!0,pnotify_hide:!0,pnotify_closer:!0,pnotify_opacity:0.75,pnotify_addclass:"stack-bottomright",
pnotify_stack:b})},error:function(a,e){var d={pnotify_text:a,pnotify_type:"error",pnotify_shadow:!0,pnotify_hide:!0,pnotify_addclass:"stack-bottomright",pnotify_stack:b};e&&(d.pnotify_title=e);$.pnotify(d)}}}();eXide.namespace("eXide.util.Dialog");
eXide.util.Dialog=function(){var b,a=null;$(document).ready(function(){$(document.body).append('<div id="eXide-dialog-message">\t<img id="eXide-dialog-message-icon" src="resources/images/error.png"/>\t<div id="eXide-dialog-message-body"></div></div>');b=$("#eXide-dialog-message");b.dialog({modal:!0,autoOpen:!1,buttons:{OK:function(){$(this).dialog("close")}}});$(document.body).append('<div id="eXide-dialog-input">\t<img id="eXide-dialog-input-icon" src="resources/images/information.png"/>\t<div id="eXide-dialog-input-body"></div></div>');
inputDialog=$("#eXide-dialog-input");inputDialog.dialog({modal:!0,autoOpen:!1,buttons:{OK:function(){$(this).dialog("close");null!=a&&a.apply($("eXide-dialog-input-body"),[])},Cancel:function(){$(this).dialog("close")}}})});return{message:function(a,d){null==d&&(d="");b.dialog("option","title",a);$("#eXide-dialog-message-body").html(d);$("#eXide-dialog-message-icon").attr("src","resources/images/information.png");b.dialog("open")},warning:function(a,d){null==d&&(d="");b.dialog("option","title",a);
$("#eXide-dialog-message-body").html(d);$("#eXide-dialog-message-icon").attr("src","resources/images/error.png");b.dialog("open")},input:function(b,d,c){a=c;inputDialog.dialog("option","title",b);$("#eXide-dialog-input-body").html(d);inputDialog.dialog("open")}}}();eXide.namespace("eXide.util.mimeTypes");
eXide.util.mimeTypes=function(){var b={xml:["text/xml","application/xml","application/xhtml+xml","application/atom+xml"],xquery:["application/xquery"],css:["text/css"],html:["text/html"],javascript:["application/x-javascript"],text:["text/text"],less:["application/less"]};return{getMime:function(a){var b=a.indexOf(";");-1<b&&(a=a.substring(0,b));return a},getLangFromMime:function(a){for(var e in b)for(var d=b[e],c=0;c<d.length;c++)if(a==d[c])return e;return"xquery"},getMimeFromLang:function(a){return(a=
b[a])?a[0]:"application/xquery"}}}();eXide.namespace("eXide.util.oop");eXide.util.oop.inherit=function(){var b=function(){};return function(a,e){b.prototype=e.prototype;a.prototype=new b;a.super_=e.prototype;a.prototype.constructor=a}}();eXide.util.oop.extend=function(){return function(b,a){for(var e in a)a.hasOwnProperty(e)&&(b[e]=a[e])}}();(function(b){b.log=function(){window.console&&window.console.log&&console.log.apply(window.console,arguments)};b.fn.log=function(){b.log(this);return this}})(jQuery);eXide.namespace("eXide.events.Sender");eXide.events.Sender=function(){Constr=function(){};Constr.prototype={addEventListener:function(b,a,e){this.events=this.events||{};var d=this.events[b];d||(d=[],this.events[b]=d);d.push({obj:a,callback:e})},$triggerEvent:function(b,a){this.events=this.events||{};var e=this.events[b];if(e)for(var d=0;d<e.length;d++)e[d].callback.apply(e[d].obj,a)}};return Constr}();eXide.namespace("eXide.edit.commands");
eXide.edit.commands=function(){function b(a){return{win:a[0],mac:a[1],sender:"editor"}}var a=require("ace/lib/useragent"),e={};return{init:function(d){commands=d.editor.commands;$.ajax({url:"keybindings.js",dataType:"json",async:!1,success:function(c){commands.addCommand({name:"fold",bindKey:b(c.fold),exec:function(c){c.editor.session.toggleFold(!1)},readOnly:!0});commands.addCommand({name:"unfold",bindKey:b(c.unfold),exec:function(c){c.editor.session.toggleFold(!0)},readOnly:!0});commands.addCommand({name:"saveDocument",
bindKey:b(c.saveDocument),exec:function(){eXide.app.saveDocument()}});commands.addCommand({name:"runQuery",bindKey:b(c.runQuery),exec:function(){eXide.app.runQuery()}});commands.addCommand({name:"openDocument",bindKey:b(c.openDocument),exec:function(){eXide.app.openDocument()}});commands.addCommand({name:"newDocument",bindKey:b(c.newDocument),exec:function(){eXide.app.newDocument()}});commands.addCommand({name:"closeDocument",bindKey:b(c.closeDocument),exec:function(){eXide.app.closeDocument()}});
commands.addCommand({name:"autocomplete",bindKey:b(c.autocomplete),exec:function(){d.autocomplete()}});commands.addCommand({name:"nextTab",bindKey:b(c.nextTab),exec:function(){d.nextTab()}});commands.addCommand({name:"previousTab",bindKey:b(c.previousTab),exec:function(){d.previousTab()}});commands.addCommand({name:"functionDoc",bindKey:b(c.functionDoc),exec:function(){d.exec("showFunctionDoc")}});commands.addCommand({name:"gotoDefinition",bindKey:b(c.gotoDefinition),exec:function(){d.exec("gotoDefinition")}});
commands.addCommand({name:"searchIncremental",bindKey:b(c.searchIncremental),exec:function(){d.quicksearch.start()}});commands.addCommand({name:"searchReplace",bindKey:b(c.searchReplace),exec:function(){d.search.open()}});commands.addCommand({name:"findModule",bindKey:b(c.findModule),exec:function(){var c=d.getActiveDocument();eXide.find.Modules.select(c.syntax)}});commands.addCommand({name:"indentOrParam",bindKey:b(c.indentOrParam),exec:function(){var c=d.getActiveDocument();(!c.template||!c.template.nextParam())&&
d.editor.indent()}});commands.addCommand({name:"escape",bindKey:b(c.escape),exec:function(){d.getActiveDocument().template=null;d.editor.clearSelection()}});commands.addCommand({name:"dbManager",bindKey:b(c.dbManager),exec:function(){eXide.app.manage()}});commands.addCommand({name:"toggleComment",bindKey:b(c.toggleComment),exec:function(){d.editor.toggleCommentLines()}});commands.addCommand({name:"synchronize",bindKey:b(c.synchronize),exec:function(){eXide.app.synchronize()}});commands.addCommand({name:"preferences",
bindKey:b(c.preferences),exec:function(){eXide.app.showPreferences()}});commands.addCommand({name:"openApp",bindKey:b(c.openApp),exec:function(){eXide.app.openApp()}});c=d.editor.commands;for(key in c.commands){var f=c.commands[key],g;f.bindKey&&(g=a.isMac?f.bindKey.mac:f.bindKey.win);e[f.name]=g}}})},help:function(d,c){$(d).find("table").each(function(){this.innerHTML="";var f=c.editor.commands;for(key in f.commands){var d=f.commands[key],b=document.createElement("tr"),e=document.createElement("td");
e.appendChild(document.createTextNode(d.name));b.appendChild(e);e=document.createElement("td");d.bindKey&&(a.isMac?e.appendChild(document.createTextNode(d.bindKey.mac)):e.appendChild(document.createTextNode(d.bindKey.win)));b.appendChild(e);this.appendChild(b)}})},getShortcut:function(a){return e[a]}}}();eXide.namespace("eXide.edit.ModeHelper");
eXide.edit.ModeHelper=function(){Constr=function(b){this.parent=b;this.editor=this.parent.editor;this.commands={};this.addCommand("locate",this.locate)};Constr.prototype={addCommand:function(b,a){this.commands||(this.commands={});this.commands[b]=a},exec:function(b,a,e){if(this.commands&&this.commands[b]){for(var a=[a],d=0;d<e.length;d++)a.push(e[d]);$.log("Calling command %s ...",b);this.commands[b].apply(this,a)}else eXide.util.message("Not supported in this mode.")},createOutline:function(){},
documentSaved:function(){},locate:function(b,a,e){"number"==typeof e&&(this.editor.gotoLine(e+1),this.editor.focus());return!1}};return Constr}();eXide.namespace("eXide.edit.XQueryModeHelper");
eXide.edit.XQueryModeHelper=function(){function b(a){var c;c=a.line?a["#text"]:a;var f=e.exec(c),b=-1;f?b=parseInt(f[1])-1:a.line&&(b=parseInt(a.line)-1);return{line:b,msg:c}}var a=/^[\$\w:\-_\.]+/;Constr=function(a){this.parent=a;this.editor=this.parent.editor;this.funcDefRe=/declare\s+((?:%[\w\:\-]+(?:\([^\)]*\))?\s*)*)function\s+([^\(]+)\(/g;this.varDefRe=/declare\s+(?:%\w+\s+)*variable\s+\$[^\s;]+/gm;this.varRe=/declare\s+(?:%\w+\s+)*variable\s+(\$[^\s;]+)/;this.parseImportRe=/import\s+module\s+namespace\s+[^=]+\s*=\s*["'][^"']+["']\s*at\s+["'][^"']+["']\s*;/g;
this.moduleRe=/import\s+module\s+namespace\s+([^=\s]+)\s*=\s*["']([^"']+)["']\s*at\s+["']([^"']+)["']\s*;/;this.addCommand("showFunctionDoc",this.showFunctionDoc);this.addCommand("gotoDefinition",this.gotoDefinition);this.addCommand("locate",this.locate);this.addCommand("closeTag",this.closeTag);this.addCommand("importModule",this.importModule)};eXide.util.oop.inherit(Constr,eXide.edit.ModeHelper);Constr.prototype.closeTag=function(a,c,f){var a="xmldb:exist://"+a.getBasePath(),g=this;$.ajax({type:"POST",
url:"modules/compile.xql",data:{q:c,base:a},dataType:"json",success:function(c){"fail"==c.result&&(c=b(c.error),c.line<=f&&(c=/constructor:\s(.*)$/.exec(c.msg),0<c.length&&g.editor.insert(c[1]+">")))},error:function(){}})};Constr.prototype.validate=function(a,c,f){$.log("Running validation...");var b=this,e="xmldb:exist://"+a.getBasePath();$.ajax({type:"POST",url:"modules/compile.xql",data:{q:c,base:e},dataType:"json",success:function(c){b.compileError(c,a);f.call(this,!0)},error:function(c,a){f.call(this,
!0);$.log("Compile error: %s - %s",a,c.responseText)}})};Constr.prototype.compileError=function(a,c){if("fail"==a.result){var f=b(a.error),g=[{row:f.line,text:f.msg,type:"error"}];this.parent.updateStatus(f.msg,c.getPath()+"#"+f.line);c.getSession().setAnnotations(g)}else this.parent.clearErrors(),this.parent.updateStatus("")};Constr.prototype.autocomplete=function(a){require("pilot/lang");for(var c=require("ace/range").Range,f=this.editor.getSelection(),b=a.getSession(),f=f.getSelectionLead(),b=
b.getDisplayLine(f.row),e=f.column-1,i=f.column;0<=e;){var j=b.substring(e,i);if(j.match(/^\$[\w:\-_\.]+$/))break;if(!j.match(/^[\w:\-_\.]+$/)){e++;break}e--}b=b.substring(e,i);$.log("completing token: %s",b);c=new c(f.row,e,f.row,i);f=this.editor.renderer.textToScreenCoordinates(f.row,f.column);e=this.parent.getHeight();f.pageY+150>e&&(f.pageY=e-150,$.log("window height: %i, pageY: %i",e,f.pageY));$("#autocomplete-box").css({left:f.pageX+"px",top:f.pageY+10+"px"});$("#autocomplete-help").css({left:f.pageX+
324+"px",top:f.pageY+10+"px"});0==b.length?this.templateLookup(a,b,c,!0):this.functionLookup(a,b,c,!0);return!0};Constr.prototype.$localVars=function(a,c){for(var f=[],b=/declare function|};/,e=/let \$[\w\:]+|for \$[\w\:]+|\$[\w\:]+\)/,i=/\$[\w\:]+/,j=RegExp("^\\"+a),l=this.editor.getSession(),m=c.start.row;-1<m;){var n=l.getDisplayLine(m),o;if(o=n.match(e))$.log("Var: %s",o[0]),o=o[0].match(i),o[0].match(j)&&f.push({name:o[0],type:"variable"});if(n.match(b)){$.log("Stop: %s",n);break}m--}return f};
Constr.prototype.functionLookup=function(a,c,f,b){var e=this;$.ajax({url:"modules/docs.xql",dataType:"text",type:"POST",data:{prefix:c},success:function(i){var i=$.parseJSON(i),j=[],l;"$"==c.substring(0,1)?(l="^\\"+c,j=e.$localVars(c,f,b)):l="^"+c;var m=RegExp(l);$.each(a.functions,function(c,a){a.name.match(m)&&j.push(a)});i&&(j=j.concat(i));i=[];for(l=0;l<j.length;l++){var n={label:j[l].signature?j[l].signature:j[l].name,type:j[l].type};j[l].help&&(n.tooltip=j[l].help);i.push(n)}e.$addTemplates(c,
i);e.$showPopup(a,f,i)},error:function(c,a){eXide.util.error(a)}})};Constr.prototype.templateLookup=function(a,c,f){var b=[];this.$addTemplates(c,b);this.$showPopup(a,f,b)};Constr.prototype.$addTemplates=function(a,c){for(var f=this.parent.outline.getTemplates(a),b=0;b<f.length;b++)c.push({type:"template",label:"[S] "+f[b].name,tooltip:f[b].help,template:f[b].template})};Constr.prototype.$showPopup=function(a,c,f){var b=this;eXide.util.popup($("#autocomplete-box"),$("#autocomplete-help"),f,function(f){if(f){var e=
f.label;"template"==f.type?e=f.template:"function"==f.type&&(e=eXide.util.parseSignature(e));a.template=new eXide.edit.Template(b.parent,c,e,f.type);a.template.insert()}b.editor.focus()})};Constr.prototype.getFunctionAtCursor=function(b){var c=b.row,c=this.editor.getSession().getDisplayLine(c),f=b.column;do f--;while(0<=f&&c.charAt(f).match(a));f++;for(b=b.column;b<c.length&&c.charAt(b).match(a);)b++;return c.substring(f,b)};Constr.prototype.showFunctionDoc=function(a){var c=this.editor.getSelection().getSelectionLead(),
b=this.editor.renderer.textToScreenCoordinates(c.row,c.column);$("#autocomplete-box").css({left:b.pageX+"px",top:b.pageY+20+"px"});$("#autocomplete-help").css({left:b.pageX+324+"px",top:b.pageY+20+"px"});c=this.getFunctionAtCursor(c);this.functionLookup(a,c,null,!1)};Constr.prototype.gotoDefinition=function(a){var c=this.editor.getSelection().getSelectionLead();(c=this.getFunctionAtCursor(c))&&this.parent.outline.gotoDefinition(a,c)};Constr.prototype.locate=function(a,c,b){switch(c){case "function":this.gotoFunction(a,
b);break;default:this.gotoVarDecl(a,b)}};Constr.prototype.gotoFunction=function(a,c){$.log("Goto function %s",c);var b=this.getModuleNamespacePrefix();null!=b&&(c=c.replace(/[^:]+:/,b+":"));for(var b=RegExp("function\\s+"+c+"\\s*\\("),e=a.$session.getLength(),h=0;h<e;h++)if(a.$session.getLine(h).match(b)){this.editor.gotoLine(h+1);this.editor.focus();break}};Constr.prototype.gotoVarDecl=function(a,c){var b=this.getModuleNamespacePrefix();null!=b&&(c=c.replace(/[^:]+:/,"$"+b+":"));$.log("Goto variable declaration %s",
c);for(var b=RegExp("variable\\s+\\"+c),e=a.$session.getLength(),h=0;h<e;h++)if(a.$session.getLine(h).match(b)){this.editor.gotoLine(h+1);this.editor.focus();break}};Constr.prototype.getModuleNamespacePrefix=function(){for(var a=/^\s*module\s+namespace\s+([^=\s]+)\s*=/,c=this.parent.getActiveDocument().$session.getLength(),b=0;b<c;b++){var e=this.parent.getActiveDocument().$session.getLine(b).match(a);if(e)return e[1]}return null};Constr.prototype.importModule=function(a,c,b,e){$.log("location = %s path = %s",
e,a.path);a=a.getBasePath();e=0===e.lastIndexOf(a,0)?e.substring(a.length+1):"xmldb:exist://"+e;this.editor.insert("import module namespace "+c+'="'+b+'" at "'+e+'";\n')};Constr.prototype.createOutline=function(a,c){var b=a.getText();this.$parseLocalFunctions(b,a);c&&c(a);(b=this.$parseImports(b))&&this.$resolveImports(a,b,c)};Constr.prototype.$sortFunctions=function(a){a.functions.sort(function(c,a){return c.source&&!a.source?1:a.source&&!c.source?-1:c.name==a.name?0:c.name>a.name?1:-1})};Constr.prototype.$parseLocalFunctions=
function(a,c){for(c.functions=[];;){var b=this.funcDefRe.exec(a);if(null==b)break;var e=this.funcDefRe.lastIndex,h=this.$findMatchingParen(a,e),i=3==b.length?b[2]:b[1],b=3==b.length?b[1]:"public";-1!==b.indexOf("%private")&&(b="private");c.functions.push({type:eXide.edit.Document.TYPE_FUNCTION,name:i,visibility:b,signature:i+"("+a.substring(e,h)+")"})}if(e=a.match(this.varDefRe))for(h=0;h<e.length;h++)i=this.varRe.exec(e[h]),c.functions.push({type:eXide.edit.Document.TYPE_VARIABLE,name:i[1]});this.$sortFunctions(c)};
Constr.prototype.$findMatchingParen=function(a,c){for(var b=1,e=c;e<a.length;e++){var h=a.charAt(e);if(")"==h){if(b-=1,0==b)return e}else"("==h&&(b+=1)}return-1};Constr.prototype.$parseImports=function(a){return a.match(this.parseImportRe)};Constr.prototype.$resolveImports=function(a,c,b){for(var e=this,h=[],i=[],j=0;j<c.length;j++){var l=this.moduleRe.exec(c[j]);null!=l&&4==l.length&&(i.push("prefix="+encodeURIComponent(l[1])),i.push("uri="+encodeURIComponent(l[2])),i.push("source="+encodeURIComponent(l[3])))}c=
"xmldb:exist://"+a.getBasePath();i.push("base="+encodeURIComponent(c));$.ajax({url:"outline",dataType:"json",type:"POST",data:i.join("&"),success:function(c){if(null!=c){for(var c=c.modules,j=0;j<c.length;j++){var i=c[j].functions;if(i)for(var l=0;l<i.length;l++)h.push({type:eXide.edit.Document.TYPE_FUNCTION,name:i[l].name,signature:i[l].signature,visibility:i[l].visibility,source:c[j].source});if(i=c[j].variables)for(l=0;l<i.length;l++)h.push({type:eXide.edit.Document.TYPE_VARIABLE,name:"$"+i[l],
source:c[j].source})}a.functions=a.functions.concat(h);e.$sortFunctions(a);b&&b(a)}}});return h};var e=/.*line:?\s(\d+)/i;return Constr}();eXide.namespace("eXide.edit.XMLModeHelper");
eXide.edit.XMLModeHelper=function(){Constr=function(b){this.parent=b;this.editor=this.parent.editor;this.addCommand("closeTag",this.closeTag)};eXide.util.oop.inherit(Constr,eXide.edit.ModeHelper);Constr.prototype.closeTag=function(b,a,e){b.getBasePath();var d=this;$.ajax({type:"POST",url:"modules/validate-xml.xql",data:{xml:a},dataType:"json",success:function(c){if(c.status&&"invalid"==c.status){var a=parseInt(c.message.line)-1;$.log("Message: %s",a);a<=e&&(c=/element type \"([^\"]+)\"/.exec(c.message["#text"]),
0<c.length&&d.editor.insert(c[1]+">"))}},error:function(){}})};Constr.prototype.validate=function(b,a,e){var d=this;$.ajax({type:"POST",url:"modules/validate-xml.xql",data:{xml:a},dataType:"json",success:function(c){d.compileError(c,b);e.call(this,!0)},error:function(c,a){e.call(this,!0);$.log("Compile error: %s - %s",a,c.responseText)}})};Constr.prototype.compileError=function(b,a){$.log("Validation returned %o",b);if(b.status&&"invalid"==b.status){var e=[{row:parseInt(b.message.line)-1,text:b.message["#text"],
type:"error"}];$.log("annotation: %o",e);this.parent.updateStatus(b.message["#text"],a.getPath()+"#"+b.message.line);a.getSession().setAnnotations(e)}else this.parent.clearErrors(),this.parent.updateStatus("")};return Constr}();eXide.namespace("eXide.edit.LessModeHelper");
eXide.edit.LessModeHelper=function(){var b=require("ace/token_iterator").TokenIterator;Constr=function(a){this.parent=a;this.editor=this.parent.editor;this.addCommand("locate",this.locate)};eXide.util.oop.inherit(Constr,eXide.edit.ModeHelper);Constr.prototype.documentSaved=function(a){var b=this,d=a.getText(),c="/exist/apps/"+a.getBasePath().replace(/^\/db\//,"")+"/";(new less.Parser({paths:[c],optimization:3})).parse(d,function(c,d){c?eXide.util.error("Error: "+c.message):b.saveCSS(a,d.toCSS())})};
Constr.prototype.saveCSS=function(a,b){var d=a.getPath().replace(/\.less$/,".css");eXide.util.message("Compiling less file to "+d);$.ajax({url:"modules/store.xql",type:"POST",data:{path:d,data:b,mime:"text/css"},dataType:"json",success:function(c){"error"==c.status?eXide.util.error(c.message):eXide.util.message(d+" stored.")},error:function(c){eXide.util.error(c.responseText)}})};Constr.prototype.createOutline=function(a,e){for(var d=new b(a.getSession(),0,0),c=d.stepForward();null!=c;){if("paren.lparen"==
c.type&&"{"==c.value){for(var c=[],f=d.getCurrentTokenRow(),g=new b(a.getSession(),f,d.getCurrentTokenColumn()),h;null!=(h=g.stepBackward())&&!(g.getCurrentTokenRow()<f);)c.push(h.value);c=c.reverse().join("");a.functions.push({type:eXide.edit.Document.TYPE_FUNCTION,name:c,source:a.getPath(),signature:c,row:d.getCurrentTokenRow(),column:d.getCurrentTokenColumn()});lastVar=""}c=d.stepForward()}e&&e(a)};return Constr}();eXide.namespace("eXide.edit.JavascriptModeHelper");
eXide.edit.JavascriptModeHelper=function(){var b=require("ace/token_iterator").TokenIterator;Constr=function(a){this.parent=a;this.editor=this.parent.editor;this.addCommand("locate",this.locate)};eXide.util.oop.inherit(Constr,eXide.edit.ModeHelper);Constr.prototype.createOutline=function(a,e){for(var d=new b(a.getSession(),0,0),c=d.stepForward();null!=c;)"entity.name.function"==c.type&&a.functions.push({type:eXide.edit.Document.TYPE_FUNCTION,name:c.value,signature:c.value,row:d.getCurrentTokenRow(),
column:d.getCurrentTokenColumn()}),c=d.stepForward();e&&e(a)};return Constr}();eXide.namespace("eXide.edit.CssModeHelper");
eXide.edit.CssModeHelper=function(){var b=require("ace/token_iterator").TokenIterator;Constr=function(a){this.parent=a;this.editor=this.parent.editor;this.addCommand("locate",this.locate)};eXide.util.oop.inherit(Constr,eXide.edit.ModeHelper);Constr.prototype.createOutline=function(a,e){for(var d=new b(a.getSession(),0,0),c=d.stepForward(),f="";null!=c;)"variable"==c.type||"keyword"==c.type?(0<f.length&&(f+=" "),f+=c.value):"paren.lparen"==c.type&&(a.functions.push({type:eXide.edit.Document.TYPE_FUNCTION,name:f,
source:a.getPath(),signature:f,row:d.getCurrentTokenRow(),column:d.getCurrentTokenColumn()}),f=""),c=d.stepForward();e&&e(a)};return Constr}();eXide.namespace("eXide.edit.Outline");
eXide.edit.Outline=function(){Constr=function(){this.currentDoc=null;this.templates=[];this.$loadTemplates()};Constr.prototype={getTemplates:function(b){for(var b=RegExp("^"+b),a=[],e=0;e<this.templates.length;e++)this.templates[e].name.match(b)&&a.push(this.templates[e]);return a},gotoDefinition:function(b,a){$.each(b.functions,function(b,d){a==d.name&&eXide.app.locate(d.type,""==d.source?null:d.source,a)})},updateOutline:function(b){var a=this;a.currentDoc=b;b.functions=[];$("#outline").fadeOut(100,
function(){$(this).empty();var e=b.getModeHelper();null!=e&&e.createOutline(b,function(){a.$outlineUpdate(b)})})},clearOutline:function(){$("#outline").empty()},$outlineUpdate:function(b){if(this.currentDoc==b){$.log("Updating outline");$("body").layout();eXide.app.resize();var a=$("#outline");a.empty();for(var e=0;e<b.functions.length;e++){var d=b.functions[e],c=document.createElement("li"),f=document.createElement("a");d.signature&&(f.title=d.signature);var g=$(f);d.type==eXide.edit.Document.TYPE_FUNCTION?
g.addClass("t_function"):g.addClass("t_variable");f.href=d.source?"#"+d.source:"#";"private"===d.visibility?g.addClass("private"):g.addClass("public");d.row&&(f.dataset.row=d.row);f.appendChild(document.createTextNode(d.name));c.appendChild(f);a.append(c);g.click(function(c){c.preventDefault();c=this.hash.substring(1);this.dataset.row?eXide.app.locate("function",c==""?null:c,parseInt(this.dataset.row)):$(this).hasClass("t_function")?eXide.app.locate("function",c==""?null:c,$(this).text()):eXide.app.locate("variable",
c==""?null:c,$(this).text())})}a.fadeIn(100)}},$loadTemplates:function(){var b=this;$.ajax({url:"templates/snippets.xml",dataType:"xml",type:"GET",success:function(a){$(a).find("snippet").each(function(){var a=$(this),d=a.attr("abbrev"),c=a.find("description").text(),a=a.find("code").text();b.templates.push({TYPE:eXide.edit.Document.TYPE_TEMPLATE,name:d,help:c,template:a})})}})}};return Constr}();eXide.namespace("eXide.edit.Document");
eXide.edit.Document=function(){Constr=function(b,a,e){this.name=b;this.path=a;this.mime=null;this.syntax="xquery";this.saved=!1;this.editable=!0;this.functions=[];this.helper=null;this.history=[];this.$session=e;b=eXide.app.getPreference("softWrap");this.$session.setUseWrapMode(0!=b);0<b?this.$session.setWrapLimitRange(b,b):0>b&&this.$session.setWrapLimitRange(null,null);this.$session.setFoldStyle("markbegin")};Constr.TYPE_FUNCTION="function";Constr.TYPE_VARIABLE="variable";Constr.TYPE_TEMPLATE="template";
Constr.prototype.getText=function(){return this.$session.getValue()};Constr.prototype.getName=function(){return this.name};Constr.prototype.getPath=function(){return this.path};Constr.prototype.setPath=function(b){this.path=b};Constr.prototype.getBasePath=function(){return this.path.replace(/(^.+)\/[^\/]*$/,"$1")};Constr.prototype.getMime=function(){return this.mime};Constr.prototype.getSyntax=function(){return this.syntax};Constr.prototype.setSyntax=function(b){this.syntax=b};Constr.prototype.getSession=
function(){return this.$session};Constr.prototype.isSaved=function(){return this.saved};Constr.prototype.isEditable=function(){return this.editable};Constr.prototype.isXQuery=function(){return"application/xquery"==this.mime};Constr.prototype.setModeHelper=function(b){this.helper=b};Constr.prototype.getModeHelper=function(){return this.helper};Constr.prototype.addToHistory=function(b){this.history.push(b)};Constr.prototype.getLastLine=function(){return this.history.pop(line)};Constr.prototype.getCurrentLine=
function(){return this.$session.getSelection().getSelectionLead().row};return Constr}();eXide.namespace("eXide.edit.Editor");
eXide.edit.Editor=function(){var b=require("ace/virtual_renderer").VirtualRenderer,a=require("ace/editor").Editor,e=require("ace/edit_session").EditSession,d=require("ace/undomanager").UndoManager;Constr=function(c,f,d){var e=this;e.container=c;e.menubar=f;e.projects=d;e.documents=[];e.activeDoc=null;e.tabCounter=0;e.newDocCounter=0;e.pendingCheck=!1;e.themes={};c=new b(e.container,"ace/theme/eclipse");c.setShowGutter(!0);this.editor=new a(c);this.editor.setBehavioursEnabled(!0);this.editor.setShowFoldWidgets(!0);
this.editor.setFadeFoldWidgets(!1);eXide.edit.commands.init(e);this.outline=new eXide.edit.Outline;this.addEventListener("activate",this.outline,this.outline.updateOutline);this.addEventListener("validate",this.outline,this.outline.updateOutline);this.addEventListener("close",this.outline,this.outline.clearOutline);this.status=document.getElementById("error-status");$(this.status).click(function(c){c.preventDefault();var a=this.pathname,c=this.hash.substring(1);if(a=e.getDocument(a))e.switchTo(a),
e.editor.gotoLine(parseInt(c)+1)});this.quicksearch=new eXide.find.IncrementalSearch($("#search-box"),this.editor);this.search=new eXide.find.SearchReplace(this.editor);var i=$("#tabs-container");i.css({overflow:"hidden"});i.mousemove(function(c){var a=i.find("ul"),b=i.width(),a=a.find("li:last-child"),a=a[0].offsetLeft+a.outerWidth(),c=(c.pageX-i.offset().left)*(a-b)/b;i.scrollLeft(c)});this.lastChangeEvent=(new Date).getTime();this.validateTimeout=null;e.modes={xquery:new eXide.edit.XQueryModeHelper(e),
xml:new eXide.edit.XMLModeHelper(e),html:new eXide.edit.XMLModeHelper(e),less:new eXide.edit.LessModeHelper(e),javascript:new eXide.edit.JavascriptModeHelper(e)}};eXide.util.oop.inherit(Constr,eXide.events.Sender);Constr.prototype.init=function(){0==this.documents.length&&this.newDocument()};Constr.prototype.exec=function(){if(this.activeDoc.getModeHelper()){var c=Array.prototype.slice.call(arguments,1);this.activeDoc.getModeHelper().exec(arguments[0],this.activeDoc,c)}else eXide.util.message("Not supported in this mode.")};
Constr.prototype.getActiveDocument=function(){return this.activeDoc};Constr.prototype.getText=function(){return this.activeDoc.getText()};Constr.prototype.newDocument=function(c,a){for(var b=0,d=0;d<this.documents.length;d++)this.documents[d].path.match(/^__new__(\d+)/)&&(b=parseInt(RegExp.$1));b++;d=c&&"string"==typeof c?new e(c):a&&"xquery"===a?new e('xquery version "3.0";\n'):new e("");b=new eXide.edit.Document("new-document "+b,"__new__"+b,d);a?b.setSyntax(a):b.setSyntax("text");this.$initDocument(b)};
Constr.prototype.newDocumentWithText=function(c,a,b){c=new eXide.edit.Document(b.name,b.path,new e(c));c.editable=b.writable;c.mime=a;c.syntax=eXide.util.mimeTypes.getLangFromMime(a);c.saved=!1;b.line&&(c.addToHistory(b.line),this.editor.gotoLine(b.line));this.$initDocument(c)};Constr.prototype.openDocument=function(c,a,b){b.writable?eXide.util.message("Opening "+b.path):eXide.util.message("Opening "+b.path+" readonly!");c=new eXide.edit.Document(b.name,b.path,new e(c));c.editable=b.writable;c.mime=
a;c.syntax=eXide.util.mimeTypes.getLangFromMime(a);c.saved=!0;b.line&&(c.addToHistory(b.line),a=c.$session.getSelection(),a.clearSelection(),a.moveCursorTo(b.line,1),c.$session.setScrollTop(b.line));$.log("opening %s, mime: %s, syntax: %s, line: %i",b.name,c.mime,c.syntax,b.line);this.$initDocument(c)};Constr.prototype.$initDocument=function(c){var a=this;a.$setMode(c,!1);c.$session.setUndoManager(new d);c.$session.addEventListener("change",function(){c.saved&&(c.saved=!1,a.updateTabStatus(c.path,
c));a.triggerCheck()});a.addTab(c);a.editor.setSession(c.$session);a.editor.resize();a.editor.focus()};Constr.prototype.setMode=function(c){this.activeDoc.syntax=c;this.$setMode(this.activeDoc,!0)};Constr.prototype.$setMode=function(c,a){switch(c.getSyntax()){case "xquery":var b=require("eXide/mode/xquery").Mode;c.$session.setMode(new b(this));a&&(c.mime="application/xquery");break;case "xml":b=require("eXide/mode/xml").Mode;c.$session.setMode(new b(this));a&&(c.mime="application/xml");break;case "html":b=
require("eXide/mode/html").Mode;c.$session.setMode(new b(this));a&&(c.mime="text/html");break;case "javascript":b=require("ace/mode/javascript").Mode;c.$session.setMode(new b);a&&(c.mime="application/x-javascript");break;case "css":b=require("ace/mode/css").Mode;c.$session.setMode(new b);a&&(c.mime="text/css");break;case "text":b=require("ace/mode/text").Mode,c.$session.setMode(new b),a&&(c.mime="text/text");case "less":b=require("ace/mode/less").Mode,c.$session.setMode(new b),a&&(c.mime="application/less")}c.setModeHelper(this.modes[c.getSyntax()])};
Constr.prototype.closeDocument=function(){this.$triggerEvent("close",[this.activeDoc]);$('#tabs a[title="'+this.activeDoc.path+'"]').parent().remove();this.menubar.remove("buffers",this.activeDoc.path);for(var c=0;c<this.documents.length;c++)this.documents[c].path==this.activeDoc.path&&this.documents.splice(c,1);0==this.documents.length?this.newDocument(null,"xquery"):(this.activeDoc=this.documents[this.documents.length-1],$('#tabs a[title="'+this.activeDoc.path+'"]').addClass("active"),this.editor.setSession(this.activeDoc.$session),
this.editor.resize(),this.$triggerEvent("activate",[this.activeDoc]))};Constr.prototype.saveDocument=function(c,a,b){var d=this,e=d.activeDoc.path,j=d.activeDoc.name;c&&(d.activeDoc.path=c.path,d.activeDoc.name=c.name);eXide.util.message("Storing resource "+d.activeDoc.name+"...");c={path:d.activeDoc.path,data:d.activeDoc.getText()};d.activeDoc.mime&&(c.mime=d.activeDoc.mime);$.ajax({url:"modules/store.xql",type:"POST",data:c,dataType:"json",success:function(c){if(c.status=="error")b?b.apply(d.activeDoc,
[c.message]):eXide.util.error(c.message);else{d.activeDoc.saved=true;d.updateTabStatus(e,d.activeDoc);a?a.apply(d.activeDoc):eXide.util.message(d.activeDoc.name+" stored.");(c=d.activeDoc.getModeHelper())&&c.documentSaved(d.activeDoc)}},error:function(c){d.activeDoc.path=e;d.activeDoc.name=j;b?b.apply(d.activeDoc,c.responseText):eXide.util.error(c.responseText)}})};Constr.prototype.reload=function(c){this.activeDoc.getSession().setValue(c)};Constr.prototype.getDocument=function(c){for(var c=eXide.util.normalizePath(c),
a=0;a<this.documents.length;a++)if(this.documents[a].path==c)return this.documents[a]};Constr.prototype.onInput=function(c,a){var b=c.getModeHelper();if(b&&b.onInput)b.onInput(c,a)};Constr.prototype.autocomplete=function(){var c=this.activeDoc.getModeHelper();c&&c.autocomplete&&c.autocomplete(this.activeDoc)};Constr.prototype.getHeight=function(){return $(this.container).height()};Constr.prototype.resize=function(){this.editor.resize()};Constr.prototype.clearErrors=function(){this.editor.getSession().clearAnnotations()};
Constr.prototype.forEachDocument=function(c){for(var a=0;a<this.documents.length;a++)c(this.documents[a])};Constr.prototype.addTab=function(c){var a=this,b="t"+a.tabCounter++,d=c.name;c.saved||(d+="*");$("#tabs li a").removeClass("active");var e=document.createElement("li"),j=document.createElement("a");j.appendChild(document.createTextNode(d));j.className="tab active";j.id=b;j.title=c.path;e.appendChild(j);$("#tabs").append(e);$(j).click(function(b){b.preventDefault();a.switchTo(c)});a.menubar.add("buffers",
d,j.title,function(){a.switchTo(c)});a.activeDoc=c;a.documents.push(c);a.$triggerEvent("activate",[c]);a.scrollToTab($(j))};Constr.prototype.nextTab=function(){if(!(2>this.documents.length)){for(var c=0,a=0;a<this.documents.length;a++)if(this.documents[a]==this.activeDoc){c=a;break}c==this.documents.length-1?c=0:c++;this.switchTo(this.documents[c])}};Constr.prototype.previousTab=function(){if(!(2>this.documents.length)){for(var c=0,a=0;a<this.documents.length;a++)if(this.documents[a]==this.activeDoc){c=
a;break}0==c?c=this.documents.length-1:c--;this.switchTo(this.documents[c])}};Constr.prototype.switchTo=function(c){this.editor.setSession(c.$session);this.editor.resize();this.activeDoc=c;var a=this;$("#tabs a").each(function(){var b=$(this);this.title==c.path?(b.addClass("active"),a.scrollToTab(b)):b.removeClass("active")});this.updateStatus("");this.$triggerEvent("activate",[c])};Constr.prototype.updateTabStatus=function(c,a){var b;b=a.saved?a.name:a.name+"*";$('#tabs a[title="'+c+'"]').attr("title",
a.path).text(b)};Constr.prototype.scrollToTab=function(c){var a=c.offset().left,c=a+c.outerWidth(),b=$("#tabs-container").innerWidth(),d=$("#tabs-container").scrollLeft();c>b?$("#tabs-container").scrollLeft(c-b):a<d&&(a<b?$("#tabs-container").scrollLeft(0):$("#tabs-container").scrollLeft(a));$.log("Scrolling to %d %d",a,$("#tabs-container").scrollLeft())};Constr.prototype.setTheme=function(c){$.log("Changing theme to %s",c);var a=this;a.loadTheme(c,function(){a.editor.setTheme("ace/theme/"+c)})};
Constr.prototype.loadTheme=function(c,a){if(this.themes[c])return a();require("ace/lib/net");this.themes[c]=1;var b="$shared/resources/scripts/ace/theme-"+c.split("/").pop()+".js",d=document.getElementsByTagName("head")[0],e=document.createElement("script");e.src=b;d.appendChild(e);e.onload=a};Constr.prototype.updateStatus=function(a,b){this.status.innerHTML=a;b&&(this.status.href=b)};Constr.prototype.triggerCheck=function(){if(this.activeDoc.getModeHelper()){var a=this;if(!a.pendingCheck){var b=
(new Date).getTime();a.validateTimeout&&2E3>b-a.lastChangeEvent&&clearTimeout(a.validateTimeout);a.lastChangeEvent=b;a.validateTimeout=setTimeout(function(){a.validate.apply(a)},2E3)}}};Constr.prototype.validate=function(){var a=this;a.$triggerEvent("validate",[a.activeDoc]);var b=a.activeDoc.getModeHelper();b&&b.validate&&(a.pendingCheck=!0,$.log("Running validation..."),b.validate(a.activeDoc,a.getText(),function(){a.pendingCheck=!1}))};Constr.prototype.evalError=function(a){var b=/.*line\s(\d+)/i.exec(a),
d=-1;b&&(d=parseInt(b[1]));$.log("error in line %d",b[1]);this.editor.focus();this.editor.gotoLine(d);b=[{row:d-1,text:a,type:"error"}];this.updateStatus(a);this.editor.getSession().setAnnotations(b)};Constr.prototype.focus=function(){this.editor.focus()};Constr.prototype.saveState=function(){var a=0;$.each(this.documents,function(b,d){if(d.path.match("^__new__.*")){var e=d.getText();e&&0<e.length&&(localStorage["eXide."+a+".path"]=d.path,localStorage["eXide."+a+".name"]=d.name,localStorage["eXide."+
a+".mime"]=d.mime,localStorage["eXide."+a+".data"]=d.getText(),localStorage["eXide."+a+".last-line"]=d.getCurrentLine())}else localStorage["eXide."+a+".path"]=d.path,localStorage["eXide."+a+".name"]=d.name,localStorage["eXide."+a+".mime"]=d.mime,localStorage["eXide."+a+".writable"]=d.editable?"true":"false",localStorage["eXide."+a+".last-line"]=d.getCurrentLine(),d.saved||(localStorage["eXide."+a+".data"]=d.getText());a++});localStorage["eXide.documents"]=a};return Constr}();$(document).ready(function(){var b;var a=window.location.search.substr(1).split("&");if(""==a)b={};else{for(var e={},d=0;d<a.length;++d){var c=a[d].split("=");2==c.length&&(e[c[0]]=decodeURIComponent(c[1].replace(/\+/g," ")))}b=e}eXide.app.init(function(a){var c=b.open,d=b.snip;c&&!a[c]?eXide.app.findDocument(b.open):d&&eXide.app.newDocument(d);"function"==typeof eXide_onload&&eXide_onload(eXide.app)})});eXide.namespace("eXide.app");
eXide.app=function(){var b,a,e,d,c,f=0,g=0,h=0,i=0;return{init:function(f){var g=new eXide.util.Menubar($(".menu"));d=new eXide.edit.Projects;b=new eXide.edit.Editor(document.getElementById("editor"),g);a=new eXide.edit.PackageEditor(d);e=new eXide.browse.Browser(document.getElementById("open-dialog"));a.addEventListener("change",null,function(){e.onChange();eXide.app.openDocument()});c=new eXide.util.Preferences(b);eXide.app.initGUI(g);g=eXide.app.restoreState();b.init();b.addEventListener("outlineChange",
eXide.app.onOutlineChange);$(window).resize(eXide.app.resize);$(window).unload(function(){eXide.app.saveState()});eXide.find.Modules.addEventListener("open",null,function(a){eXide.app.findDocument(a.at)});eXide.find.Modules.addEventListener("import",null,function(a){b.exec("importModule",a.prefix,a.uri,a.at)});f&&f(g)},resize:function(){$("#editor");$(".header");b.resize()},newDocument:function(a,c){b.newDocument(a,c)},findDocument:function(a){var c=b.getDocument(a);null==c?(a={name:a.match(/[^\/]+$/),
path:a},eXide.app.$doOpenDocument(a)):b.switchTo(c)},locate:function(a,c,d){if(null==c)b.exec("locate",a,d);else{$.log("Locating %s in document %s",d,c);var e=b.getDocument(c);null==e?(c={name:c.match(/[^\/]+$/),path:c},eXide.app.$doOpenDocument(c,function(){b.exec("locate",a,d)})):(b.switchTo(e),b.exec("locate",a,d))}},openDocument:function(){e.reload(["reload"],"open");$("#open-dialog").dialog("option","title","Open Document");$("#open-dialog").dialog("option","buttons",{cancel:function(){$(this).dialog("close");
b.focus()},open:eXide.app.openSelectedDocument});$("#open-dialog").dialog("open")},openSelectedDocument:function(a){var c=e.getSelection();c&&eXide.app.$doOpenDocument(c);(void 0==a||a)&&$("#open-dialog").dialog("close")},$doOpenDocument:function(a,c,d){a.path=eXide.util.normalizePath(a.path);var e=b.getDocument(a.path);if(e&&!d)return b.switchTo(e),!0;$.ajax({url:"modules/load.xql?path="+a.path,dataType:"text",success:function(e,f,g){d?b.reload(e):(f=eXide.util.mimeTypes.getMime(g.getResponseHeader("Content-Type")),
b.openDocument(e,f,a));c&&c.call(null,a);return!0},error:function(c){eXide.util.error("Failed to load document "+a.path+": "+c.status+" "+c.statusText);return!1}})},reloadDocument:function(){var a=b.getActiveDocument();a.isSaved()?eXide.app.$reloadDocument(a):eXide.util.Dialog.input("Reload Document","Do you really want to reload the document?",function(){eXide.app.$reloadDocument(a)})},$reloadDocument:function(a){a={name:a.getName(),path:a.getPath()};eXide.app.$doOpenDocument(a,null,!0)},closeDocument:function(){b.getActiveDocument().isSaved()?
b.closeDocument():$("#dialog-confirm-close").dialog({resizable:!1,height:140,modal:!0,buttons:{Close:function(){$(this).dialog("close");b.closeDocument()},Cancel:function(){$(this).dialog("close")}}})},saveDocument:function(){eXide.app.requireLogin(function(){b.getActiveDocument().getPath().match("^__new__")?(e.reload(["reload","create"],"save"),$("#open-dialog").dialog("option","title","Save Document"),$("#open-dialog").dialog("option","buttons",{Cancel:function(){$(this).dialog("close")},Save:function(){b.saveDocument(e.getSelection(),
function(){$("#open-dialog").dialog("close");a.autoSync(b.getActiveDocument().getBasePath())},function(a){eXide.util.Dialog.warning("Failed to Save Document",a)})}}),$("#open-dialog").dialog("open")):b.saveDocument(null,function(){eXide.util.message(b.getActiveDocument().getName()+" stored.");a.autoSync(b.getActiveDocument().getBasePath())},function(a){eXide.util.Dialog.warning("Failed to Save Document",a)})})},saveDocumentAs:function(){eXide.app.requireLogin(function(){e.reload(["reload","create"],
"save");$("#open-dialog").dialog("option","title","Save Document As ...");$("#open-dialog").dialog("option","buttons",{Cancel:function(){$(this).dialog("close")},Save:function(){b.saveDocument(e.getSelection(),function(){$("#open-dialog").dialog("close");a.autoSync(b.getActiveDocument().getBasePath())},function(a){eXide.util.Dialog.warning("Failed to Save Document",a)})}});$("#open-dialog").dialog("open")})},exec:function(){b.exec(arguments)},download:function(){var a=b.getActiveDocument();a.getPath().match("^__new__")||
!a.isSaved()?eXide.util.error("There are unsaved changes in the document. Please save it first."):window.location.href="modules/load.xql?download=true&path="+encodeURIComponent(a.getPath())},runQuery:function(){b.updateStatus("Running query ...");var a=b.getText(),c="xmldb:exist://"+b.getActiveDocument().getBasePath();$("#results-container .results").empty();$.ajax({type:"POST",url:"execute",dataType:"xml",data:{qu:a,base:c},success:function(a){a=a.documentElement;if("error"==a.nodeName)a=$(a).text(),
eXide.util.error(a,"Compilation Error"),b.evalError(a);else{b.updateStatus("");b.clearErrors();var c=$("body").layout();c.open("south");c.sizePane("south",300);eXide.app.resize();h=g=1;f=a.getAttribute("hits");i=g+10-1;f<i&&(i=f);eXide.util.message("Found "+f+" in "+a.getAttribute("elapsed")+"s");eXide.app.retrieveNext()}},error:function(a){eXide.util.error(a.responseText,"Server Error")}})},checkQuery:function(){b.validate()},retrieveNext:function(){$.log("retrieveNext: %d",h);if(0<h&&h<=i){var a=
"results/"+h;h++;$.ajax({url:a,dataType:"html",success:function(a){$("#results-container .results").append(a);$("#results-container .current").text("Showing results "+g+" to "+(h-1)+" of "+f);$("#results-container .pos:last a").click(function(){eXide.app.findDocument(this.pathname);return!1});eXide.app.retrieveNext()}})}},browseNext:function(){0<h&&i<f&&(g=h,i=h+10-1,f<i&&(i=f),$("#results-container .results").empty(),eXide.app.retrieveNext());return!1},browsePrevious:function(){0<h&&1<g&&(g-=10,
1>g&&(g=1),h=g,i=h+9,f<i&&(i=f),$("#results-container .results").empty(),eXide.app.retrieveNext());return!1},manage:function(){eXide.app.requireLogin(function(){e.reload("reload create upload properties open cut copy paste".split(" "),"manage");$("#open-dialog").dialog("option","title","DB Manager");$("#open-dialog").dialog("option","buttons",{Close:function(){$(this).dialog("close")}});$("#open-dialog").dialog("open")})},deploymentSettings:function(){var c=b.getActiveDocument().getPath(),d=/^(.*)\/[^\/]+$/.exec(c);
d&&eXide.app.requireLogin(function(){$.log("Editing deployment settings for collection: %s",d[1]);a.open(d[1])})},newDeployment:function(){eXide.app.requireLogin(function(){a.open()})},deploy:function(){eXide.app.requireLogin(function(){var c=b.getActiveDocument().getPath(),c=/^(.*)\/[^\/]+$/.exec(c);if(!c)return eXide.util.error("The file open in the editor does not belong to an application package!"),!1;$.log("Deploying application from collection: %s",c[1]);a.deploy(c[1])});return!1},synchronize:function(){eXide.app.requireLogin(function(){var c=
b.getActiveDocument().getPath();(c=/^(.*)\/[^\/]+$/.exec(c))?a.synchronize(c[1]):eXide.util.error("The file open in the editor does not belong to an application package!")})},downloadApp:function(){eXide.app.requireLogin(function(){var c=b.getActiveDocument().getPath(),c=/^(.*)\/[^\/]+$/.exec(c);$.log("downloading %s",c);c?a.download(c[1]):eXide.util.error("The file open in the editor does not belong to an application package!")})},openApp:function(){var c=b.getActiveDocument().getPath();(c=/^(.*)\/[^\/]+$/.exec(c))?
a.runApp(c[1]):eXide.util.error("The file open in the editor does not belong to an application package!")},restoreState:function(){if(!eXide.util.supportsHtml5Storage)return!1;c.read();var d={},e=localStorage["eXide.documents"];e||(e=0);for(var f=0;f<e;f++){var g={path:localStorage["eXide."+f+".path"],name:localStorage["eXide."+f+".name"],writable:"true"==localStorage["eXide."+f+".writable"],line:parseInt(localStorage["eXide."+f+".last-line"])};$.log("Restoring doc %s, going to line = %i",g.path,
g.line);var h=localStorage["eXide."+f+".data"];h?b.newDocumentWithText(h,localStorage["eXide."+f+".mime"],g):eXide.app.$doOpenDocument(g);d[g.path]=g}b.getActiveDocument()||eXide.app.newDocument("","xquery");a.restoreState();return d},saveState:function(){eXide.util.supportsHtml5Storage&&(localStorage.clear(),c.save(),b.saveState(),a.saveState())},getLogin:function(){$.ajax({url:"login",dataType:"json",success:function(a){eXide.app.login=a;$("#user").text("Logged in as "+eXide.app.login+". ")},error:function(){eXide.app.login=
null}})},$checkLogin:function(){if(eXide.app.login)return!0;eXide.util.error("Warning: you are not logged in.");return!1},requireLogin:function(a){eXide.app.login?a():($("#login-dialog").dialog("option","close",function(){eXide.app.login?a():eXide.util.error("Warning: you are not logged in!")}),$("#login-dialog").dialog("open"))},showPreferences:function(){c.show()},getPreference:function(a){return c.get(a)},initGUI:function(a){eXide.app.getLogin();var f=$("body").layout({enableCursorHotkey:!1,north__size:70,
north__resizable:!1,north__closable:!0,north__showOverflowOnHover:!0,south__minSize:200,south__initClosed:!0,west__size:200,west__initClosed:!1,west__contentSelector:".content",center__minSize:300,center__onresize:eXide.app.resize,center__contentSelector:".content"});$("#open-dialog").dialog({title:"Open file",modal:!1,autoOpen:!1,height:480,width:700,open:function(){e.init()},resize:function(){e.resize()}});$("#login-dialog").dialog({title:"Login",modal:!0,autoOpen:!1,buttons:{Login:function(){var a=
$('#login-form input[name="user"]').val(),c=$('#login-form input[name="password"]').val(),a={user:a,password:c};$('#login-form input[name="duration"]').is(":checked")&&(a.duration="P14D");$.ajax({url:"login",data:a,dataType:"json",success:function(){eXide.app.login=$('#login-form input[name="user"]').val();$.log("Logged in as %s",eXide.app.login);$("#login-dialog").dialog("close");$("#user").text("Logged in as "+eXide.app.login+". ");b.focus()},error:function(){$("#login-error").text("Login failed. Bad username or password.");
$("#login-dialog input:first").focus()}})},Cancel:function(){$(this).dialog("close");b.focus()}},open:function(){$(this).find("input").val("");$(this).find("input:first").focus();$("#login-error").empty();var a=$(this);a.find("input").keyup(function(c){13==c.keyCode&&a.parent().find(".ui-dialog-buttonpane button:first").trigger("click")})}});$("#keyboard-help").dialog({title:"Keyboard Shortcuts",modal:!1,autoOpen:!1,height:400,buttons:{Close:function(){$(this).dialog("close")}},open:function(){eXide.edit.commands.help($("#keyboard-help"),
b)}});$("#about-dialog").dialog({title:"About",modal:!1,autoOpen:!1,height:300,width:450,buttons:{Close:function(){$(this).dialog("close")}}});var g=$("#open").button({icons:{primary:"ui-icon-folder-open"}});g.click(eXide.app.openDocument);a.click("#menu-file-open",eXide.app.openDocument,"openDocument");g=$("#close").button({icons:{primary:"ui-icon-close"}});g.click(eXide.app.closeDocument);a.click("#menu-file-close",eXide.app.closeDocument,"closeDocument");g=$("#new").button({icons:{primary:"ui-icon-document"}});
g.click(function(){eXide.app.newDocument(null,"xquery")});a.click("#menu-file-new",eXide.app.newDocument,"newDocument");a.click("#menu-file-new-xquery",function(){eXide.app.newDocument(null,"xquery")},"newXQuery");g=$("#run").button({icons:{primary:"ui-icon-play"}});g.click(eXide.app.runQuery);g=$("#validate").button({icons:{primary:"ui-icon-check"}});g.click(eXide.app.checkQuery);g=$("#save").button({icons:{primary:"ui-icon-disk"}});g.click(eXide.app.saveDocument);a.click("#menu-file-save",eXide.app.saveDocument,
"saveDocument");a.click("#menu-file-save-as",eXide.app.saveDocumentAs);a.click("#menu-file-reload",eXide.app.reloadDocument);g=$("#download").button({icons:{primary:"ui-icon-transferthick-e-w"}});g.click(eXide.app.download);a.click("#menu-file-download",eXide.app.download);a.click("#menu-file-manager",eXide.app.manage,"dbManager");a.click("#menu-deploy-new",eXide.app.newDeployment);a.click("#menu-deploy-edit",eXide.app.deploymentSettings);a.click("#menu-deploy-deploy",eXide.app.deploy);a.click("#menu-deploy-sync",
eXide.app.synchronize,"synchronize");a.click("#menu-deploy-download",eXide.app.downloadApp);a.click("#menu-edit-undo",function(){b.editor.undo()},"undo");a.click("#menu-edit-redo",function(){b.editor.redo()},"redo");a.click("#menu-edit-find",function(){b.quicksearch.start()},"searchIncremental");a.click("#menu-edit-toggle-comment",function(){b.editor.toggleCommentLines()},"toggleComment");a.click("#menu-edit-preferences",function(){c.show()},"preferences");a.click("#menu-navigate-definition",function(){b.exec("gotoDefinition")},
"gotoDefinition");a.click("#menu-navigate-modules",function(){var a=b.getActiveDocument();eXide.find.Modules.select(a.syntax)},"findModule");a.click("#menu-navigate-info",function(){b.exec("showFunctionDoc")},"functionDoc");a.click("#menu-deploy-run",eXide.app.openApp,"openApp");a.click("#menu-help-keyboard",function(){$("#keyboard-help").dialog("open")});a.click("#menu-help-about",function(){$("#about-dialog").dialog("open")});a.click("#menu-help-hints",function(){eXide.util.Help.show()});$("#syntax").change(function(){b.setMode($(this).val())});
b.addEventListener("activate",null,function(a){$("#syntax").val(a.getSyntax());(a=d.getProjectFor(a.getBasePath()))?($("#toolbar-current-app").text(a.abbrev),$("#menu-deploy-active").text(a.abbrev)):($("#toolbar-current-app").text("unknown"),$("#menu-deploy-active").text("unknown"))});$("#user").click(function(a){a.preventDefault();eXide.app.login?($.get("login?logout=logout"),$("#user").text("Login"),eXide.app.login=null):$("#login-dialog").dialog("open")});$("#results-container .next").click(eXide.app.browseNext);
$("#results-container .previous").click(eXide.app.browsePrevious);f.toggle("south");f.toggle("south");$("#error-status").mouseover(function(){var a=this;$("#ext-status-bar").each(function(){this.innerHTML=a.innerHTML;$(this).css("display","block")})});$("#ext-status-bar").mouseout(function(){$(this).css("display","none")})}}}();eXide.namespace("eXide.edit.Projects");
eXide.edit.Projects=function(){Constr=function(){this.projects={}};Constr.prototype.getProject=function(b,a){var e=this;$.getJSON("modules/deployment.xql",{info:b},function(b){if(b){var c=e.projects[b.abbrev];c?eXide.util.oop.extend(c,b):(c=b,e.projects[b.abbrev]=c);"function"==typeof a&&a(c)}else eXide.util.error("Application not found: The document currently opened in the editor should belong to an application package.")})};Constr.prototype.getProjectFor=function(b){for(k in this.projects){var a=this.projects[k];
if(b.substring(0,a.root.length)===a.root)return a}return null};Constr.prototype.saveState=function(){localStorage["eXide.projects"]=JSON.stringify(this.projects)};Constr.prototype.restoreState=function(){localStorage["eXide.projects"]&&(this.projects=JSON.parse(localStorage["eXide.projects"]),"object"!=typeof this.projects&&(this.projects={}))};return Constr}();eXide.namespace("eXide.edit.PackageEditor");
eXide.edit.PackageEditor=function(){Constr=function(b){var a=this;this.projects=b;this.currentProject=null;this.container=$("#dialog-deploy");this.container.dialog({title:"Deployment Editor",modal:!1,autoOpen:!1,width:520,height:600});this.syncDialog=$("#synchronize-dialog");this.syncDialog.dialog({title:"Synchronize to Directory",modal:!1,autoOpen:!1,width:500,height:400,buttons:{Apply:function(){var b=a.syncDialog.find('input[name="dir"]').val();b&&0<b.length&&(a.currentProject.dir=b);a.currentProject.autoSync=
a.syncDialog.find('input[name="auto"]').is(":checked");$(this).dialog("close")},Synchronize:function(){var b=a.syncDialog.find('input[name="dir"]').val();!b||0==b.length?$("#synchronize-report").text("No output directory specified!"):(a.currentProject.dir=b,b=a.syncDialog.find("form").serialize(),$("#synchronize-report").text("Synchronization in progress ..."),$("#synchronize-report").load("modules/synchronize.xql",b))},Close:function(){$(this).dialog("close")}}})};eXide.util.oop.inherit(Constr,eXide.events.Sender);
Constr.prototype.open=function(b){var a=this,e=null;b&&(e={collection:b});$.ajax({url:"modules/deployment.xql",type:"POST",data:e,success:function(d){a.container.html(d);a.container.form({done:function(){var c=a.container.find("form").serialize();$.ajax({url:"modules/deployment.xql",type:"POST",data:c,success:function(){a.container.dialog("close");a.$triggerEvent("change",b)},error:function(a){eXide.util.error(a.responseText)}})},cancel:function(){a.container.dialog("close")}});a.container.find(".author-repeat").repeat("#author-add-trigger",
{deleteTrigger:"#author-remove-trigger"});a.container.dialog("open")},error:function(a){eXide.util.error(a.responseText)}})};Constr.prototype.deploy=function(b){var a=this;eXide.util.Dialog.input("Deploy",'<p>Note: target has to be different from the source package or it will be overwritten!</p><p><label for="target">Target collection:</label><input id="deployment-target" type="text" name="target" value="'+b+'-test"size="30"/></p>',function(){var e=$("#deployment-target").val();""===e&&(e=b);$.ajax({url:"modules/deployment.xql",
type:"POST",dataType:"json",data:{collection:b,target:e,deploy:"true"},success:function(d){d=location.protocol+"//"+location.hostname+":"+location.port+"/exist/apps/"+d+"/";eXide.util.Dialog.message("Application Deployed",'<p>The application has been deployed. On a standard installation the following link should open it:</p><center><a href="'+d+'" target="_new">'+d+"</a></center>");a.$triggerEvent("change",b)},error:function(a){404==a.status?eXide.util.error("Deployment failed. The document currently opened in the editor should belong to an application package."):
eXide.util.Dialog.warning("Deployment Error","<p>An error has been reported by the database:</p><p>"+a.responseText+"</p>")}})})};Constr.prototype.download=function(b){window.location.href="modules/deployment.xql?download=true&collection="+encodeURIComponent(b)};Constr.prototype.synchronize=function(b){var a=this;a.projects.getProject(b,function(b){b.isAdmin?(a.currentProject=b,a.syncDialog.find(".project-name").text(b.abbrev),a.syncDialog.find('input[name="start"]').val(b.deployed),b.dir&&a.syncDialog.find('input[name="dir"]').val(b.dir),
a.syncDialog.find('input[name="collection"]').val(b.root),a.syncDialog.find('input[name="auto"]').attr("checked",b.autoSync),a.syncDialog.dialog("open")):eXide.util.error("You need to be logged in as an admin user with dba role to use this feature.")})};Constr.prototype.autoSync=function(b){(b=this.projects.getProjectFor(b))&&b.autoSync&&$.ajax({url:"modules/synchronize.xql",type:"GET",data:{collection:b.root,start:b.deployed,dir:b.dir},success:function(){eXide.util.message("Synchronized directory")}})};
Constr.prototype.runApp=function(b){this.projects.getProject(b,function(a){var b="/exist/apps/"+a.root.replace(/^\/db\//,"")+"/";eXide.util.Dialog.message("Run Application "+a.abbrev,'<p>Click on the following link to open your application:</p><center><a href="'+b+'" target="_new">'+b+"</a></center>")})};Constr.prototype.saveState=function(){this.projects.saveState()};Constr.prototype.restoreState=function(){this.projects.restoreState()};return Constr}();eXide.namespace("eXide.edit.Template");
eXide.edit.Template=function(){var b=/\n/;Constr=function(a,e,d,c){var f=d.split(b).length;this.code=d;this.editor=a.editor;this.range=e;this.type=c;this.startLine=e.start.row;this.endLine=this.startLine+f-1;$.log("startLine = %i, endLine = %i",this.startLine,this.endLine);this.currentLine=this.startLine;this.lineOffset=this.startColumn=e.start.column;this.regex=/\$[\w\-:_]+/g;0<this.startColumn&&(this.regex.lastIndex=this.startColumn)};Constr.prototype={insert:function(){this.editor.getSession().remove(this.range);this.editor.insert(this.code);
var a=this.editor.getSelection().getSelectionLead();"$"!=this.code.substring(0,1)&&0<a.column&&this.editor.navigateLeft();"variable"!=this.type&&this.nextParam();this.editor.focus()},nextParam:function(){var a=this.editor.getSession(),b=this.editor.getSelection(),d=b.getSelectionLead();$.log("lead.row = %i startLine = %i",d.row,this.startLine);if(d.row<this.startLine||d.row>this.endLine)return!1;for(var c=d=!1;this.currentLine<=this.endLine;){var f=a.getDisplayLine(this.currentLine);$.log("Checking line %s",
f);if(f=this.regex.exec(f)){$.log("Matched %s",f[0]);b.setSelectionAnchor(this.currentLine,f.index);b.selectTo(this.currentLine,f.index+f[0].length);this.lineOffset=f.index;c=!0;break}else this.lineOffset=0,this.currentLine++;this.currentLine>this.endLine&&!d&&($.log("loop %i",this.startColumn),this.currentLine=this.startLine,0<this.startColumn&&(this.lineOffset=this.startColumn,this.regex.lastIndex=this.lineOffset),d=!0)}return c}};return Constr}();eXide.namespace("eXide.util.Help");
eXide.util.Help=function(){var b=null,a=-1;$(document).ready(function(){$(document.body).append('<div id="eXide-dialog-help">\t<div class="help" id="eXide-dialog-help-body"></div></div>');helpDialog=$("#eXide-dialog-help");helpDialog.dialog({modal:!1,title:"Quick Start",autoOpen:!1,width:600,height:400,buttons:{OK:function(){$(this).dialog("close")},Next:function(){eXide.util.Help.next()},Previous:function(){eXide.util.Help.previous()}}});eXide.util.Help.showFirstTime()});return{show:function(){helpDialog.dialog("open");
b?eXide.util.Help.next():eXide.util.Help.load()},next:function(){a+1<b.length&&(a++,$("#eXide-dialog-help-body").html(b[a]))},previous:function(){0<a&&(a--,$("#eXide-dialog-help-body").html(b[a]))},showFirstTime:function(){if(eXide.util.supportsHtml5Storage){var a=localStorage.getItem("eXide.hints");(!a||1==a)&&eXide.util.Help.show()}},load:function(){$.ajax({url:"help.html",type:"GET",success:function(a){b=$("section",a);eXide.util.Help.show()},error:function(a){404==a.status?eXide.util.error("Failed to open help texts."):
eXide.util.Dialog.warning("Deployment Error","<p>An error has been reported by the database:</p><p>"+a.responseText+"</p>");helpDialog.dialog("close")}})}}}();eXide.namespace("eXide.util.Preferences");
eXide.util.Preferences=function(){var b={theme:"tomorrow",fontSize:14,showInvisibles:!1,showPrintMargin:!0,showHScroll:!1,softWrap:-1};Constr=function(a){this.editor=a;this.preferences=$.extend({},b);var e=this,d=$("#preferences-dialog");$("select, input",d).change(function(){e.updatePreferences()});$("#preferences-dialog").dialog({title:"Preferences",modal:!0,autoOpen:!1,height:400,width:600,buttons:{Close:function(){$(this).dialog("close");a.focus()},"Reset Defaults":function(){e.preferences=$.extend({},
b);e.updateForm()}}})};Constr.prototype.show=function(){this.updateForm();$("#preferences-dialog").dialog("open")};Constr.prototype.updateForm=function(){$.log("Updating form");var a=$("#preferences-dialog form");$('select[name="theme"]',a).val(this.preferences.theme);$('select[name="font-size"]',a).val(this.preferences.fontSize);$('input[name="show-invisibles"]',a).attr("checked",this.preferences.showInvisibles);$('input[name="print-margin"]',a).attr("checked",this.preferences.showPrintMargin);var b=
this.preferences.softWrap;0===b?b="off":-1===b&&(b="free");$('input[name="soft-wrap"]',a).val(b)};Constr.prototype.updatePreferences=function(){var a=$("#preferences-dialog form");this.preferences.theme=$('select[name="theme"]',a).val();this.preferences.fontSize=parseInt($('select[name="font-size"]',a).val());this.preferences.showInvisibles=$('input[name="show-invisibles"]',a).is(":checked");this.preferences.showPrintMargin=$('input[name="print-margin"]',a).is(":checked");a=$('select[name="soft-wrap"]',
a).val();"free"===a?a=-1:"off"===a&&(a=0);this.preferences.softWrap=parseInt(a,10);this.applyPreferences()};Constr.prototype.applyPreferences=function(){$.log("Applying preferences: %o",this.preferences);var a=this;this.editor.setTheme(this.preferences.theme);this.editor.editor.setShowInvisibles(this.preferences.showInvisibles);this.editor.editor.setShowPrintMargin(this.preferences.showPrintMargin);this.editor.forEachDocument(function(b){0<a.preferences.softWrap?b.getSession().setWrapLimitRange(a.preferences.softWrap,
a.preferences.softWrap):0>a.preferences.softWrap&&b.getSession().setWrapLimitRange(null,null);b.getSession().setUseWrapMode(0!=a.preferences.softWrap)});this.editor.editor.setFontSize(this.preferences.fontSize);this.editor.resize()};Constr.prototype.get=function(a){return this.preferences[a]};Constr.prototype.read=function(){localStorage["eXide.preferences"]&&(this.preferences=JSON.parse(localStorage.getItem("eXide.preferences")));this.applyPreferences()};Constr.prototype.save=function(){localStorage.setItem("eXide.preferences",
JSON.stringify(this.preferences));localStorage.setItem("eXide.hints",0)};return Constr}();eXide.namespace("eXide.browse.CollectionBrowser");
eXide.browse.CollectionBrowser=function(){Constr=function(b){var a=this;this.events={activate:[]};this.selected=null;var e=document.createElement("div");e.className="eXide-browse-collections eXide-browse-content";b.append(e);this.container=$(e);this.container.dynatree({persist:!1,rootVisible:!1,initAjax:{url:"modules/collections.xql"},clickFolderMode:1,autoFocus:!0,keyboard:!1,onActivate:function(b){var c=b.data.key;$.log("activate %s: is writable: %s",c,b.data.writable);a.selected=c;a.$triggerEvent("activate",
[c,b.data.writable])},onPostInit:function(b){$.log("Reloading: %s",b);a.select(a.selected)}})};eXide.util.oop.inherit(Constr,eXide.events.Sender);Constr.prototype.getSelection=function(){return this.selected};Constr.prototype.getSelected=function(){return{isCollection:!1,name:this.selected}};Constr.prototype.select=function(b){var a=this.container.dynatree("getTree"),e=null;b&&(e=a.getNodeByKey(b),null==e&&(b=b.substring(0,b.lastIndexOf("/")),$.log("Activating parent collection %s",b),e=a.getNodeByKey(b)));
null==e&&(b="/db",e=a.getNodeByKey(b));null!=e&&(this.selected=b);e.activate();e.expand(!0)};Constr.prototype.reload=function(){$.log("Reloading tree...");this.container.dynatree("getTree").reload()};Constr.prototype.createCollection=function(){var b=this;eXide.app.$checkLogin()&&eXide.util.Dialog.input("Create Collection",'<label for="collection">Name: </label><input type="text" name="collection" id="eXide-browse-collection-name"/>',function(){$.getJSON("modules/collections.xql",{create:$("#eXide-browse-collection-name").val(),
collection:b.selected},function(a){"fail"==a.status?eXide.util.Dialog.warning("Create Collection Error",a.message):b.reload()})})};Constr.prototype.deleteCollection=function(){var b=this;eXide.util.Dialog.input("Confirm Deletion","Are you sure you want to delete collection "+b.selected+"?",function(){$.getJSON("modules/collections.xql",{remove:b.selected},function(a){"fail"==a.status?eXide.util.Dialog.warning("Delete Collection Error",a.message):b.reload()})})};return Constr}();eXide.namespace("eXide.browse.ResourceBrowser");
eXide.browse.ResourceBrowser=function(){var b=[{id:"name",name:"Name",field:"name",width:120,formatter:function(a,c,b,e,h){return h.isCollection?'<span class="collection"><img src="resources/images/folder_add.png"/> '+b+"</span>":b},editor:Slick.Editors.Text},{id:"permissions",name:"Permissions",field:"permissions",width:80},{id:"owner",name:"Owner",field:"owner",width:70},{id:"group",name:"Group",field:"group",width:70},{id:"lastMod",name:"Last Modified",field:"last-modified",width:115}],a={editable:!1,
multiSelect:!1},e={editable:!0,autoEdit:!0,multiSelect:!0,enableCellNavigation:!0};Constr=function(a){var c=this;this.container=$(a);this.clipboard=[];this.clipboardMode="copy";this.events={activate:[],activateCollection:[],activateParent:[]};this.mode="save";this.inEditor=!1;this.collection=null;this.data=[];this.grid=new Slick.Grid(this.container,this.data,b,e);var f=new Slick.RowSelectionModel;this.grid.setSelectionModel(f);f.onSelectedRangesChanged.subscribe(function(){var a=f.getSelectedRows();
if(0!=c.data.length){for(var b=!0,d=0;d<a.length;d++)if(a[d]<c.data.length&&c.data[a[d]]&&!c.data[a[d]].writable){b=!1;break}c.$triggerEvent("activate",[1==a.length&&c.data[a[0]]&&!c.data[a[0]].isCollection?c.data[a[0]]:null,b])}});this.grid.onDblClick.subscribe(function(a){a=c.grid.getCellFromEvent(a);c.data[a.row].isCollection&&(a=".."==c.data[a.row].name?c.collection.replace(/\/[^\/]+$/,""):c.collection+"/"+c.data[a.row].name,c.$triggerEvent("activateCollection",[a]))});this.grid.onKeyDown.subscribe(function(a){if(!c.inEditor&&
!a.shiftKey&&!a.altKey&&!a.ctrlKey)if(13==a.which)a.stopPropagation(),a.preventDefault(),a=f.getSelectedRows(),1==a.length&&(c.data[a[0]].isCollection?(a=".."==c.data[a[0]].name?c.collection.replace(/\/[^\/]+$/,""):c.collection+"/"+c.data[a[0]].name,c.$triggerEvent("activateCollection",[a])):eXide.app.openSelectedDocument());else if(8==a.which){var b=c.collection.lastIndexOf("/");0<b&&(a.stopPropagation(),a.preventDefault(),"/db"!=c.collection&&(a=c.collection.substring(0,b),c.$triggerEvent("activateCollection",
[a])))}});this.grid.onBeforeEditCell.subscribe(function(a,b){c.inEditor=!0;c.oldValue=c.data[b.row].name});this.grid.onBeforeCellEditorDestroy.subscribe(function(){c.inEditor=!1});this.grid.onCellChange.subscribe(function(a,b){c.oldValue&&$.getJSON("modules/collections.xql",{target:c.data[b.row].name,rename:c.oldValue,root:c.collection},function(a){c.reload();c.data[b.row].isCollection&&c.$triggerEvent("activateCollection",[c.data[b.row].name]);"fail"==a.status&&eXide.util.Dialog.warning("Rename Error",
a.message)})});this.grid.onViewportChanged.subscribe(function(){var a=c.grid.getViewport();c.load(a.top,a.bottom)});$("#resource-properties-dialog").dialog({title:"Resource/collection properties",modal:!0,autoOpen:!1,height:320,width:460,buttons:{Cancel:function(){$(this).dialog("close")},Apply:function(){var a=this,b=c.grid.getSelectionModel().getSelectedRows();if(0!=b.length){for(var d=[],e=0;e<b.length;e++)d.push(c.collection+"/"+c.data[b[e]].name);b=$("form",a).serialize();b=b+"&"+$.param({"modify[]":d});
$.getJSON("modules/collections.xql",b,function(){$(a).dialog("close");c.reload()})}}}})};eXide.util.oop.inherit(Constr,eXide.events.Sender);Constr.prototype.setMode=function(b){this.mode=b;"manage"==b?this.grid.setOptions(e):this.grid.setOptions(a)};Constr.prototype.resize=function(){this.grid.resizeCanvas();this.grid.focus()};Constr.prototype.update=function(a,c){if(c||a!==this.collection)$.log("Opening resources for %s",a),this.collection=a,this.grid.invalidate(),this.data.length=0,this.grid.setActiveCell(0,
1),this.grid.setSelectedRows([]),this.grid.onViewportChanged.notify(),this.grid.focus()};Constr.prototype.load=function(a,c){var b=this;$.getJSON("modules/collections.xql",{root:this.collection,view:"r",start:a,end:c},function(e){for(var h=a;h<=c;h++)b.grid.invalidateRow(h);if(e&&e.items){b.data.length=e.total;for(h=0;h<e.items.length;h++)b.data[a+h]=e.items[h]}else b.data.length=0;b.grid.updateRowCount();b.grid.render();0==a&&(b.grid.setActiveCell(0,1),b.grid.focus())})};Constr.prototype.hasSelection=
function(){var a=this.grid.getSelectionModel().getSelectedRows();return a&&0<a.length};Constr.prototype.getSelected=function(){var a=this.grid.getSelectionModel().getSelectedRows();if(0==a.length)return null;for(var b=[],e=0;e<a.length;e++)b.push(this.collection+"/"+this.data[a[e]].name);return b};Constr.prototype.deleteResource=function(){var a=this.grid.getSelectionModel().getSelectedRows();if(0!=a.length){for(var b=[],e=0;e<a.length;e++)b.push(this.data[a[e]].name);var g=this;eXide.util.Dialog.input("Confirm Deletion",
"Are you sure you want to delete the selected resources?",function(){$.log("Deleting resources %o",b);$.getJSON("modules/collections.xql",{remove:b,root:g.collection},function(a){g.reload();"fail"==a.status&&eXide.util.Dialog.warning("Delete Resource Error",a.message)})})}};Constr.prototype.properties=function(){var a=this.grid.getSelectionModel().getSelectedRows();if(0!=a.length){for(var b=[],e=0;e<a.length;e++)b.push(this.collection+"/"+this.data[a[e]].name);$("#resource-properties-content").load("modules/collections.xql",
{properties:b});$("#resource-properties-dialog").dialog("open")}};Constr.prototype.cut=function(){this.clipboardMode="move";this.copy()};Constr.prototype.copy=function(){var a=this.grid.getSelectionModel().getSelectedRows();this.clipboard=[];for(var b=0;b<a.length;b++){var e=this.data[a[b]].name;"/"!=e.substr(0,1)&&(e=this.collection+"/"+e);this.clipboard.push(e)}$.log("Clipboard: %o",this.clipboard)};Constr.prototype.paste=function(){var a=this;$.log("Copying resources %o to %s",this.clipboard,this.collection);
var b={root:this.collection};b[this.clipboardMode]=this.clipboard;$.getJSON("modules/collections.xql",b,function(b){$.log(b.status);"fail"==b.status?eXide.util.Dialog.warning("Delete Resource Error",b.message):a.reload()})};Constr.prototype.focus=function(){this.container.find(".grid-canvas").focus()};Constr.prototype.reload=function(){this.update(this.collection,!0)};return Constr}();eXide.namespace("eXide.browse.Upload");
eXide.browse.Upload=function(){Constr=function(b){this.container=b;this.events={done:[]};$("#file_upload").fileUploadUI({sequentialUploads:!0,uploadTable:$("#files"),buildUploadRow:function(a,b){return $("<tr><td>"+a[b].name+'</td><td class="file_upload_progress"><div></div></td><td class="file_upload_cancel"><button class="ui-state-default ui-corner-all" title="Cancel"><span class="ui-icon ui-icon-cancel">Cancel</span></button></td></tr>')},buildDownloadRow:function(a){return a.error?$("<tr><td>"+
a.name+"</td><td>"+a.error+"</td></tr>"):null}});var a=this;$("#eXide-browse-upload-done").button().click(function(){$("#files").empty();a.$triggerEvent("done",[])})};eXide.util.oop.inherit(Constr,eXide.events.Sender);Constr.prototype.update=function(b){$('input[name="collection"]',this.container).val(b)};return Constr}();eXide.namespace("eXide.browse.Browser");
eXide.browse.Browser=function(){function b(a,b,d,c,f){var g=document.createElement("button");g.title=b;g.id="eXide-browse-toolbar-"+d;g.tabindex=c;b=document.createElement("img");b.src="resources/images/"+f;g.appendChild(b);a.append(g);return g}Constr=function(a){var e=this;this.mode="open";var d=$(".eXide-browse-toolbar",a),c=b(d,"Reload","reload",1,"arrow_refresh.png");$(c).click(function(){e.resources.reload(!0);e.collections.reload()});this.btnCreateCollection=b(d,"Create Collection","create",
3,"folder_add.png");$(this.btnCreateCollection).click(function(a){a.preventDefault();e.collections.createCollection()});this.btnUpload=b(d,"Upload Files","upload",4,"database_add.png");$(this.btnUpload).click(function(b){b.preventDefault();$(".eXide-browse-resources",a).hide();$(".eXide-browse-upload",a).show()});this.btnDeleteResource=b(d,"Delete","delete-resource",5,"bin.png");$(this.btnDeleteResource).click(function(a){a.preventDefault();e.deleteSelected()});this.btnProperties=b(d,"Properties",
"properties",10,"application_form_edit.png");$(this.btnProperties).click(function(a){a.preventDefault();e.resources.properties()});c=b(d,"Open Selected","open",6,"page_edit.png");$(c).click(function(a){a.preventDefault();eXide.app.openSelectedDocument(!1)});this.btnCopy=b(d,"Copy","copy",7,"page_copy.png");this.btnCut=b(d,"Cut","cut",8,"cut.png");this.btnPaste=b(d,"Paste","paste",9,"page_paste.png");this.selection=$(".eXide-browse-form input",a);this.container=a;this.resources=new eXide.browse.ResourceBrowser($(".eXide-browse-resources",
a));this.collections=new eXide.browse.CollectionBrowser($(".eXide-browse-collections",a));this.upload=new eXide.browse.Upload($(".eXide-browse-upload",a).hide());this.layout=null;this.collections.addEventListener("activate",this,this.onActivateCollection);this.collections.addEventListener("activate",this.resources,this.resources.update);this.collections.addEventListener("activate",this.upload,this.upload.update);this.resources.addEventListener("activate",this,this.onActivateResource);this.resources.addEventListener("activateCollection",
this,this.onChangeCollection);this.upload.addEventListener("done",this,function(){$(".eXide-browse-resources",a).show();$(".eXide-browse-upload",a).hide();this.reload()});$(this.btnCopy).click(function(a){a.preventDefault();e.resources.copy()});$(this.btnCut).click(function(a){a.preventDefault();e.resources.cut()});$(this.btnPaste).click(function(a){a.preventDefault();e.resources.paste()})};Constr.prototype={init:function(){var a=$(this.container).innerHeight()-$(".eXide-browse-form",this.container).height()-
25;$(".eXide-browse-panel",this.container).height(a);null==this.layout&&(this.layout=$(".eXide-browse-panel",this.container).layout({enableCursorHotkey:!1,north__resizable:!1,north__closable:!1,north__spacing_open:0,south__resizable:!1,west__size:200,west__initClosed:!1,west__contentSelector:".eXide-browse-content",center__minSize:300,center__contentSelector:".eXide-browse-content",onresize:function(){this.resources.resize()}}),this.resources.resize())},reload:function(a,b){if(a){$(".eXide-browse-toolbar button",
this.container).hide();for(var d=0;d<a.length;d++)$("#eXide-browse-toolbar-"+a[d]).show()}b&&(this.mode=b);this.resources.setMode(b);"save"===this.mode?$(".eXide-browse-form",this.container).show().focus():$(".eXide-browse-form",this.container).hide();null!=this.layout&&(this.resize(),this.collections.reload(),this.resources.update(this.collections.getSelection(),!0),$(this.selection).val(""))},resize:function(){var a=$(this.container).innerHeight()-$(".eXide-browse-form",this.container).height()-
25;$(".eXide-browse-panel",this.container).height(a);this.layout.resizeAll()},deleteSelected:function(){var a=this.resources.getSelected();if(null==a){var a=this.collections.getSelected(),b=this;eXide.util.Dialog.input("Confirm Deletion","Are you sure you want to delete the selected collections?",function(){$.log("Deleting collection %o",a);$.getJSON("modules/collections.xql",{remove:[a.name]},function(a){b.reload();"fail"==a.status&&eXide.util.Dialog.warning("Delete Collection Error",a.message)})})}else this.resources.deleteResource()},
getSelection:function(){var a=$(this.selection).val();return null==a||""==a?null:{name:a,path:this.collections.getSelection()+"/"+a,writable:!0}},onActivateResource:function(a,b){a?$(this.selection).val(a.name):$(this.selection).val("");"open"!=this.mode&&b?($(this.btnDeleteResource).css("display",""),$(this.btnProperties).css("display","")):($(this.btnDeleteResource).css("display","none"),$(this.btnProperties).css("display","none"))},onActivateCollection:function(a,b){"open"!=this.mode&&b?($(this.btnCreateCollection).css("display",
""),$(this.btnUpload).css("display",""),$(this.btnDeleteResource).css("display",""),$(this.btnCut).css("display",""),$(this.btnPaste).css("display",""),$(this.btnProperties).css("display","")):($(this.btnCreateCollection).css("display","none"),$(this.btnUpload).css("display","none"),$(this.btnDeleteResource).css("display","none"),$(this.btnCut).css("display","none"),$(this.btnPaste).css("display","none"),$(this.btnProperties).css("display","none"));this.resources.update(a,b);this.upload.update(a,
b)},onChangeCollection:function(a){this.collections.select(a);this.collections.reload();this.resources.update(this.collections.getSelection())},onChange:function(){$.log("Reloading db manager views");this.collections.reload()}};return Constr}();eXide.namespace("eXide.find.IncrementalSearch");
eXide.find.IncrementalSearch=function(){var b={backwards:!1,wrap:!0,caseSensitive:!1,wholeWord:!1,regExp:!1};Constr=function(a,b){var d=this;d.input=$(a);d.input.hide();d.input.keydown(function(a){switch(a.which){case 27:case 13:a.preventDefault();d.input.hide();d.editor.focus();break;case 40:a.preventDefault();d.editor.findNext();break;case 38:a.preventDefault();d.editor.findPrevious();break;default:d.onChange()}});d.editor=b};Constr.prototype.start=function(){this.currentLine=this.editor.getSession().getSelection().getSelectionLead().row;
this.input.val("");this.input.show().focus()};Constr.prototype.onChange=function(){this.editor.gotoLine(this.currentLine);var a=this.input.val();this.editor.find(a,b,!0)};return Constr}();eXide.namespace("eXide.find.SearchReplace");
eXide.find.SearchReplace=function(){Constr=function(b){var a=this;a.editor=b;a.needleSet=!1;a.container=$("#find-replace-dialog");a.container.dialog({modal:!1,autoOpen:!1,height:300,width:600,buttons:{Close:function(){$(this).dialog("close");a.editor.focus()},Replace:function(){a.replace(!1)},"Replace All":function(){a.replace(!0)},"Find Next":function(){a.find(1)},"Find Previous":function(){a.find(-1)}}})};Constr.prototype.open=function(){this.container.dialog("open")};Constr.prototype.find=function(b){var a=
this.container.find("input[name='search']").val();a&&0<a.length&&(this.needleSet?-1==b?this.editor.findPrevious():this.editor.findNext():(this.editor.find(a,this.getOptions(),!0),this.needleSet=!0),this.editor.focus())};Constr.prototype.replace=function(b){var a=this.container.find("input[name='search']").val();if(a&&0<a.length&&(this.needleSet||(this.editor.find(a,this.getOptions(),!0),this.needleSet=!0),(a=this.container.find("input[name='replace']").val())&&0<a.length))b?this.editor.replaceAll(a):
(this.editor.replace(a),this.editor.findNext())};Constr.prototype.getOptions=function(){var b=this.container.find("input[name='case']").is(":checked"),a=this.container.find("input[name = 'regex']").is(":checked");return{wrap:!0,caseSensitive:b,regExp:a}};return Constr}();eXide.namespace("eXide.find.Modules");
eXide.find.Modules=function(){var b={open:[],"import":[]},a=[{id:"prefix",name:"Prefix",field:"prefix",sortable:!0,resizable:!0,maxWidth:100,minWidth:60},{id:"uri",name:"URI",field:"uri",sortable:!0,resizable:!0,minWidth:100},{id:"at",name:"Location",field:"at",sortable:!0,resizable:!0}],e={editable:!1,multiSelect:!1,forceFitColumns:!0},d=[],c;$(document).ready(function(){$("#select-module-dialog").dialog({modal:!1,autoOpen:!1,height:400,width:600,open:eXide.find.Modules.$init});c=new Slick.Grid("#module-list",
d,a,e);var b=new Slick.RowSelectionModel({selectActiveRow:!0});c.setSelectionModel(b);c.onDblClick.subscribe(function(a){a=c.getCellFromEvent(a);eXide.find.Modules.$triggerEvent("open",[d[a.row]])});c.onSort.subscribe(function(a,b){$.log("sorting on field: %s",b.sortCol.field);d.sort(function(a,c){var d=b.sortCol.field,e=a[d],d=c[d],e=(e==d?0:e>d?1:-1)*(b.sortAsc?1:-1);return 0!=e?e:0});c.invalidate();c.render()})});return{select:function(a){var b={Open:function(){eXide.find.Modules.trigger("open");
$(this).dialog("close")},Cancel:function(){$(this).dialog("close")}};"xquery"==a&&(b.Import=function(){eXide.find.Modules.trigger("import");$(this).dialog("close")});$("#select-module-dialog").dialog("option","buttons",b);$("#select-module-dialog").dialog("open")},trigger:function(a){var b=c.getSelectionModel().getSelectedRows();1==b.length&&eXide.find.Modules.$triggerEvent(a,[d[b[0]]])},$init:function(){c.resizeCanvas();c.invalidate();d.length=0;$.getJSON("modules/find.xql",function(a){d.length=
a.length;for(var b=0;b<a.length;b++)d[b]=a[b];c.updateRowCount();c.render();c.setActiveCell(0,0);c.setSelectedRows([0]);$("#module-list").find(".grid-canvas").focus()})},addEventListener:function(a,c,d){(a=b[a])&&a.push({obj:c,callback:d})},$triggerEvent:function(a,c){var d=b[a];if(d)for(var e=0;e<d.length;e++)d[e].callback.apply(d[e].obj,c)}}}();eXide.namespace("eXide.util.Menubar");
eXide.util.Menubar=function(){Constr=function(b){var a=this;this.container=b;var e=!1;$("ul li",this.container).click(function(a){a.stopPropagation();$("ul",this).css({display:"block"});e=!0});$("body").click(function(){e&&$("ul li ul",a.container).css({display:"none"})})};Constr.prototype.click=function(b,a,e){var d=this;if(e){var c=eXide.edit.commands.getShortcut(e);c&&(c=c.replace(/Command/g,String.fromCharCode(8984)),c=c.replace(/Shift/g,String.fromCharCode(8679)),c=c.replace(/Option/g,String.fromCharCode(8997)),
c=c.replace(/Control/g,"^"),$(b).each(function(){var a=document.createElement("span");a.className="shortcut";a.appendChild(document.createTextNode(c));this.appendChild(a)}))}$(b).click(function(b){b.preventDefault();$("ul li ul",d.container).css({display:"none"});a()})};Constr.prototype.add=function(b,a,e,d){var c=this,b=$(this.container).find('ul li[title="'+b+'"]'),b=b.find("ul");b.append($('<li><a href="#" title="'+e+'">'+a+"</a></li>"));b.find("li:last-child a").click(function(a){a.preventDefault();
d();$("ul li ul",c.container).css({display:"none"})})};Constr.prototype.remove=function(b,a){$.log("Removing menu entry %s",a);b=$(this.container).find('ul li[title="'+b+'"]');b.find('ul li a[title = "'+a+'"]').remove()};return Constr}();